<!DOCTYPE html>
<html lang="en">
<head>
  <!-- DRIXEL FAVICON -->
  <link rel="icon" type="image/png" href="drixel-favicon.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drixel SA | Premium South African Streetwear</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    
    
<style>
        /* ===== NIKE-INSPIRED THEME ===== */

        /* ===== PAYMENT METHOD UI (aligned & clean) ===== */
        .payment-methods-grid{
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .payment-method-card{
            display:flex;
            align-items:center;
            gap:12px;
            padding:14px 14px;
            border:1px solid rgba(255,255,255,0.12);
            border-radius:14px;
            background: rgba(255,255,255,0.06);
            cursor:pointer;
            transition: transform .12s ease, border-color .12s ease, background .12s ease;
            user-select:none;
        }
        .payment-method-card:hover{
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.09);
        }
        .payment-method-card input[type="radio"]{
            width:18px;
            height:18px;
        }
        .payment-method-card .pm-icon{
            width:40px;height:40px;display:flex;align-items:center;justify-content:center;
            border-radius:12px;background: rgba(0,0,0,0.25);
        }
        .payment-method-card .pm-text{
            display:flex;flex-direction:column;line-height:1.2;
        }
.payment-method-card .pm-sub{
            font-size: 12px;
            opacity: 0.85;
            margin-top: 4px;
        }
        .payment-method-card .pm-text strong{font-size:14px;}
        .payment-method-card .pm-text span{font-size:12px;opacity:.85;margin-top:4px;}

        :root {
            --nike-black: #111111;
            --nike-white: #FFFFFF;
            --nike-grey: #F5F5F5;
            --nike-dark-grey: #2D2D2D;
            --accent-orange: #FF6B00;
            --accent-lime: #A9FF5F;
            --accent-blue: #0066CC;
            --accent-red: #FF1E00;
            --success-green: #0CAF60;
            --warning: #FFD166;
            --danger: #EF476F;
            --snapscan-blue: #0096FF;
            
            --gradient-primary: linear-gradient(135deg, #111111 0%, #2D2D2D 100%);
            --gradient-accent: linear-gradient(135deg, #FF6B00 0%, #FF8E53 100%);
            --gradient-blue: linear-gradient(135deg, #0066CC 0%, #5B86E5 100%);
            --gradient-snapscan: linear-gradient(135deg, #0096FF 0%, #5B86E5 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --border-radius-pill: 50px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--nike-white);
            color: var(--nike-black);
            line-height: 1.7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            color: var(--accent-orange);
            text-decoration: none;
            transition: var(--transition);
        }

        a:hover {
            color: var(--accent-red);
        }

        ul {
            list-style: none;
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            transition: var(--transition);
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        input, textarea, select {
            padding: 14px 18px;
            border: 2px solid #E0E0E0;
            background: var(--nike-white);
            color: var(--nike-black);
            border-radius: var(--border-radius);
            width: 100%;
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .section {
            padding: 100px 0;
        }

        .hidden {
            display: none !important;
        }

        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 52px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 42px;
            color: var(--nike-black);
        }

        h3 {
            font-size: 28px;
            color: var(--nike-black);
        }

        p {
            margin-bottom: 20px;
            color: #666;
            font-size: 17px;
        }

        .text-center {
            text-align: center;
        }

        /* ===== NIKE-STYLE BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 36px;
            background: var(--gradient-primary);
            color: var(--nike-white);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: var(--border-radius-pill);
            transition: var(--transition);
            text-align: center;
            border: none;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            color: var(--nike-white);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::after {
            left: 100%;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--nike-black);
            color: var(--nike-black);
        }

        .btn-outline:hover {
            background: var(--nike-black);
            color: var(--nike-white);
        }

        .btn-secondary {
            background: var(--gradient-blue);
        }

        .btn-accent {
            background: var(--gradient-accent);
        }

        .btn-snapscan {
            background: var(--gradient-snapscan);
        }

        /* ===== YOCO BUY BUTTONS ===== */
        .buy-btn {
            background: var(--gradient-accent);
            color: var(--nike-white);
            padding: 16px 32px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: var(--border-radius-pill);
            margin-top: 15px;
            width: 100%;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: var(--transition);
        }

        .buy-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .buy-btn-container {
            margin-top: 15px;
            text-align: center;
        }

        .buy-btn-container a {
            display: block;
            text-decoration: none;
        }

        /* Admin button styling */
        #adminMobileBtn {
            position: fixed;
            bottom: 130px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: #FF6B00;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.3s;
        }

        #adminMobileBtn:hover {
            transform: scale(1.1);
            background: #FF8E53;
        }

        #adminMobileBtn:active {
            transform: scale(0.95);
        }

        /* ===== NIKE-STYLE NAVBAR ===== */
        .navbar {
            background: var(--nike-white);
            padding: 22px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 30px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--nike-black);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 40px;
            height: 3px;
            background: var(--accent-orange);
        }

        .nav-links {
            display: flex;
            gap: 35px;
        }

        .nav-links a {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
            transition: var(--transition);
            position: relative;
            color: var(--nike-black);
        }

        .nav-links a:hover {
            color: var(--accent-orange);
        }

        .nav-links a.active {
            color: var(--accent-orange);
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-orange);
        }

        .nav-icons {
            display: flex;
            gap: 22px;
            align-items: center;
        }

        .nav-icons i {
            font-size: 22px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--nike-black);
        }

        .nav-icons i:hover {
            color: var(--accent-orange);
            transform: translateY(-2px);
        }

        .cart-count {
            background: var(--accent-orange);
            color: var(--nike-white);
            font-size: 12px;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -10px;
            right: -10px;
            font-weight: 700;
        }

        .cart-btn {
            position: relative;
        }

        .mobile-menu-btn {
            display: block;
            font-size: 26px;
            cursor: pointer;
            color: var(--nike-black);
        }

        

/* ===== GLOBAL HAMBURGER MENU (ALL DEVICES) ===== */
#globalMenuOverlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    z-index: 2000;
}
#globalMenuOverlay.active{
    opacity: 1;
    visibility: visible;
}
#globalMenuPanel{
    position: absolute;
    top: 90px;
    right: 20px;
    width: 340px;
    max-width: calc(100% - 40px);
    background: var(--nike-white);
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 18px 55px rgba(0,0,0,0.20);
    transform: translateY(-10px);
    transition: var(--transition);
}
#globalMenuOverlay.active #globalMenuPanel{
    transform: translateY(0);
}
.global-menu-header{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    margin-bottom: 12px;
}
.global-menu-title{
    font-weight: 800;
    letter-spacing: .5px;
    text-transform: uppercase;
    font-size: 12px;
    opacity: .75;
}
.global-menu-close{
    width: 36px;
    height: 36px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.10);
    background: rgba(0,0,0,0.04);
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: var(--transition);
}
.global-menu-close:hover{
    background: rgba(0,0,0,0.07);
}
.global-menu-links{
    display:flex;
    flex-direction: column;
    gap: 10px;
    padding: 6px 0 10px;
}
.global-menu-links a{
    color: var(--nike-black);
    text-decoration: none;
    font-weight: 700;
    padding: 10px 12px;
    border-radius: 12px;
    transition: var(--transition);
    background: rgba(0,0,0,0.03);
}
.global-menu-links a:hover{
    background: rgba(0,0,0,0.06);
}
.global-collections{
    margin-top: 8px;
}
.global-collections .mobile-collections-title{
    display:block;
    margin: 10px 0 8px;
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .6px;
    opacity: .75;
}
.global-collections .collections-bar{
    justify-content: flex-start;
}
/* Keep mobile nav working as-is on small screens */
@media (max-width: 768px) {
    #globalMenuPanel{ top: 85px; right: 12px; width: 92vw; max-width: 420px; }
}/* ===== FOOTER ===== */
        footer {
            background: var(--gradient-dark);
            color: var(--nike-white);
            padding: 80px 0 40px;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 50px;
            margin-bottom: 50px;
        }

        .footer-column h3 {
            font-size: 20px;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--nike-white);
        }

        .footer-links li {
            margin-bottom: 15px;
        }

        .footer-links a {
            color: #B0B7C3;
            transition: var(--transition);
            font-size: 15px;
        }

        .footer-links a:hover {
            color: var(--accent-orange);
            padding-left: 8px;
        }

        .social-icons {
            display: flex;
            gap: 18px;
            margin-top: 25px;
        }

        .social-icons a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: var(--transition);
            font-size: 20px;
            color: var(--nike-white);
        }

        .social-icons a:hover {
            background: var(--accent-orange);
            color: var(--nike-white);
            transform: translateY(-5px) rotate(10deg);
        }

        .copyright {
            text-align: center;
            padding-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #B0B7C3;
            font-size: 15px;
        }

        /* ===== HERO SECTION ===== */
        .hero {
            background: linear-gradient(rgba(26, 26, 26, 0.85), rgba(26, 26, 26, 0.85)), url('https://ik.imagekit.io/dpzepxtqs/WhatsApp%20Image%202025-12-28%20at%2019.49.44.jpeg') center center/cover no-repeat;
            padding: 140px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-accent);
            opacity: 0.1;
            z-index: 1;
        }

        .hero .container {
            position: relative;
            z-index: 2;
        }

        .hero h1 {
            font-size: 72px;
            margin-bottom: 30px;
            color: var(--nike-white);
            -webkit-text-fill-color: var(--nike-white);
        }

        .hero p {
            font-size: 22px;
            max-width: 700px;
            margin: 0 auto 50px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* ===== PRODUCT GRID ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 35px;
            margin-top: 50px;
        }

        /* ===== COLLECTIONS BAR (Shop Filters) ===== */
        .collections-bar{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            align-items:center;
            justify-content:center;
            margin-top: 25px;
            margin-bottom: -10px; /* pulls grid a bit up */
        }
        .collection-chip{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            padding: 10px 16px;
            border-radius: 999px;
            border: 2px solid #E0E0E0;
            background: var(--nike-white);
            color: var(--nike-black);
            font-weight: 800;
            letter-spacing: .8px;
            text-transform: uppercase;
            font-size: 12px;
            transition: var(--transition);
            user-select:none;
        }
        .collection-chip:hover{
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            transform: translateY(-1px);
        }
        .collection-chip.active{
            background: var(--nike-black);
            border-color: var(--nike-black);
            color: var(--nike-white);
        }
        .collection-chip.disabled{
            opacity: .55;
            cursor: not-allowed;
        }
        .collection-chip.disabled:hover{
            transform:none;
            border-color:#E0E0E0;
            color: var(--nike-black);
        }
        @media (max-width: 520px){
            .collections-bar{justify-content:flex-start;}
        }


        .product-card {
            background: var(--nike-white);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .product-card:hover {
            transform: translateY(-15px);
            box-shadow: var(--shadow);
        }

        .product-image {
            height: 320px;
            background: var(--nike-grey);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.08);
        }

        .product-info {
            padding: 25px;
        }

        .product-title {
            font-size: 20px;
            margin-bottom: 12px;
            color: var(--nike-black);
            font-weight: 700;
        }

        .product-price {
            font-size: 24px;
            font-weight: 900;
            color: var(--accent-orange);
            margin-bottom: 20px;
        }

        /* ===== SIZE SELECTION ===== */
        .size-selection {
            margin-bottom: 15px;
        }

        .size-selection h4 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .size-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .size-option {
            width: 40px;
            height: 40px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            transition: var(--transition);
            background: var(--nike-white);
            color: var(--nike-black);
        }

        .size-option:hover {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .size-option.selected {
            background: var(--nike-black);
            color: var(--nike-white);
            border-color: var(--nike-black);
        }

        /* ===== COLOR SELECTION ===== */
        .color-selection {
            margin-bottom: 20px;
        }

        .color-selection h4 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .color-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border: 2px solid #E0E0E0;
            border-radius: 50%;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .color-option.selected {
            border-color: var(--nike-black);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .color-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--nike-white);
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }

        .product-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--accent-orange);
            color: var(--nike-white);
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            z-index: 2;
        }

        /* ===== DELIVERY BADGE ===== */
        .delivery-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--success-green);
            color: var(--nike-white);
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            z-index: 2;
        }

        .free-delivery {
            background: linear-gradient(135deg, var(--success-green) 0%, #06D6A0 100%);
        }

        /* ===== SINGLE PRODUCT PAGE ===== */
        .product-backbar{
            display:flex;
            align-items:center;
            justify-content:flex-start;
            margin-bottom: 18px;
        }
        .back-to-products-btn{
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.06);
            color: inherit;
            cursor: pointer;
            font-weight: 600;
            transition: transform .12s ease, background .12s ease, border-color .12s ease;
        }
        .back-to-products-btn:hover{
            transform: translateY(-1px);
            background: rgba(255,255,255,0.09);
            border-color: rgba(255,255,255,0.22);
        }
        .back-to-products-btn:active{
            transform: translateY(0);
        }
        @media (max-width: 640px){
            .product-backbar{ margin-bottom: 12px; }
            .back-to-products-btn{ width: 100%; justify-content:center; }
        }

        .single-product {
            padding: 80px 0;
        }

        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 70px;
            align-items: start;
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .main-image {
            height: 550px;
            background: var(--nike-grey);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: var(--border-radius);
            position: relative;
        }

        .thumbnails {
            display: flex;
            gap: 20px;
        }

        .thumbnail {
            width: 90px;
            height: 90px;
            background: var(--nike-grey);
            border-radius: var(--border-radius);
            cursor: pointer;
            overflow: hidden;
            opacity: 0.7;
            transition: var(--transition);
            border: 3px solid transparent;
        }

        .thumbnail:hover, .thumbnail.active {
            opacity: 1;
            border-color: var(--accent-orange);
            transform: scale(1.05);
        }

        .product-actions {
            display: flex;
            gap: 20px;
            margin-bottom: 35px;
            align-items: center;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            border: 2px solid #E0E0E0;
            border-radius: var(--border-radius);
            width: fit-content;
            overflow: hidden;
        }

        .quantity-btn {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--nike-white);
            color: var(--nike-black);
            font-weight: 600;
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background: var(--nike-grey);
        }

        .quantity-input {
            width: 70px;
            text-align: center;
            border: none;
            background: var(--nike-white);
            font-size: 18px;
            font-weight: 700;
        }

        .product-description {
            margin: 35px 0;
            line-height: 1.9;
            font-size: 18px;
        }

        /* ===== PROCESSING TIMELINE ===== */
        .timeline {
            margin: 40px 0;
            padding: 30px;
            background: rgba(255, 107, 0, 0.05);
            border-radius: var(--border-radius);
            border-left: 5px solid var(--accent-orange);
        }

        .timeline h4 {
            color: var(--accent-orange);
            margin-bottom: 20px;
            font-size: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 107, 0, 0.1);
        }

        .timeline-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .timeline-icon {
            width: 24px;
            height: 24px;
            background: var(--accent-orange);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            margin-top: 2px;
            color: var(--nike-white);
            font-size: 12px;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content strong {
            color: var(--nike-black);
        }

        /* ===== CART PAGE ===== */
        .cart-page {
            padding: 80px 0;
            min-height: 70vh;
        }

        .cart-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 50px;
            align-items: start;
        }

        .cart-items {
            background: var(--nike-white);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .cart-item {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 25px;
            padding: 25px;
            border-bottom: 2px solid #F0F0F0;
            align-items: center;
            transition: var(--transition);
        }

        .cart-item:hover {
            background: rgba(255, 107, 0, 0.02);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 120px;
            height: 120px;
            background: var(--nike-grey);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .cart-item-details h4 {
            margin-bottom: 12px;
            color: var(--nike-black);
        }

        .cart-item-variants {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-item-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }

        .cart-item-price {
            color: var(--accent-orange);
            font-weight: 900;
            font-size: 20px;
        }

        .cart-item-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .cart-item-remove {
            color: var(--danger);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .cart-item-remove:hover {
            text-decoration: underline;
        }

        .cart-summary {
            background: var(--nike-white);
            border-radius: var(--border-radius);
            padding: 35px;
            position: sticky;
            top: 120px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #F0F0F0;
        }

        .summary-total {
            font-size: 28px;
            font-weight: 900;
            color: var(--accent-orange);
        }

        .shipping-note {
            font-size: 14px;
            color: var(--accent-orange);
            margin-top: 8px;
            font-weight: 600;
        }

        /* ===== CHECKOUT PAGE ===== */
        .checkout-page {
            padding: 80px 0;
            min-height: 80vh;
        }

        .checkout-container {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 50px;
        }

        .checkout-form-section {
            margin-bottom: 50px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--nike-black);
        }

        .order-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 2px solid #F0F0F0;
        }

        /* ===== AUTH PAGES ===== */
        .auth-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 50px;
            background: var(--nike-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 40px;
            border-bottom: 2px solid #F0F0F0;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: var(--transition);
            color: #666;
        }

        .auth-tab.active {
            color: var(--accent-orange);
            border-bottom: 3px solid var(--accent-orange);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* ===== SUBSCRIPTION CHECKBOX ===== */
        .subscription-checkbox {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 107, 0, 0.05);
            border-radius: var(--border-radius);
            border: 2px dashed var(--accent-orange);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-top: 3px;
            accent-color: var(--accent-orange);
        }

        .checkbox-group label {
            font-size: 15px;
            line-height: 1.6;
            color: var(--nike-black);
        }

        /* ===== PAGES ===== */
        .page-content {
            padding: 100px 0;
            max-width: 1000px;
            margin: 0 auto;
        }

        .page-content h1 {
            margin-bottom: 50px;
            position: relative;
            padding-bottom: 25px;
        }

        .page-content h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 5px;
            background: var(--accent-orange);
            border-radius: 5px;
        }

        /* ===== YOCO DIRECT BUY PAGE ===== */
        .yoco-direct-page {
            padding: 80px 0;
        }

        .yoco-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
            gap: 35px;
            margin-top: 50px;
        }

        .yoco-product {
            background: var(--nike-white);
            border-radius: var(--border-radius);
            padding: 35px;
            text-align: center;
            transition: var(--transition);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .yoco-product:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow);
        }

        .yoco-product::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--accent-orange);
        }

        .yoco-icon {
            font-size: 56px;
            margin-bottom: 25px;
        }

        .yoco-price {
            font-size: 32px;
            font-weight: 900;
            color: var(--accent-orange);
            margin: 25px 0;
        }

        .yoco-description {
            color: #666;
            margin-bottom: 30px;
            font-size: 15px;
            line-height: 1.7;
        }

        /* ===== EMAIL NOTIFICATION ===== */
        .email-notification {
            background: rgba(255, 107, 0, 0.1);
            border-radius: var(--border-radius);
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid var(--accent-orange);
        }

        .email-notification p {
            margin-bottom: 0;
            font-size: 16px;
        }

        /* ===== COOKIE CONSENT ===== */
        .cookie-consent {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: var(--nike-white);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: none;
        }

        .cookie-consent.active {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .cookie-content {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .cookie-icon {
            font-size: 40px;
            color: var(--accent-orange);
            flex-shrink: 0;
        }

        .cookie-text {
            flex: 1;
        }

        .cookie-text h4 {
            margin-bottom: 10px;
            color: var(--nike-black);
        }

        .cookie-buttons {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }

        /* ===== ADMIN NOTICE ===== */
        .admin-notice {
            background: var(--accent-orange);
            color: var(--nike-white);
            padding: 15px 25px;
            font-size: 15px;
            text-align: center;
            font-weight: 600;
        }

        /* ===== PROCESSING BANNER ===== */
        .processing-banner {
            background: var(--gradient-accent);
            color: var(--nike-white);
            padding: 20px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            h1 {
                font-size: 48px;
            }
            
            h2 {
                font-size: 36px;
            }
            
            .product-detail {
                grid-template-columns: 1fr;
                gap: 50px;
            }
            
            .cart-container, .checkout-container {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .yoco-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .section {
                padding: 80px 0;
            }
            
            .hero {
                padding: 100px 0;
            }
            
            .hero h1 {
                font-size: 56px;
            }
            
            .cookie-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .nav-links {
                position: fixed;
                top: 85px;
                left: 0;
                width: 100%;
                background: var(--nike-white);
                flex-direction: column;
                padding: 25px;
                gap: 20px;
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: var(--transition);
                z-index: 999;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }
            
            .nav-links.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }
            
            .hero h1 {
                font-size: 42px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .yoco-grid {
                grid-template-columns: 1fr;
            }
            
            .cart-item {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 20px;
            }
            
            .cart-item-image {
                margin: 0 auto;
            }
            
            .timeline {
                padding: 25px;
            }

            /* ===== PRODUCT PAGE RESPONSIVE FIX ===== */
            .product-detail {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .main-image {
                height: auto;
                width: 100%;
                max-height: 460px;
                aspect-ratio: 1 / 1;
            }

            .main-image img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .thumbnails {
                gap: 12px;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 6px;
            }

            .thumbnail {
                flex: 0 0 auto;
                width: 72px;
                height: 72px;
            }

        }

        @media (max-width: 576px) {
            .section {
                padding: 60px 0;
            }
            
            .auth-container {
                padding: 30px;
                margin: 60px auto;
            }
            
            .btn {
                padding: 14px 28px;
                font-size: 14px;
            }
            
            .buy-btn {
                padding: 14px 28px;
                font-size: 14px;
            }
            
            .page-content {
                padding: 60px 0;
            }
            
            .cookie-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .cookie-buttons .btn {
                width: 100%;
            }

            /* ===== PRODUCT PAGE (SMALL PHONES) ===== */
            .main-image {
                max-height: 380px;
                aspect-ratio: 4 / 5;
            }
            .thumbnail {
                width: 64px;
                height: 64px;
            }

        }

        /* ===== UTILITIES ===== */
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mt-40 { margin-top: 40px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .mb-40 { margin-bottom: 40px; }
        .text-accent { color: var(--accent-orange); }
        .bg-grey { background: var(--nike-grey); }
        .bg-white { background: var(--nike-white); }

        /* ===== YOCO PAYMENT MODAL STYLES ===== */
        #yocoPaymentModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #yocoPaymentModal.active {
            display: flex;
        }

        #yocoPaymentModal .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .card-input {
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            transition: border-color 0.3s;
            width: 100%;
        }

        .card-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        .card-input.error {
            border-color: var(--danger);
        }

        .payment-error {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .payment-error.active {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== SNAPSCAN STYLES ===== */
        .snapscan-qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .snapscan-info-box {
            background: rgba(0, 150, 255, 0.1);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 2px dashed #0096FF;
        }

        .snapscan-ref-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--snapscan-blue);
        }
        
        /* Copy button feedback */
        .copy-success {
            background-color: #28a745 !important;
            color: white !important;
            animation: pulse 0.5s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ===== ADMIN MODAL STYLES ===== */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-modal.active {
            display: flex;
        }

        .admin-modal-content {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .admin-form-group input,
        .admin-form-group textarea,
        .admin-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    
/* FIX: Proper spacing between collections bar and Curated Collections heading */
.home-collections-bar{
    margin-bottom: 48px !important;
}
.home-collections-bar + h2,
.home-collections-bar + .container h2{
    margin-top: 0 !important;
}


/* ===== DRIXEL FAQ ASSISTANT (AI-READY) ===== */

.drixel-chat-avatar{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.10);
  background: #fff;
  object-fit: contain;
}
.drixel-avatar{
  width: 26px;
  height: 26px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.10);
  background: #fff;
  object-fit: contain;
  margin-top: 2px;
  flex-shrink: 0;
}

#drixelChatFab{
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 58px;
  height: 58px;
  border-radius: 999px;
  background: var(--nike-black);
  color: var(--nike-white);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 14px 38px rgba(0,0,0,0.22);
  z-index: 12000;
  cursor: pointer;
  transition: var(--transition);
}
#drixelChatFab:hover{ transform: translateY(-3px); }
#drixelChatFab i{ font-size: 22px; }

#drixelChatPanel{
  position: fixed;
  right: 18px;
  bottom: 86px;
  width: 360px;
  max-width: calc(100vw - 36px);
  height: 520px;
  max-height: calc(100vh - 140px);
  background: var(--nike-white);
  border-radius: 18px;
  box-shadow: 0 18px 55px rgba(0,0,0,0.25);
  z-index: 12000;
  overflow: hidden;
  display: none;
  border: 1px solid rgba(0,0,0,0.08);
}
#drixelChatPanel.active{ display: flex; flex-direction: column; }

.drixel-chat-header{
  padding: 14px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  border-bottom: 1px solid rgba(0,0,0,0.08);
  background: rgba(0,0,0,0.02);
}
.drixel-chat-header .title{
  display: flex;
  flex-direction: column;
  line-height: 1.15;
}
.drixel-chat-header .title strong{
  font-size: 13px;
  letter-spacing: .6px;
  text-transform: uppercase;
}
.drixel-chat-header .title span{
  font-size: 12px;
  opacity: .75;
}
.drixel-chat-close{
  width: 38px;
  height: 38px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.10);
  background: rgba(0,0,0,0.04);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.drixel-chat-close:hover{ background: rgba(0,0,0,0.07); }

.drixel-chat-body{
  padding: 12px 12px 10px;
  flex: 1;
  overflow-y: auto;
  background: #fff;
}
.drixel-msg{
  display: flex;
  gap: 10px;
  margin: 10px 0;
  align-items: flex-start;
}
.drixel-bubble{
  max-width: 86%;
  padding: 12px 14px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.06);
}
.drixel-msg.user{ justify-content: flex-end; }
.drixel-msg.user .drixel-bubble{
  background: var(--nike-black);
  color: var(--nike-white);
  border-color: rgba(0,0,0,0.20);
}
.drixel-msg.bot .drixel-bubble{
  background: rgba(0,0,0,0.03);
  color: var(--nike-black);
}
.drixel-small{
  font-size: 12px;
  opacity: .75;
  margin-top: 8px;
}

.drixel-quick{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px 12px 0;
}
.drixel-chip{
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.12);
  background: rgba(0,0,0,0.03);
  font-weight: 800;
  letter-spacing: .4px;
  text-transform: uppercase;
  font-size: 11px;
}
.drixel-chip:hover{ background: rgba(0,0,0,0.06); }

.drixel-chat-footer{
  padding: 10px 10px 12px;
  border-top: 1px solid rgba(0,0,0,0.08);
  background: rgba(0,0,0,0.02);
}
.drixel-chat-inputwrap{
  display: flex;
  gap: 8px;
}
#drixelChatInput{
  flex: 1;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,0.14);
  font-size: 14px;
}
#drixelChatSend{
  min-width: 46px;
  height: 46px;
  border-radius: 14px;
  background: var(--nike-black);
  color: var(--nike-white);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
#drixelChatSend:hover{ transform: translateY(-1px); }

@media (max-width: 480px){
  #drixelChatPanel{ width: calc(100vw - 24px); right: 12px; bottom: 82px; }
  #drixelChatFab{ right: 12px; bottom: 14px; }
}


/* FIX: Align assistant logo + make FAQ chips always clickable */
.drixel-chat-header .title{
  align-items: center !important;
}
.drixel-chat-avatar{
  display:block;
  margin: 0;
}
.drixel-chat-header .title strong,
.drixel-chat-header .title span{
  margin: 0;
}
.drixel-quick, .drixel-chip{
  pointer-events: auto;
}
.drixel-chip{
  cursor: pointer;
}


/* FIX: Ensure send button is clickable */
#drixelChatSend{
  pointer-events: auto;
  cursor: pointer;
}


/* ===== DRIXEL ASSISTANT: Typing Indicator ===== */
.drixel-typing{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.drixel-typing-dot{
  width:7px;
  height:7px;
  border-radius:999px;
  background: rgba(0,0,0,0.45);
  animation: drixelTyping 1.1s infinite ease-in-out;
}
.drixel-typing-dot:nth-child(2){ animation-delay: .15s; }
.drixel-typing-dot:nth-child(3){ animation-delay: .30s; }
@keyframes drixelTyping{
  0%, 80%, 100% { transform: translateY(0); opacity: .45; }
  40% { transform: translateY(-4px); opacity: 1; }
}


        /* ===== MOBILE PRODUCTS GRID FIX ===== */
        @media (max-width: 520px){
            .products-grid{ grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 16px; margin-top: 26px; }
            .product-card{ border-radius: 16px; }
            .product-info h3{ font-size: 15px; }
            .product-price{ font-size: 14px; }
            .section{ padding-left: 12px; padding-right: 12px; }
        }
    

        /* ===== MOBILE: ensure full vertical scroll for products (show ALL products) ===== */
        html, body { overflow-y: auto !important; height: auto !important; }
        @media (max-width: 768px) {
            /* Some browsers/pages can end up locking scroll â€” force it back */
            body { overflow-y: auto !important; -webkit-overflow-scrolling: touch; }
            #shopPage, #homePage, #productPage, #cartPage, #checkoutPage, #authPage { 
                position: relative !important;
                height: auto !important;
                min-height: 100vh;
                overflow: visible !important;
            }
            /* Ensure the products grid is not constrained by any parent height */
            #allProducts { 
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }
        }

</style>

  <!-- Faster payment start (preconnect) -->
  <link rel="preconnect" href="https://drixel-payments-server.onrender.com" crossorigin>
  <link rel="dns-prefetch" href="https://drixel-payments-server.onrender.com">
  <link rel="preconnect" href="https://payments.yoco.com" crossorigin>
  <link rel="dns-prefetch" href="https://payments.yoco.com">

</head>
<body>
    <!-- Cookie Consent Modal -->
    <div class="cookie-consent" id="cookieConsent">
        <div class="cookie-content">
            <div class="cookie-icon">
                <i class="fas fa-cookie-bite"></i>
            </div>
            <div class="cookie-text">
                <h4>Cookie Preferences</h4>
                <p>We use cookies to enhance your browsing experience, analyze site traffic, and personalize content. By clicking "Accept All", you consent to our use of cookies. You can manage your preferences at any time.</p>
            </div>
            <div class="cookie-buttons">
                <button class="btn btn-outline" onclick="declineCookies()">Decline</button>
                <button class="btn" onclick="acceptCookies()">Accept All</button>
            </div>
        </div>
    </div>

    <!-- Yoco Payment Modal -->
    <div id="yocoPaymentModal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #111111;">Complete Your Payment</h2>
                <p style="color: #666; margin-top: 10px;">Enter your card details to complete your purchase</p>
            </div>
            
            <div id="yocoPaymentForm" style="margin-bottom: 30px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #111111;">Card Number</label>
                    <input type="text" id="cardNumber" class="card-input" placeholder="4242 4242 4242 4242" maxlength="19">
                    <div class="payment-error" id="cardNumberError">Please enter a valid card number</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #111111;">Expiry Date</label>
                        <input type="text" id="expiryDate" class="card-input" placeholder="MM/YY" maxlength="5">
                        <div class="payment-error" id="expiryDateError">Please enter a valid expiry date (MM/YY)</div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #111111;">CVC</label>
                        <input type="text" id="cvc" class="card-input" placeholder="123" maxlength="4">
                        <div class="payment-error" id="cvcError">Please enter a valid CVC</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #111111;">Cardholder Name</label>
                    <input type="text" id="cardholderName" class="card-input" placeholder="John Doe">
                    <div class="payment-error" id="cardholderNameError">Please enter cardholder name</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #111111;">Email for Receipt</label>
                    <input type="email" id="receiptEmail" class="card-input" placeholder="your@email.com">
                    <div class="payment-error" id="receiptEmailError">Please enter a valid email address</div>
                </div>
            </div>
            
            <div id="yocoPaymentErrors" style="color: #EF476F; font-size: 14px; margin-bottom: 20px; display: none;"></div>
            
            <div style="display: flex; gap: 15px;">
                <button onclick="closeYocoPaymentModal()" style="flex: 1; padding: 16px; background: #f0f0f0; color: #111111; border: none; border-radius: 50px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="processYocoPayment()" id="processPaymentBtn" style="flex: 2; padding: 16px; background: linear-gradient(135deg, #FF6B00 0%, #FF8E53 100%); color: white; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span>Pay R </span><span id="paymentAmount">0.00</span>
                </button>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                <i class="fas fa-lock"></i> Secure payment powered by Yoco
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a href="#" class="logo" onclick="showPage('shop'); return false;">DRIXEL<span style="color: var(--accent-orange);">SA</span></a>
            
            <div class="nav-links" id="navLinks">
                <a href="#" class="active" onclick="showPage('home'); return false;">Home</a>
                <a href="#" onclick="showPage('shop'); return false;">Shop</a>
                


                <a href="#" onclick="showPage('yoco-direct'); return false;">Quick Buy</a>
                <a href="#" onclick="showPage('about'); return false;">About</a>
                <a href="#" onclick="showPage('contact'); return false;">Contact</a>
            </div>
            
            <div class="nav-icons">
                <a href="#" onclick="showPage('auth'); return false;" id="authLink">
                    <i class="fas fa-user"></i>
                </a>
                <div class="cart-btn">
                    <i class="fas fa-shopping-bag" onclick="checkAuthAndNavigate('cart')"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
                <div class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
        </div>
    </nav>


<!-- Global Hamburger Menu Overlay (Desktop + Mobile) -->
<div id="globalMenuOverlay" aria-hidden="true">
    <div id="globalMenuPanel" role="dialog" aria-label="Menu">
        <div class="global-menu-header">
            <div class="global-menu-title">Menu</div>
            <button class="global-menu-close" id="globalMenuClose" aria-label="Close menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="global-menu-links">
            <a href="#" onclick="showPage('home'); closeGlobalMenu(); return false;">Home</a>
            <a href="#" onclick="showPage('shop'); closeGlobalMenu(); return false;">Shop</a>
            <a href="#" onclick="showPage('yoco-direct'); closeGlobalMenu(); return false;">Quick Buy</a>
            <a href="#" onclick="showPage('about'); closeGlobalMenu(); return false;">About</a>
            <a href="#" onclick="showPage('contact'); closeGlobalMenu(); return false;">Contact</a>
        </nav>
        

    
        <div class="global-collections" aria-label="Collections">
            <div class="mobile-collections-title">Collections</div>
            <div class="collections-bar" id="globalCollectionsBar">
                <button class="collection-chip" data-filter="new" onclick="navigateToShopAndFilter('new'); closeGlobalMenu();">New Arrivals</button>
                <button class="collection-chip" data-filter="apparel" onclick="navigateToShopAndFilter('apparel'); closeGlobalMenu();">Apparel</button>
                <button class="collection-chip disabled" data-filter="accessories" onclick="showCollectionComingSoon('Accessories'); return false;">Accessories</button>
                <button class="collection-chip disabled" data-filter="footwear" onclick="showCollectionComingSoon('Footwear'); return false;">Footwear</button>
                <button class="collection-chip" data-filter="headwear" onclick="navigateToShopAndFilter('headwear'); closeGlobalMenu();">Headwear</button>
            </div>
        </div>

</div>
</div>

    <!-- Home Page -->
    <section id="homePage" class="page">
        <div class="hero">
            <div class="container">
                <h1>Elevate Your Street Style</h1>
                <p>Premium South African streetwear that blends urban culture with luxury aesthetics. Founded in 2025, crafted for the bold.</p>
                <a href="#" class="btn" onclick="showPage('shop'); return false;">Shop Collection</a>
                <a href="#" class="btn btn-outline mt-20" onclick="showPage('yoco-direct'); return false;">Quick Checkout</a>
            </div>
        </div>

        <div class="section bg-grey">
            <div class="container">
                <!-- Collections Bar (Home) -->
                <div class="collections-bar home-collections-bar" id="homeCollectionsBar">
                    <button class="collection-chip" data-filter="new" onclick="navigateToShopAndFilter('new')">New Arrivals</button>
                    <button class="collection-chip" data-filter="apparel" onclick="navigateToShopAndFilter('apparel')">Apparel</button>
                    <button class="collection-chip disabled" data-filter="accessories" onclick="showCollectionComingSoon('Accessories'); return false;">Accessories</button>
                    <button class="collection-chip disabled" data-filter="footwear" onclick="showCollectionComingSoon('Footwear'); return false;">Footwear</button>
                    <button class="collection-chip" data-filter="headwear" onclick="navigateToShopAndFilter('headwear')">Headwear</button>
                </div>


                <h2 class="text-center">Curated Collections</h2>
                <div class="processing-banner">
                    <i class="fas fa-clock"></i> IMPORTANT: Due to high demand, orders take 4-8 days to process + 3-5 business days delivery
                </div>
                
                <!-- Collections Bar (Home) -->
                


                <div class="products-grid" id="featuredProducts">
                    <!-- Featured products loaded by JavaScript -->
                </div>
                <div class="text-center mt-40">
                    <a href="#" class="btn" onclick="showPage('shop'); return false;">View All Products</a>
                    <a href="#" class="btn btn-outline mt-20" onclick="showPage('yoco-direct'); return false;">Quick Checkout</a>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="container">
                <div class="text-center">
                    <h2>The Drixel Experience</h2>
                    <p style="max-width: 800px; margin: 0 auto 50px;">Founded in 2025, we're redefining South African streetwear with premium quality, fast delivery, and exceptional customer experience.</p>
                    <div class="products-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="text-center">
                            <div style="width: 80px; height: 80px; background: var(--nike-black); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                                <i class="fas fa-tshirt" style="font-size: 36px; color: white;"></i>
                            </div>
                            <h3>Premium Craftsmanship</h3>
                            <p>High-quality fabrics with meticulous attention to detail</p>
                        </div>
                        <div class="text-center">
                            <div style="width: 80px; height: 80px; background: var(--accent-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                                <i class="fas fa-shipping-fast" style="font-size: 36px; color: white;"></i>
                            </div>
                            <h3>Reliable Delivery</h3>
                            <p>Free delivery on orders over R1000 via premium couriers</p>
                        </div>
                        <div class="text-center">
                            <div style="width: 80px; height: 80px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                                <i class="fas fa-envelope" style="font-size: 36px; color: white;"></i>
                            </div>
                            <h3>Real-time Updates</h3>
                            <p>Automatic email notifications at every order stage</p>
                        </div>
                        <div class="text-center">
                            <div style="width: 80px; height: 80px; background: var(--success-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                                <i class="fas fa-headset" style="font-size: 36px; color: white;"></i>
                            </div>
                            <h3>Dedicated Support</h3>
                            <p>Local customer service with rapid response times</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Shop Page -->
    <section id="shopPage" class="page hidden">
        <div class="section">
            <div class="container">
                <h1>Shop Collection</h1>
                <div class="timeline">
                    <h4><i class="fas fa-clock"></i> Order Processing Timeline</h4>
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-1"></i></div>
                        <div class="timeline-content">
                            <strong>Order Processing:</strong> 1-3 days (due to high demand)
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-2"></i></div>
                        <div class="timeline-content">
                            <strong>Production:</strong> Additional 2-5 days if item needs manufacturing
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-icon"><i class="fas fa-3"></i></div>
                        <div class="timeline-content">
                            <strong>Delivery:</strong> 3-5 business days via The Courier Guy or PAXI
                        </div>
                    </div>
                </div>
                
                <!-- Collections Bar -->
                


<div class="products-grid" id="allProducts">
                    <!-- All products loaded by JavaScript -->
                </div>
                <div class="text-center mt-40">
                    <a href="#" class="btn btn-outline" onclick="showPage('yoco-direct'); return false;">
                        <i class="fas fa-bolt"></i> Express Checkout with Yoco
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Yoco Direct Buy Page -->
    <section id="yocoDirectPage" class="page hidden">
        <div class="yoco-direct-page">
            <div class="container">
                <h1 class="text-center">Quick Checkout</h1>
                <p class="text-center" style="max-width: 800px; margin: 0 auto 40px;">
                    Skip the cart and go straight to secure payment. Click any product below to complete payment with Yoco.
                </p>
                
                <div class="processing-banner">
                    <i class="fas fa-exclamation-circle"></i> IMPORTANT: Due to exceptional demand, please allow 1-3 days for order processing before shipping
                </div>
                
                <div class="yoco-grid" id="yocoProductsGrid">
                    <!-- Yoco products loaded by JavaScript with size/color selection -->
                </div>
                
                <div class="text-center mt-40">
                    <div class="email-notification">
                        <p><i class="fas fa-envelope-open-text"></i> <strong>Automatic Email Updates:</strong> After purchase, you'll receive order confirmation, processing updates, and delivery notifications from <strong>drixelsa@gmail.com</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Single Product Page -->
    <section id="productPage" class="page hidden">
        <div class="single-product">
            <div class="container">
<div class="product-backbar">
                    <button type="button" class="back-to-products-btn" onclick="if (typeof showPage==='function') { showPage('shopPage'); } else { window.location.hash = '#shop'; document.getElementById('productPage')?.classList.add('hidden'); document.getElementById('shopPage')?.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); }">
                        <i class="fas fa-arrow-left"></i> Back to Products
                    </button>
                </div>
                <div id="productDetail">
                    <!-- Product details loaded by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Cart Page -->
    <section id="cartPage" class="page hidden">
        <div class="cart-page">
            <div class="container">
                <h1>Your Shopping Cart</h1>
                <div class="processing-banner">
                    <i class="fas fa-clock"></i> Processing Timeline: 1-3 days (high demand) + 2-5 business days delivery
                </div>
                <div class="cart-container">
                    <div id="cartItemsContainer">
                        <!-- Cart items loaded by JavaScript -->
                    </div>
                    <div class="cart-summary">
                        <h3>Order Summary</h3>
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="cartSubtotal">R 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span id="cartShipping">R 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax (0% VAT)</span>
                            <span id="cartTax">R 0.00</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total</span>
                            <span id="cartTotal">R 0.00</span>
                        </div>
                        <div id="shippingNote" class="shipping-note"></div>
                        <button class="btn mt-20" style="width: 100%;" onclick="checkAuthAndNavigate('checkout')">Proceed to Checkout</button>
                        <button class="btn btn-accent mt-10" style="width: 100%;" onclick="initiateYocoCheckoutFromCart()">
                            <i class="fas fa-bolt"></i> Quick Pay with Yoco
                        </button>
                        <div class="email-notification mt-20">
                            <p><i class="fas fa-envelope"></i> You'll receive automatic email updates from drixelsa@gmail.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Checkout Page -->
    <section id="checkoutPage" class="page hidden">
        <div class="checkout-page">
            <div class="container">
                <h1>Secure Checkout</h1>
                <div class="processing-banner">
                    <i class="fas fa-exclamation-triangle"></i> NOTICE: Due to high demand, order processing takes 1-3 days before shipping
                </div>
                <div class="checkout-container">
                    <div>
                        <div class="checkout-form-section">
                            <h3>Shipping Information</h3>
                            <form id="checkoutForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="firstName">First Name</label>
                                        <input type="text" id="firstName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="lastName">Last Name</label>
                                        <input type="text" id="lastName" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" required>
                                    <small style="color: var(--accent-orange); margin-top: 8px; display: block;">All order updates will be sent to this email</small>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" required>
                                    <small style="color: var(--accent-orange); margin-top: 8px; display: block;">Required for delivery updates from courier</small>
                                </div>
                                <div class="form-group">
                                    <label for="address">Street Address</label>
                                    <input type="text" id="address" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city">City</label>
                                        <input type="text" id="city" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="postalCode">Postal Code</label>
                                        <input type="text" id="postalCode" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="province">Province</label>
                                    <select id="province" required>
                                        <option value="">Select Province</option>
                                        <option value="Gauteng">Gauteng</option>
                                        <option value="Western Cape">Western Cape</option>
                                        <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                                        <option value="Eastern Cape">Eastern Cape</option>
                                        <option value="Free State">Free State</option>
                                        <option value="Limpopo">Limpopo</option>
                                        <option value="Mpumalanga">Mpumalanga</option>
                                        <option value="North West">North West</option>
                                        <option value="Northern Cape">Northern Cape</option>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <div class="checkout-form-section">
                            <h3>Delivery Method</h3>
                            <div class="courier-info" style="margin-bottom: 25px; background: rgba(0, 102, 204, 0.1); padding: 20px; border-radius: var(--border-radius);">
                                <i class="fas fa-truck"></i>
                                <div>
                                    <strong>The Courier Guy / PAXI</strong>
                                    <p style="margin: 8px 0 0 0;">Standard delivery: 3-5 business days after processing</p>
                                </div>
                            </div>
                            
                            <h3>Payment Method</h3>
                            <p>Choose how you'd like to pay:</p>
                            
                            
<div class="form-group mt-20">
  <div class="payment-methods-grid">
    <label class="payment-method-card" for="payBank">
      <input type="radio" id="payBank" name="paymentMethod" value="bank" checked>
      <span class="pm-icon"><i class="fa-solid fa-building-columns"></i></span>
      <span class="pm-text">
        <strong>Bank Transfer</strong>
        <span class="pm-sub">Pay via EFT / bank transfer (manual verification)</span>
      </span>
    </label>

    <label class="payment-method-card" for="payYoco">
      <input type="radio" id="payYoco" name="paymentMethod" value="yoco">
      <span class="pm-icon"><i class="fa-solid fa-credit-card"></i></span>
      <span class="pm-text">
        <strong>Secure Pay with Yoco</strong>
        <span class="pm-sub">Pay instantly with debit/credit card</span>
      </span>
    </label>

    <label class="payment-method-card" for="paySnapScan">
      <input type="radio" id="paySnapScan" name="paymentMethod" value="snapscan">
      <span class="pm-icon"><i class="fa-solid fa-qrcode"></i></span>
      <span class="pm-text">
        <strong>Pay with SnapScan</strong>
        <span class="pm-sub">Scan the QR code to pay</span>
      </span>
    </label>
  </div>
</div>

                            
                            <div id="bankTransferInfo">
                                <p>Pay via bank transfer using these details:</p>
                                <div style="background: rgba(255, 107, 0, 0.05); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 2px dashed var(--accent-orange);">
                                    <p><strong>Account Name:</strong> Drixel SA</p>
                                    <p><strong>Account Number:</strong> 071337873</p>
                                    <p><strong>Bank:</strong> Standard Bank</p>
                                    <p><strong>Reference:</strong> Use your order number</p>
                                </div>
                            </div>
                            
                            <div id="yocoPaymentInfo" style="display: none;">
                                <p>Click the button below to securely pay with your credit or debit card.</p>
                                <p style="margin-top:10px; font-size: 0.95em; opacity: 0.9;"><strong>Important:</strong> After you complete payment, return to this page and tap <strong>Place Order</strong> if it doesnâ€™t confirm automatically.</p>
                                <button class="btn btn-accent mt-20" style="width: 100%;" onclick="initiateYocoCheckout()">
                                    <i class="fas fa-bolt"></i> Pay with Yoco Now
                                </button>
                            </div>
                            
                            <!-- SNAPSCAN SECTION -->
                            <div id="snapScanInfo" style="display: none;">
                                <div style="background: rgba(0, 150, 255, 0.1); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 2px dashed #0096FF;">
                                    <div style="text-align: center;">
                                        <h4 style="color: #0096FF; margin-bottom: 15px;">
                                            <i class="fas fa-qrcode"></i> SnapScan Payment
                                        </h4>
                                        <p style="margin: 10px 0 15px; font-size: 0.95em; opacity: 0.9;"><strong>Important:</strong> After paying in SnapScan, please come back to this page (use the back button) and tap <strong>Place Order</strong> to confirm your order and receive your receipt + email.</p>
                                        
                                        <!-- SnapScan QR Code -->
                                        <div class="snapscan-qr-container">
                                            <div id="snapScanQRCode" style="width: 250px; height: 250px; margin: 0 auto 15px;"></div>
                                            <p><strong>Scan with SnapScan App to Pay</strong></p>
                                            <p style="font-size: 14px; color: #666;">
                                                Use your SnapScan mobile app to scan this QR code
                                            </p>

                                            <a id="snapScanClickPayLink" href="#" target="_blank"
                                               style="display:inline-block;margin-top:10px;padding:10px 14px;border-radius:10px;
                                                      background:#111;color:#fff;text-decoration:none;font-weight:700;font-size:14px;">
                                                Click here to pay
                                            </a>
                                            <div id="snapScanClickPayAmount" style="margin-top:8px;font-size:12px;color:#999;"></div>
                                        </div>
                                        
                                        <div class="snapscan-ref-box">
                                            <p><strong>Payment Reference:</strong> <span id="snapScanReference" style="color: var(--accent-orange); font-weight: bold; font-size: 18px;">Loading...</span></p>
                                            <p><strong>Amount:</strong> <span id="snapScanAmount" style="font-weight: bold; font-size: 18px;">R 0.00</span></p>
                                            <p><strong>Merchant:</strong> Drixel SA (2026/000210/07)</p>
                                        </div>
                                        
                                        <button id="copyRefBtn" onclick="copySnapScanReference()" class="btn btn-snapscan" style="margin-top: 15px; width: 100%;">
                                            <i class="fas fa-copy"></i> Copy Reference Number
                                        </button>
                                        
                                        <button onclick="confirmSnapScanPayment()" class="btn btn-accent" style="margin-top: 10px; width: 100%;">
                                            <i class="fas fa-check-circle"></i> I've Paid with SnapScan
                                        </button>
                                        
                                        <p style="margin-top: 15px; font-size: 12px; color: #666;">
                                            <i class="fas fa-info-circle"></i> After paying, click "I've Paid with SnapScan" to confirm your payment
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="cart-summary">
                        <h3>Order Summary</h3>
                        <div id="checkoutSummary">
                            <!-- Checkout summary loaded by JavaScript -->
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total</span>
                            <span id="checkoutTotal">R 0.00</span>
                        </div>
                        <div id="checkoutShippingNote" class="shipping-note"></div>
                        
                        <!-- Subscription Opt-in -->
                        <div class="subscription-checkbox">
                            <div class="checkbox-group">
                                <input type="checkbox" id="newsletterSubscription" checked>
                                <label for="newsletterSubscription">
                                    <strong>Subscribe to Drixel Updates</strong><br>
                                    I agree to receive email updates about my order, new collections, exclusive promotions, and design previews from Drixel SA. I can unsubscribe at any time.
                                </label>
                            </div>
                        </div>
<div class="mt-20" style="font-size:0.95em; opacity:0.9;"><strong>Note:</strong> If you paid via SnapScan/Yoco in another screen, come back here and tap <strong>Place Order</strong> to finalize and receive your receipt + confirmation email.</div>




                        <button class="btn mt-20" style="width: 100%;" onclick="placeOrder()">Place Order</button>
                        <div class="email-notification mt-20">
                            <p><i class="fas fa-mail-bulk"></i> After placing order, check your email for:</p>
                            <ul style="font-size: 13px; margin-top: 10px; padding-left: 20px;">
                                <li>âœ“ Order confirmation</li>
                                <li>âœ“ Payment confirmation</li>
                                <li>âœ“ Shipping updates</li>
                                <li>âœ“ Delivery notification</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Order Confirmation Page -->
    <section id="orderConfirmationPage" class="page hidden">
        <div class="section">
            <div class="container">
                <div class="text-center" style="max-width: 700px; margin: 0 auto; padding: 80px 0;">
                    <div style="width: 100px; height: 100px; background: var(--accent-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px;">
                        <i class="fas fa-check" style="font-size: 48px; color: white;"></i>
                    </div>
                    <h1>Order Confirmed!</h1>
                    <p id="confirmationMessage">Your order has been processed successfully. A confirmation email has been sent to your email address.</p>
                    <p>Your order number is: <strong id="orderNumber" style="color: var(--accent-orange);">LOADING...</strong></p>
                    
                    <div class="email-notification mt-30">
                        <h4><i class="fas fa-envelope-open-text"></i> Automatic Email Updates</h4>
                        <p>You'll receive email updates from <strong>drixelsa@gmail.com</strong> at every step:</p>
                        <ul style="text-align: left; margin-top: 15px; background: rgba(255, 255, 255, 0.5); padding: 20px; border-radius: var(--border-radius);">
                            <li>âœ“ <strong>Order Confirmation:</strong> Sent immediately</li>
                            <li>âœ“ <strong>Payment Confirmation:</strong> When payment is verified</li>
                            <li>âœ“ <strong>Processing Update:</strong> During the 1-3 day processing window</li>
                            <li>âœ“ <strong>Shipping Notification:</strong> With tracking details</li>
                            <li>âœ“ <strong>Delivery Alert:</strong> Before courier arrives</li>
                            <li>âœ“ <strong>New Collection Previews:</strong> Exclusive design announcements</li>
                        </ul>
                    </div>
                    
                    <div class="courier-info mt-30" style="background: rgba(0, 102, 204, 0.1); padding: 25px; border-radius: var(--border-radius);">
                        <i class="fas fa-shipping-fast" style="color: var(--accent-blue); font-size: 24px;"></i>
                        <div style="text-align: left; margin-left: 15px;">
                            <strong>Delivery Information:</strong>
                            <p style="margin: 8px 0 0 0;">Your order will be shipped via The Courier Guy or PAXI</p>
                            <p style="margin: 5px 0 0 0;">Estimated delivery: 3-5 business days after processing</p>
                            <p style="margin: 5px 0 0 0;" id="deliveryFeeInfo"></p>
                        </div>
                    </div>
                    
                    <div class="timeline mt-30">
                        <h4><i class="fas fa-project-diagram"></i> Order Processing Timeline</h4>
                        <p><strong>Processing Time:</strong> 1-3 days (Due to high demand)</p>
                        <p><strong>Production Time:</strong> Additional 2-5 days if manufacturing needed</p>
                        <p><strong>Delivery Time:</strong> 3-5 business days via premium courier services</p>
                    </div>
                    
                    <div class="mt-40">
                        <a href="#" class="btn" onclick="showPage('shop'); return false;">Continue Shopping</a>
                        <a href="#" class="btn btn-outline mt-20" onclick="showPage('home'); return false;">Return to Home</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Authentication Page -->
    <section id="authPage" class="page hidden">
        <div class="section">
            <div class="container">
                <div class="auth-container">
                    <div class="auth-tabs">
                        <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
                    <!-- Invisible reCAPTCHA container for SMS MFA -->
                    <div id="mfa-recaptcha-container"></div>

                        <div class="auth-tab" onclick="showAuthTab('register')">Register</div>
                    </div>
                    
                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active" onsubmit="event.preventDefault(); firebaseLogin();">
                        <div class="form-group">
                            <label for="loginEmail">Email Address</label>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required placeholder="Enter your password">
                        </div>
                        
                        <div id="loginError" class="error-message" style="color: #EF476F; font-size: 14px; margin: 10px 0; display: none;"></div>
                        <div id="loginSuccess" class="success-message" style="color: #0CAF60; font-size: 14px; margin: 10px 0; display: none;"></div>
                        
                        <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-sign-in-alt"></i> LOGIN
                        </button>

                        <button type="button" class="btn btn-outline" style="width: 100%; margin-top: 12px;" onclick="firebaseGoogleLogin()">
                            <i class="fab fa-google"></i> CONTINUE WITH GOOGLE
                        </button>


                        <p class="mt-10 text-center" style="font-size: 14px;">
                            <a href="#" onclick="resetPasswordFromLogin(); return false;" style="color: var(--accent-orange); text-decoration: underline;">
                                Forgot password? Reset it
                            </a>
                        </p>

                        <div class="subscription-checkbox mt-20">
                            <div class="checkbox-group">
                                <input type="checkbox" id="loginSubscription" checked>
                                <label for="loginSubscription">
                                    Subscribe to receive exclusive updates, new collection previews, and promotional emails from Drixel SA.
                                </label>
                            </div>
                        </div>
                        
                        <p class="mt-20 text-center" style="color: var(--accent-orange); font-size: 14px;">
                            <i class="fas fa-lock"></i> Secure login required for ordering
                        </p>
                    </form>
                    
                    <!-- Registration Form -->
                    <form id="registerForm" class="auth-form" onsubmit="event.preventDefault(); firebaseRegister();">
                        <div class="form-group">
                            <label for="registerName">Full Name *</label>
                            <input type="text" id="registerName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">Email Address *</label>
                            <input type="email" id="registerEmail" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="registerPhone">Phone Number (Optional)</label>
                            <input type="tel" id="registerPhone" placeholder="071 234 5678">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Password *</label>
                            <input type="password" id="registerPassword" required placeholder="At least 8 characters">
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Must be at least 8 characters with uppercase, lowercase, and number
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="registerConfirmPassword">Confirm Password *</label>
                            <input type="password" id="registerConfirmPassword" required placeholder="Confirm your password">
                        </div>
                        
                        <div id="registerError" class="error-message" style="color: #EF476F; font-size: 14px; margin: 10px 0; display: none;"></div>
                        <div id="registerSuccess" class="success-message" style="color: #0CAF60; font-size: 14px; margin: 10px 0; display: none;"></div>
                        
                        <div class="subscription-checkbox mt-20">
                            <div class="checkbox-group">
                                <input type="checkbox" id="registerSubscription" checked>
                                <label for="registerSubscription">
                                    I agree to receive email updates from Drixel SA about my orders, new collections, promotions, and design previews.
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn mt-20" style="width: 100%;">
                            <i class="fas fa-user-plus"></i> CREATE ACCOUNT
                        </button>
                        
                        <p class="mt-20 text-center" style="color: #666; font-size: 12px;">
                            By registering, you agree to our <a href="#" onclick="showPage('terms'); return false;" style="color: var(--accent-orange);">Terms & Conditions</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- About Page -->
    <section id="aboutPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>About Drixel SA</h1>
                <p><strong>Founded in 2025</strong>, Drixel SA is a South African streetwear brand with a mission to redefine urban fashion in the African context. We blend international streetwear aesthetics with local cultural influences to create unique, high-quality apparel.</p>
                
                <h2>Our Vision</h2>
                <p>To become Africa's leading streetwear brand, representing the diversity, creativity, and resilience of African youth culture on the global stage.</p>
                
                <h2>Our Mission</h2>
                <p>To create premium streetwear that empowers individual expression while delivering exceptional customer experiences through quality craftsmanship, clear communication, and reliable delivery.</p>
                
                <h2>Customer Experience</h2>
                <p>We prioritize your shopping experience with:</p>
                <ul>
                    <li><strong>Automatic Email Updates:</strong> Real-time notifications from drixelsa@gmail.com</li>
                    <li><strong>Reliable Delivery:</strong> Via The Courier Guy or PAXI with R70 fee (Free over R1000)</li>
                    <li><strong>Multiple Payment Options:</strong> Yoco API payments or bank transfer</li>
                    <li><strong>Quality Assurance:</strong> Premium materials with attention to detail</li>
                    <li><strong>Processing Transparency:</strong> Clear communication about the 1-3 day processing timeline</li>
                </ul>
                
                <h2>Contact Information</h2>
                <p><strong>Phone:</strong> 061 016 0195 or 068 700 3485</p>
                <p><strong>Order Updates:</strong> drixelsa@gmail.com (Automatic system notifications)</p>
                <p><strong>General Inquiries:</strong> drixelsa@gmail.com</p>
                <p><strong>Business Hours:</strong> Monday - Friday, 9:00 AM - 5:00 PM SAST</p>
                <p><strong>Founded:</strong> 2025</p>
            </div>
        </div>
    </section>

    <!-- Contact Page -->
    <section id="contactPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>Contact Us</h1>
                <p>We'd love to hear from you. Reach out to us through any of the channels below.</p>
                
                <div class="email-notification">
                    <p><i class="fas fa-info-circle"></i> <strong>Order Inquiries:</strong> For order updates, please check your email as all notifications are automatically sent from <strong>drixelsa@gmail.com</strong></p>
                </div>
                
                <div class="form-row" style="margin-top: 50px;">
                    <div>
                        <h3>Contact Information</h3>
                        <div class="mt-30">
                            <p><i class="fas fa-phone-alt"></i> <strong>Phone:</strong> <a href="tel:0610160195" style="color: var(--accent-orange);">061 016 0195</a></p>
                            <p><i class="fas fa-phone-alt"></i> <strong>Alt Phone:</strong> <a href="tel:0687003485" style="color: var(--accent-orange);">068 700 3485</a></p>
                            <p><i class="fas fa-envelope"></i> <strong>Order Updates:</strong> <a href="mailto:drixelsa@gmail.com" style="color: var(--accent-orange);">drixelsa@gmail.com</a></p>
                            <p><i class="fas fa-envelope"></i> <strong>General:</strong> <a href="mailto:drixelsa@gmail.com" style="color: var(--accent-orange);">drixelsa@gmail.com</a></p>
                            <p><i class="fas fa-truck-loading"></i> <strong>Courier Partners:</strong> The Courier Guy & PAXI</p>
                            <p><i class="fas fa-clock"></i> <strong>Processing Time:</strong> 1-3 days + 2-5 business days delivery</p>
                        </div>
                        
                        <h3 class="mt-40">Social Media</h3>
                        <div class="social-icons mt-20">
                            <a href="http://instagram.drixelsa.co.za/" target="_blank"><i class="fab fa-instagram"></i></a>
                            <a href="http://facebook.drixelsa.co.za/" target="_blank"><i class="fab fa-facebook-f"></i></a>
                            <a href="http://tiktok.drixelsa.co.za/" target="_blank"><i class="fab fa-tiktok"></i></a>
                            <a href="http://twiitter.drixelsa.co.za/" target="_blank"><i class="fab fa-twitter"></i></a>
                            <a href="http://LinkedIn.drixelsa.co.za/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
                            <a href="http://youtube.drixelsa.co.za/" target="_blank"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Send us a Message</h3>
                        <form id="contactForm" class="mt-30">
                            <div class="form-group">
                                <label for="contactName">Your Name</label>
                                <input type="text" id="contactName" required>
                            </div>
                            <div class="form-group">
                                <label for="contactEmail">Email Address</label>
                                <input type="email" id="contactEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="contactSubject">Subject</label>
                                <input type="text" id="contactSubject" required>
                            </div>
                            <div class="form-group">
                                <label for="contactMessage">Message</label>
                                <textarea id="contactMessage" rows="6" required></textarea>
                            </div>
                            <button type="button" class="btn" onclick="sendContactMessage()">Send Message</button>
                            <p class="mt-20" style="color: var(--accent-orange); font-size: 14px;">
                                For order-related inquiries, please check your email for automatic updates from drixelsa@gmail.com
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Policy Pages (Advanced English) -->
    <section id="termsPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>Terms and Conditions of Engagement</h1>
                
                <h2>1. Acceptance of Contractual Terms</h2>
                <p>By accessing, browsing, or utilizing the Drixel SA digital platform, you acknowledge and agree to be legally bound by these Terms and Conditions, constituting a valid contractual agreement between yourself and Drixel SA (hereinafter referred to as "the Company").</p>
                
                <h2>2. Product Specifications and Pricing</h2>
                <p>All merchandise is subject to availability. The Company reserves the unilateral right to discontinue any product offering at its sole discretion without prior notification. All monetary values are denominated in South African Rand (ZAR) and include Value-Added Tax (VAT) where statutorily applicable. Prices are subject to modification without advance notice.</p>
                
                <h2>3. Order Placement and Financial Transaction Protocols</h2>
                <p>All purchase orders are subject to formal acceptance by the Company and product availability. The Company extends payment modalities through Yoco encrypted payment gateways, SnapScan QR payments, or traditional electronic funds transfer as specified during the checkout procedure.</p>
                
                <h2>4. Delivery and Logistics Protocol</h2>
                <p>The Company facilitates nationwide distribution through strategic partnerships with The Courier Guy and PAXI. The standard delivery tariff is R70.00. This tariff is automatically waived for transactions exceeding R1000.00. The estimated delivery timeframe is 3-5 business days following order processing completion.</p>
                
                <h2>5. Order Processing Timeline</h2>
                <p>Due to exceptional market demand, all orders necessitate a 1-3 day processing period prior to dispatch. Additional manufacturing time of 2-5 days may be required for items not currently in inventory. Customers shall receive automated notifications regarding processing status.</p>
                
                <h2>6. Electronic Communication Consent</h2>
                <p>By initiating a purchase order, you provide explicit consent to receive automated electronic communications from drixelsa@gmail.com regarding order status, including but not limited to: order confirmation, payment verification, processing updates, dispatch notifications, and delivery completion alerts.</p>
                
                <h2>7. Returns and Refund Policy</h2>
                <p>For comprehensive information regarding returns, exchanges, and refund protocols, please consult our dedicated <a href="#" onclick="showPage('refund'); return false;" style="color: var(--accent-orange); font-weight: 600;">Return Policy</a> documentation.</p>
                
                <h2>Financial Institution Particulars</h2>
                <p><strong>Account Holder:</strong> DRIXEL CLOTHING BRAND</p>
                <p><strong>Account Number:</strong> 071337873</p>
                <p><strong>Financial Institution:</strong> Standard Bank</p>
                <p><strong>Payment Reference:</strong> Your Order ID</p>
                
                <p class="mt-40"><em>Last comprehensive revision: January 2026 | Drixel SA Corporate Establishment: 2025</em></p>
            </div>
        </div>
    </section>

    <section id="privacyPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>Privacy and Data Protection Protocol</h1>
                <p>Drixel SA (corporate establishment 2025) maintains an unwavering commitment to protecting your personal information and digital privacy. This comprehensive policy delineates our methodologies for collecting, utilizing, processing, and safeguarding your personal data.</p>
                
                <h2>1. Data Collection Methodology</h2>
                <p>We collect personal information that you voluntarily provide during order placement, account creation, or direct communication, including but not limited to: complete designation, email address, telephone number, residential address, and payment particulars necessary for transaction execution.</p>
                
                <h2>2. Data Utilization Protocol</h2>
                <p>Your personal information is utilized exclusively for: order processing and fulfillment, automated status notifications, delivery coordination, customer service enhancement, and with explicit consent, marketing communications regarding new collections and promotional initiatives.</p>
                
                <h2>3. Electronic Communication Protocol</h2>
                <p>We dispatch automated transactional emails from drixelsa@gmail.com for order confirmation, payment verification, processing updates, shipping notifications, and delivery alerts. These communications constitute essential service notifications. Marketing communications are dispatched only with explicit opt-in consent.</p>
                
                <h2>4. Financial Data Security</h2>
                <p>When utilizing Yoco payment gateways, your financial information is processed directly through Yoco's encrypted systems. The Company does not store, process, or retain credit card particulars on our servers. Bank transfer information is processed through secure banking channels.</p>
                
                <h2>5. Data Sharing with Third-Party Service Providers</h2>
                <p>We share necessary delivery information (designation, address, contact number) with our logistics partners (The Courier Guy and PAXI) exclusively for delivery execution. These partners are contractually obligated to maintain data confidentiality and security.</p>
                
                <h2>6. Data Retention Period</h2>
                <p>Order data is retained for a period of five years to comply with statutory requirements and facilitate customer service. Marketing preferences are retained until withdrawal of consent.</p>
                
                <h2>7. Your Statutory Rights</h2>
                <p>You retain the right to: access your personal data, request data correction, withdraw marketing consent, request data deletion (subject to statutory retention requirements), and lodge complaints with relevant regulatory authorities. To exercise these rights, contact drixelsa@gmail.com.</p>
                
                <h2>8. Cookie Implementation</h2>
                <p>Our digital platform implements cookies to enhance user experience, analyze platform traffic, and personalize content. By utilizing our platform, you consent to cookie implementation as detailed in our cookie policy.</p>
                
                <p class="mt-40"><em>Last comprehensive revision: January 2026 | Drixel SA Corporate Establishment: 2025</em></p>
            </div>
        </div>
    </section>

    <section id="refundPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>Return, Exchange, and Refund Protocol</h1>
                <p>Drixel SA is committed to ensuring complete customer satisfaction with all purchases. This comprehensive policy delineates our protocols for returns, exchanges, and refunds.</p>
                
                <h2>1. Return Eligibility Criteria</h2>
                <p>Merchandise may be returned within 30 business days from delivery date, provided the following conditions are strictly satisfied:</p>
                <ul>
                    <li>Items remain unworn, unwashed, and unaltered</li>
                    <li>Original tags remain attached and undamaged</li>
                    <li>Items are returned in original packaging</li>
                    <li>Merchandise exhibits no signs of wear, damage, or alteration</li>
                    <li>A valid proof of purchase is presented</li>
                </ul>
                
                <h2>2. Refund Processing Protocol</h2>
                <p>Upon receipt and inspection of returned merchandise, refund processing will commence within 7-10 business days. Refunds will be issued through the original payment methodology utilized during the initial transaction. Please note that refund processing times may vary depending on financial institution protocols.</p>
                
                <h2>3. Delivery Tariff Policy for Returns</h2>
                <p>The original delivery tariff (R70) is non-refundable except in cases of Company error or defective merchandise. Return shipping costs are the responsibility of the customer unless the return results from Company error or product defect.</p>
                
                <h2>4. Complimentary Delivery Policy for Partial Returns</h2>
                <p>When a transaction qualifies for complimentary delivery (order value exceeding R1000) and subsequent partial returns reduce the transaction value below the R1000 threshold, the original delivery tariff (R70) will be deducted from the refund amount.</p>
                
                <h2>5. Exchange Protocol</h2>
                <p>To execute an exchange, please return the original merchandise following standard return procedures and initiate a new purchase order for the desired item. Upon receipt and inspection of the returned item, we will process a refund for the original transaction.</p>
                
                <h2>6. Defective or Non-Conforming Merchandise</h2>
                <p>If you receive defective or non-conforming merchandise, please contact our customer service at drixelsa@gmail.com within 7 business days of delivery. Provide photographic evidence of the defect. For validated claims, we will arrange return collection at Company expense and expedite replacement or refund processing.</p>
                
                <h2>7. Final Sale Merchandise</h2>
                <p>Items explicitly designated as "Final Sale" are not eligible for return, exchange, or refund except in cases of manufacturing defects.</p>
                
                <h2>8. Refund Processing for Electronic Funds Transfer</h2>
                <p>For transactions executed via electronic funds transfer, please provide your banking particulars for refund processing:</p>
                <p><strong>Account Holder:</strong> DRIXEL CLOTHING BRAND</p>
                <p><strong>Account Number:</strong> 071337873</p>
                <p><strong>Financial Institution:</strong> Standard Bank</p>
                
                <h2>9. Return Initiation Procedure</h2>
                <p>To initiate a return, please contact drixelsa@gmail.com with your order numeric identifier and detailed reasoning for the return. Our customer service team will provide return authorization and detailed instructions.</p>
                
                <p class="mt-40"><em>Last comprehensive revision: January 2026 | Drixel SA Corporate Establishment: 2025</em></p>
            </div>
        </div>
    </section>

    <section id="shippingPage" class="page hidden">
        <div class="page-content">
            <div class="container">
                <h1>Shipping Information</h1>
                
                <h2>1. Delivery Partners</h2>
                <p>We work with The Courier Guy and PAXI for reliable nationwide delivery across South Africa. Both partners provide tracking and delivery confirmation.</p>
                
                <h2>2. Delivery Fees</h2>
                <p>Standard delivery fee is R70. Free delivery is automatically applied to orders over R1000. The free delivery threshold applies to the subtotal before tax.</p>
                
                <h2>3. Delivery Time</h2>
                <p>Standard delivery takes 3-5 business days after order processing is complete. Delivery starts after the order processing period (1-3 days due to high demand).</p>
                
                <h2>4. Order Processing Time</h2>
                <p>Due to high demand and quality control, all orders take 1-3 days to process before shipping. This includes order verification, quality checks, and packaging. For items that need to be made, an additional 5-day production time may be needed.</p>
                
                <h2>5. Delivery Areas</h2>
                <p>We deliver to all street addresses in South Africa. We don't deliver to PO Boxes. Remote areas may take longer to deliver.</p>
                
                <h2>6. Delivery Attempts</h2>
                <p>Our courier partners will try to deliver 3 times. After 3 failed attempts, the package will be returned to the depot. Extra delivery attempts may have extra charges.</p>
                
                <h2>7. Tracking Your Order</h2>
                <p>When your order ships, you'll get an email from drixelsa@gmail.com with your tracking number. You can track your order on The Courier Guy or PAXI websites.</p>
                
                <h2>8. Delivery Proof</h2>
                <p>All deliveries need a signature. The courier will take a photo of the delivery and get a signature as proof of delivery.</p>
                
                <h2>9. International Shipping</h2>
                <p>Right now, we only ship within South Africa. International shipping will be available in the future.</p>
                
                <h2>10. Delivery Problems</h2>
                <p>If you have delivery issues like delays, no delivery, or damaged packages, email drixelsa@gmail.com with your order number. We'll check with our courier partners and help within 2 business days.</p>
                
                <h2>11. Changing Delivery Address</h2>
                <p>You can change your delivery address within 24 hours of ordering by emailing drixelsa@gmail.com. Once processing starts, we can't change the address.</p>
                
                <p class="mt-40"><em>Last updated: January 2026 | Drixel SA Founded: 2025</em></p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Drixel SA</h3>
                    <p>South Africa's premium streetwear brand founded in 2025, combining urban style with quality craftsmanship.</p>
                    <div class="social-icons">
                        <a href="http://instagram.drixelsa.co.za/" target="_blank"><i class="fab fa-instagram"></i></a>
                        <a href="http://facebook.drixelsa.co.za/" target="_blank"><i class="fab fa-facebook-f"></i></a>
                        <a href="http://tiktok.drixelsa.co.za/" target="_blank"><i class="fab fa-tiktok"></i></a>
                        <a href="http://twiitter.drixelsa.co.za/" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a href="http://LinkedIn.drixelsa.co.za/" target="_blank"><i class="fab fa-linkedin-in"></i></a>
                        <a href="http://youtube.drixelsa.co.za/" target="_blank"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#" onclick="showPage('home'); return false;">Home</a></li>
                        <li><a href="#" onclick="showPage('shop'); return false;">Shop</a></li>
                        <li><a href="#" onclick="showPage('yoco-direct'); return false;">Quick Buy</a></li>
                        <li><a href="#" onclick="showPage('about'); return false;">About Us</a></li>
                        <li><a href="#" onclick="showPage('contact'); return false;">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#" onclick="showPage('refund'); return false;">Return Policy</a></li>
                        <li><a href="#" onclick="showPage('privacy'); return false;">Privacy Policy</a></li>
                        <li><a href="#" onclick="showPage('terms'); return false;">Terms & Conditions</a></li>
                        <li><a href="#" onclick="showPage('shipping'); return false;">Shipping Info</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Contact & Delivery</h3>
                    <ul class="footer-links">
                        <li><a href="tel:0610160195"><i class="fas fa-phone-alt"></i> 061 016 0195</a></li>
                        <li><a href="tel:0687003485"><i class="fas fa-phone-alt"></i> 068 700 3485</a></li>
                        <li><a href="mailto:drixelsa@gmail.com"><i class="fas fa-envelope"></i> drixelsa@gmail.com</a></li>
                        <li><i class="fas fa-truck-loading"></i> The Courier Guy / PAXI</li>
                        <li><i class="fas fa-shipping-fast"></i> R70 Delivery (Free over R1000)</li>
                        <li><i class="fas fa-clock"></i> 1-3 Day Processing + 2-5 Day Delivery</li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2026 Drixel SA. All rights reserved. | Founded 2025 | Automatic email updates from <a href="mailto:drixelsa@gmail.com" style="color: var(--accent-orange);">drixelsa@gmail.com</a></p>
            </div>
        </div>
    </footer>

    <!-- Admin Out for Delivery Modal -->
    <div id="outForDeliveryModal" class="admin-modal">
        <div class="admin-modal-content">
            <h2 style="margin-bottom: 20px;">Mark Order as Out for Delivery</h2>
            
            <div class="admin-form-group">
                <label for="trackingNumber">Tracking Number *</label>
                <input type="text" id="trackingNumber" placeholder="Enter tracking number" required>
            </div>
            
            <div class="admin-form-group">
                <label for="courierService">Courier Service *</label>
                <select id="courierService" required>
                    <option value="">Select Courier</option>
                    <option value="The Courier Guy">The Courier Guy</option>
                    <option value="PAXI">PAXI</option>
                    <option value="DHL">DHL</option>
                    <option value="FedEx">FedEx</option>
                </select>
            </div>
            
            <div class="admin-form-group">
                <label for="trackingUrl">Tracking URL (Optional)</label>
                <input type="url" id="trackingUrl" placeholder="https://tracking.example.com/TRACK123">
            </div>
            
            <div class="admin-form-group">
                <label>Customer Name</label>
                <input type="text" id="customerNameDisplay" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="admin-form-group">
                <label>Order ID</label>
                <input type="text" id="orderIdDisplay" readonly style="background: #f5f5f5;">
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button onclick="closeOutForDeliveryModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="markOutForDeliveryAndEmail()" style="flex: 2; background: #0caf60; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i> Send Out for Delivery Email
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Order Delivered Modal -->
    <div id="orderDeliveredModal" class="admin-modal">
        <div class="admin-modal-content">
            <h2 style="margin-bottom: 20px;">Mark Order as Delivered</h2>
            
            <div class="admin-form-group">
                <label for="deliveredDate">Delivery Date *</label>
                <input type="date" id="deliveredDate" required value="<?php echo date('Y-m-d'); ?>">
            </div>
            
            <div class="admin-form-group">
                <label>Order ID</label>
                <input type="text" id="deliveryOrderIdDisplay" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="admin-form-group">
                <label>Order URL</label>
                <input type="text" id="orderUrlDisplay" readonly style="background: #f5f5f5;">
                <small style="color: #666; margin-top: 5px;">This URL will be included in the email for customers to view their order details.</small>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button onclick="closeOrderDeliveredModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="markDeliveredAndEmail()" style="flex: 2; background: #0caf60; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i> Send Order Delivered Email
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Confirm Payment Modal -->
    <div id="confirmPaymentModal" class="admin-modal">
        <div class="admin-modal-content">
            <h2 style="margin-bottom: 20px;">Confirm Bank Payment</h2>
            
            <div class="admin-form-group">
                <label>Order Number</label>
                <input type="text" id="confirmOrderNumber" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="admin-form-group">
                <label>Customer Email</label>
                <input type="text" id="confirmCustomerEmail" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="admin-form-group">
                <label>Order Amount</label>
                <input type="text" id="confirmOrderAmount" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="admin-form-group">
                <label>Payment Method</label>
                <input type="text" id="confirmPaymentMethod" readonly style="background: #f5f5f5;">
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <p><strong>Important:</strong> This will send both Order Confirmation and Order Received emails to the customer.</p>
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    â€¢ Order Confirmation (template_go2456o) - For bank transfer payments<br>
                    â€¢ Order Received (template_pr7d18s) - When payment is confirmed
                </p>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button onclick="closeConfirmPaymentModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="processPaymentConfirmation()" style="flex: 2; background: #0caf60; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-check-circle"></i> Confirm Payment & Send Emails
                </button>
            </div>
        </div>
    </div>

    <!-- EmailJS SDK -->
    
    <!-- ===== FIREBASE SDK ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            sendPasswordResetEmail, 
            GoogleAuthProvider, 
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult, 
            RecaptchaVerifier, 
            PhoneAuthProvider, 
            multiFactor, 
            PhoneMultiFactorGenerator, 
            getMultiFactorResolver
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            setDoc, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy, 
            onSnapshot,
            getDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA4_Ejkc3Of0T8fCj1QqkNN78-2xJ882F0",
            authDomain: "drixel-sa.firebaseapp.com",
            projectId: "drixel-sa",
            storageBucket: "drixel-sa.firebasestorage.app",
            messagingSenderId: "620600264300",
            appId: "1:620600264300:web:525de2d55cc1ae6269fa49",
            measurementId: "G-RTRKFY9NPW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally with ALL functions
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAnalytics = analytics;
        
        // Make all functions available globally
        window.firebaseInitializeApp = initializeApp;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSendPasswordResetEmail = sendPasswordResetEmail;
        // Social login + MFA helpers
        window.firebaseGoogleAuthProvider = GoogleAuthProvider;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignInWithRedirect = signInWithRedirect;
        window.firebaseGetRedirectResult = getRedirectResult;
        window.firebaseRecaptchaVerifier = RecaptchaVerifier;
        window.firebasePhoneAuthProvider = PhoneAuthProvider;
        window.firebaseMultiFactor = multiFactor;
        window.firebasePhoneMultiFactorGenerator = PhoneMultiFactorGenerator;
        window.firebaseGetMultiFactorResolver = getMultiFactorResolver;

        window.firebaseGetAuth = getAuth;
        window.firebaseGetFirestore = getFirestore;
        window.firebaseGetAnalytics = getAnalytics;
        
        // Make Firestore functions available globally
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseAddDoc = addDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;
        window.firebaseGetDocs = getDocs;
        window.firebaseSetDoc = setDoc;
        window.firebaseDoc = doc;
        window.firebaseServerTimestamp = serverTimestamp;
        
        console.log("âœ… Firebase initialized successfully!");
        
        // Firestore collections
        window.firebaseCollections = {
            USERS: 'users',
            ORDERS: 'orders',
            PRODUCTS: 'products',
            PENDING_PAYMENTS: 'pending_payments',
            SUBSCRIBERS: 'subscribers',
            CONTACTS: 'contacts',
            CARTS: 'carts',
            YOCO_PURCHASES: 'yoco_purchases',
            SNAPSCAN_PURCHASES: 'snapscan_purchases'
        };
        
        // Initialize auth state listener immediately
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("âœ… User logged in:", user.email);
                window.currentFirebaseUser = user;
                
                // Check if user is admin
                if (user.email === ADMIN_EMAIL) {
                    console.log("ðŸ‘‘ Admin user detected on page load");
                    // Show admin button after a short delay
                    setTimeout(() => {
                        if (typeof showAdminButton === 'function') {
                            showAdminButton();
                        }
                    }, 1000);
                }
                
                // Call global auth UI update if function exists
                if (typeof updateAuthUI === 'function') {
                    updateAuthUI();
                }
                
                // Load user cart
                if (typeof loadUserCart === 'function') {
                    loadUserCart(user.uid);
                }
            } else {
                console.log("ðŸ‘¤ No user logged in");
                window.currentFirebaseUser = null;
                if (typeof updateAuthUI === 'function') {
                    updateAuthUI();
                }
            }
        });
        
        // Initialize the rest of the app once Firebase is ready
        setTimeout(() => {
            if (typeof initializeAppAfterFirebase === 'function') {
                initializeAppAfterFirebase();
            }
        }, 500);
    </script>

    <!-- ===== MAIN JAVASCRIPT ===== -->
    <script>
        // ===== CONSTANTS =====
        const ADMIN_EMAIL = "admin@drixelsa.co.za";
        const ADMIN_PASSWORD = "@Anelisa2025";
        const ADMIN_NAMES = "Anelisa Thelejane & Andzani Mashabane";
        const YOCO_PUBLIC_KEY = "pk_live_f26b158aDmMkbm56f1c4";
        const SNAPSCAN_QR_URL = "https://pos.snapscan.io/qr/qvxSxlIE";
        const PAYMENT_SERVER_BASE = "https://drixel-payments-server.onrender.com";
        const SNAPSCAN_REGISTRATION = "2026/000210/07";

        // ===== SITE BASE URL (GLOBAL) =====
        window.SITE_BASE_URL = "https://www.drixelsa.co.za/";
        // Provide a global variable too (some functions reference SITE_BASE_URL directly)
        var SITE_BASE_URL = window.SITE_BASE_URL;

        // ===== EMAILJS CONFIGURATION =====
        const EMAILJS_CONFIG = {
            SERVICE_ID: 'service_1l5atar', // For Order Confirmation & Order Received
            SERVICE_ID_2: 'service_o42ee3e', // For Out for Delivery & Order Delivered
            PUBLIC_KEY: 'z2-hUuSkhE622HrBV', // For first service
            PUBLIC_KEY_2: 'mh_4Nr7rS6BF9bqyV', // For second service
            TEMPLATES: {
                ORDER_CONFIRMATION: 'template_go2456o', // For bank transfers when confirmed in admin
                ORDER_RECEIVED: 'template_pr7d18s', // For SnapScan/Yoco or bank transfers when confirmed
                OUT_FOR_DELIVERY: 'template_z6wpd54', // When marked as shipped in admin
                ORDER_DELIVERED: 'template_uztxg8r' // When marked as delivered in admin
                
            }
        };
        // ===== EMAILJS INITIALIZATION HELPERS =====
        // EmailJS init is global; since you use two different EmailJS accounts/keys,
        // we switch the public key before sending via each service.
        let __emailjsInitializedKey = null;

        function initEmailJSForService(serviceOrNumber = 1) {
            if (typeof emailjs === 'undefined') {
                console.error("âŒ EmailJS not loaded - cannot init");
                return false;
            }

            // Accept either:
            //  - 1 / 2  (service number)
            //  - 'service_...' (service id string)
            const useService2 = (serviceOrNumber === 2) || (serviceOrNumber === EMAILJS_CONFIG.SERVICE_ID_2);

            const key = useService2 ? EMAILJS_CONFIG.PUBLIC_KEY_2 : EMAILJS_CONFIG.PUBLIC_KEY;

            if (!key) {
                console.error("âŒ Missing EmailJS public key for service:", serviceOrNumber);
                return false;
            }

            // Avoid re-initializing with the same key
            if (__emailjsInitializedKey === key) return true;

            try {
                emailjs.init(key);
                __emailjsInitializedKey = key;
                console.log(`âœ… EmailJS initialized for service ${serviceOrNumber}`);
                return true;
            } catch (e) {
                console.error("âŒ Failed to init EmailJS:", e);
                return false;
            }
        }

        // Make available to inline onclick handlers too
        window.initEmailJSForService = initEmailJSForService;

        // Init Service 1 by default (orders)
        initEmailJSForService(1);




        // ===== APP STATE =====
        let cart = [];
        let productSelections = JSON.parse(localStorage.getItem('drixel_selections')) || {};
        let cookiesAccepted = localStorage.getItem('drixel_cookies') || false;
        let currentYocoPayment = {
            amount: 0,
            description: '',
            metadata: {},
            customer: null
        };
        let currentSnapScanOrder = null;
        let currentAdminOrder = null;

        // ===== DELIVERY SETTINGS =====
        let DELIVERY_FEE = 70;
        let FREE_DELIVERY_THRESHOLD = 1000;

        // ===== DOM ELEMENTS =====
        const cartCount = document.getElementById('cartCount');

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸš€ Drixel SA Website Initializing...");
            
            // ===== INITIALIZE EMAILJS =====
function initializeEmailJS() {
    try {
        console.log("ðŸ“§ Initializing EmailJS with two services...");
        
        // Initialize first service (for order confirmations)
        emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);

        // EmailJS helper: choose the correct public key per service
        function initEmailJSForServiceLegacy(serviceId) {
            if (typeof emailjs === 'undefined') {
                console.error("âŒ EmailJS not loaded!");
                return false;
            }
            try {
                if (serviceId === EMAILJS_CONFIG.SERVICE_ID_2) {
                    emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY_2);
                } else {
                    emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
                }
                return true;
            } catch (e) {
                console.error("âŒ EmailJS init error:", e);
                return false;
            }
        }

        console.log("âœ… EmailJS Service 1 initialized with key:", EMAILJS_CONFIG.PUBLIC_KEY);
        
        // Note: EmailJS doesn't support multiple init calls with different keys
        // We'll use the first service for all emails and switch templates as needed
        console.log("ðŸ“§ Using Service ID 1 for all emails:", EMAILJS_CONFIG.SERVICE_ID);
        console.log("ðŸ“§ Templates available:", EMAILJS_CONFIG.TEMPLATES);
        
        // Test that EmailJS is loaded
        if (typeof emailjs !== 'undefined' && emailjs.send) {
            console.log("âœ… EmailJS is ready to send emails");
        } else {
            throw new Error("EmailJS not loaded properly");
        }
        
        return true;
    } catch (error) {
        console.error("âŒ EmailJS initialization error:", error);
        return false;
    }
}
            // Initialize Yoco SDK
            loadYocoSDK();
            
            // Set up mobile menu
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const navLinks = document.getElementById('navLinks');

// ===== GLOBAL HAMBURGER MENU (ALL DEVICES) =====
const globalMenuOverlay = document.getElementById('globalMenuOverlay');
const globalMenuClose = document.getElementById('globalMenuClose');

window.toggleGlobalMenu = function(forceOpen) {
    if (!globalMenuOverlay) return;
    const shouldOpen = (typeof forceOpen === 'boolean') ? forceOpen : !globalMenuOverlay.classList.contains('active');
    globalMenuOverlay.classList.toggle('active', shouldOpen);
    globalMenuOverlay.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
};

window.closeGlobalMenu = function() {
    window.toggleGlobalMenu(false);
};

if (globalMenuOverlay) {
    // Close when clicking outside the panel
    globalMenuOverlay.addEventListener('click', (e) => {
        if (e.target === globalMenuOverlay) window.closeGlobalMenu();
    });
    // Close on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') window.closeGlobalMenu();
    });
}
if (globalMenuClose) {
    globalMenuClose.addEventListener('click', window.closeGlobalMenu);
}
            
            if (mobileMenuBtn && navLinks) {
                
mobileMenuBtn.addEventListener('click', function() {
                    // On mobile, keep the original dropdown behavior
                    if (window.innerWidth <= 768) {
                        navLinks.classList.toggle('active');
                        return;
                    }
                    // On desktop/tablet, open the global overlay menu (doesn't change existing nav)
                    toggleGlobalMenu();
                });
            }
            
            // Load products data
            window.PRODUCTS_DATA = getLocalProductsData();
            
            // Initialize the app after Firebase is ready
            setTimeout(() => {
                initializeAppAfterFirebase();
            }, 1000);
        });

        // ===== GUARANTEED PRODUCT LOADING =====
        function getLocalProductsData() {
            return [
                // ===== 5 HOODIES =====
                {
                    id: 1,
                    name: "Urban Hoodie",
                    price: 450,
                    description: "Premium heavyweight hoodie with embroidered Drixel logo. Made from 80% cotton and 20% polyester for comfort and durability.",
                    category: "hoodies",
                    featured: true,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Charcoal", code: "#36454F" },
                        { name: "Red", code: "#FF0000" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/WhatsApp%20Image%202025-12-28%20at%2019.49.44.jpeg"
                },
                {
                    id: 2,
                    name: "Graphic Hoodie",
                    price: 450,
                    description: "Limited edition graphic print hoodie with unique streetwear design. Premium cotton blend for maximum comfort.",
                    category: "hoodies",
                    featured: true,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Charcoal", code: "#36454F" },
                        { name: "Red", code: "#FF0000" },
                        { name: "White", code: "#FFFFFF" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/IMG-20251228-WA0030.jpg?updatedAt=1768781642690"
                },
                {
                    id: 3,
                    name: "Oversized Hoodie",
                    price: 500,
                    description: "Modern oversized fit hoodie with dropped shoulders and kangaroo pocket. Perfect for relaxed streetwear style.",
                    category: "hoodies",
                    featured: false,
                    sizes: ["M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" },
                        { name: "Red", code: "#FF0000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/3_20260119_175001_0002.png?updatedAt=1769077707000"
                },
                {
                    id: 4,
                    name: "Hoodie",
                    price: 470,
                    description: "Hoodie with contrast details and adjustable hood. Made from premium French terry fabric.",
                    category: "hoodies",
                    featured: false,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Olive", code: "#808000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/11.png?updatedAt=1768781080420"
                },
                {
                    id: 5,
                    name: "Crop Hoodie",
                    price: 450,
                    description: "Contemporary crop hoodie with ribbed hem and cuffs. Perfect for layered streetwear looks.",
                    category: "hoodies",
                    featured: false,
                    sizes: ["XS", "S", "M", "L"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Pink", code: "#FFC0CB" },
                        { name: "Lavender", code: "#E6E6FA" },
                        { name: "White", code: "#FFFFFF" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/IMG-20260116-WA0089.jpg?updatedAt=1768781642074"
                },
                
                // ===== 5 SWEATERS =====
                {
                    id: 6,
                    name: "Premium Sweater",
                    price: 360,
                    description: "Comfortable and stylish sweater for casual streetwear looks. Perfect for different weather.",
                    category: "sweaters",
                    featured: true,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "Olive", code: "#808000" },
                        { name: "Black", code: "#111111" },
                        { name: "Red", code: "#FF0000" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/4_20260119_175002_0003.png?updatedAt=1769077707895"
                },
                {
                    id: 7,
                    name: "Turtleneck Sweater",
                    price: 360,
                    description: "Premium turtleneck sweater with ribbed details. Made from merino wool blend for warmth and comfort.",
                    category: "sweaters",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Cream", code: "#FFFDD0" },
                        { name: "Burgundy", code: "#800020" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/15.png?updatedAt=1768781089368"
                },
                {
                    id: 8,
                    name: "V-Neck Sweater",
                    price: 400,
                    description: "Classic V-neck sweater perfect for layering. Made from soft cotton blend for all-day comfort.",
                    category: "sweaters",
                    featured: false,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Navy", code: "#000080" },
                        { name: "Grey", code: "#808080" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Green", code: "#008000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/Brand%20Ambassador%20(2).jpg"
                },
                {
                    id: 9,
                    name: "Cable Knit Sweater",
                    price: 420,
                    description: "Traditional cable knit sweater with intricate patterns. Premium acrylic blend for durability.",
                    category: "sweaters",
                    featured: true,
                    sizes: ["M", "L", "XL"],
                    colors: [
                        { name: "Cream", code: "#FFFDD0" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" },
                        { name: "Red", code: "#FF0000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/1.jpg"
                },
                {
                    id: 10,
                    name: "Oversized Sweater",
                    price: 390,
                    description: "Modern oversized sweater with dropped shoulders. Perfect for relaxed, comfortable styling.",
                    category: "sweaters",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Pink", code: "#FFC0CB" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/2.jpg"
                },
                
                // ===== 5 BEANIES =====
                {
                    id: 11,
                    name: "Premium Beanie",
                    price: 75,
                    description: "Quality beanie with embroidered Drixel logo. Made from premium acrylic blend for warmth and comfort.",
                    category: "beanies",
                    featured: true,
                    sizes: ["One Size"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Charcoal", code: "#36454F" },
                        { name: "Red", code: "#FF0000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/26.jpg"
                },
                {
                    id: 12,
                    name: "Slouchy Beanie",
                    price: 75,
                    description: "Slouchy style beanie with extra length for a relaxed fit. Made from soft acrylic yarn.",
                    category: "beanies",
                    featured: false,
                    sizes: ["One Size"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" },
                        { name: "Red", code: "#FF0000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/5.jpg"
                },
                {
                    id: 13,
                    name: "Pom Pom Beanie",
                    price: 75,
                    description: "Cozy beanie with large pom pom detail. Perfect for winter weather with extra warmth.",
                    category: "beanies",
                    featured: false,
                    sizes: ["One Size"],
                    colors: [
                        { name: "Cream", code: "#FFFDD0" },
                        { name: "Grey", code: "#808080" },
                        { name: "Pink", code: "#FFC0CB" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/CHOSEN%20(3)/4.jpg"
                },
                {
                    id: 14,
                    name: "Cuffed Beanie",
                    price: 75,
                    description: "Classic cuffed beanie with ribbed texture. Made from premium wool blend.",
                    category: "beanies",
                    featured: false,
                    sizes: ["One Size"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Charcoal", code: "#36454F" },
                        { name: "Burgundy", code: "#800020" },
                        { name: "Green", code: "#008000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/27.jpg"
                },
                {
                    id: 15,
                    name: "Fisherman Beanie",
                    price: 75,
                    description: "Traditional fisherman style beanie with thick knit. Maximum warmth for cold days.",
                    category: "beanies",
                    featured: false,
                    sizes: ["One Size"],
                    colors: [
                        { name: "Navy", code: "#000080" },
                        { name: "Grey", code: "#808080" },
                        { name: "Cream", code: "#FFFDD0" },
                        { name: "Red", code: "#FF0000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/25.jpg"
                },
                
                // ===== 12 T-SHIRTS =====
                {
                    id: 16,
                    name: "T-Shirt (300gsm)",
                    price: 360,
                    description: "Heavyweight 300gsm premium cotton t-shirt. Maximum durability with premium feel.",
                    category: "tees",
                    featured: true,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Ash", code: "#B2BEB5" },
                        { name: "Black", code: "#111111" },
                        { name: "Red", code: "#FF0000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/WhatsApp%20Image%202025-12-28%20at%2019.49.45%20(1).jpeg"
                },
                {
                    id: 17,
                    name: "Heavyweight Graphic Tee (300gsm)",
                    price: 380,
                    description: "Heavyweight 300gsm t-shirt with screen printed graphic design. Premium cotton for superior quality.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/17.jpg"
                },
                {
                    id: 18,
                    name: "Premium Heavyweight Tee (300gsm)",
                    price: 370,
                    description: "Ultra-premium 300gsm t-shirt with reinforced stitching. Made from ring-spun cotton.",
                    category: "tees",
                    featured: false,
                    sizes: ["M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Black", code: "#111111" },
                        { name: "Olive", code: "#808000" },
                        { name: "Burgundy", code: "#800020" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/12.jpg"
                },
                {
                    id: 19,
                    name: "T-Shirt (250gsm)",
                    price: 300,
                    description: "Medium weight 250gsm premium cotton t-shirt. Better durability and good structure.",
                    category: "tees",
                    featured: true,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Ash", code: "#B2BEB5" },
                        { name: "Black", code: "#111111" },
                        { name: "Red", code: "#FF0000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/IMG-20260121-WA0008(1).jpg?updatedAt=1769077704605"
                },
                {
                    id: 20,
                    name: "Graphic Tee (250gsm)",
                    price: 320,
                    description: "250gsm t-shirt with vibrant screen print. Perfect balance of comfort and durability.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Black", code: "#111111" },
                        { name: "Red", code: "#FF0000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/15.jpg?updatedAt=1769081040089"
                },
                {
                    id: 21,
                    name: "Classic Crew (250gsm)",
                    price: 310,
                    description: "Classic crew neck t-shirt in 250gsm cotton. Ribbed collar for shape retention.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/21.jpg?updatedAt=1769081039729"
                },
                {
                    id: 22,
                    name: "T-Shirt (180gsm)",
                    price: 220,
                    description: "Lightweight 180gsm cotton t-shirt with screen-printed design. Great for everyday wear.",
                    category: "tees",
                    featured: true,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Ash", code: "#B2BEB5" },
                        { name: "Black", code: "#111111" },
                        { name: "Red", code: "#FF0000" },
                        { name: "Blue", code: "#0066CC" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/6.jpg?updatedAt=1769081039825"
                },
                {
                    id: 23,
                    name: "Lightweight Tee (180gsm)",
                    price: 230,
                    description: "Ultra-light 180gsm t-shirt perfect for summer. Made from breathable cotton.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Ash", code: "#B2BEB5" },
                        { name: "Pink", code: "#FFC0CB" },
                        { name: "Sky Blue", code: "#87CEEB" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/1_20260119_175001_0000.png?updatedAt=1769077707446"
                },
                {
                    id: 24,
                    name: "Basic Tee (180gsm)",
                    price: 210,
                    description: "Essential basic t-shirt in lightweight 180gsm cotton. Perfect for layering.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL", "XXL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/IMG-20260116-WA0082.jpg?updatedAt=1768781642064"
                },
                {
                    id: 25,
                    name: "Oversized Tee (250gsm)",
                    price: 330,
                    description: "Oversized fit t-shirt in 250gsm cotton. Modern streetwear silhouette.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "White", code: "#FFFFFF" },
                        { name: "Olive", code: "#808000" },
                        { name: "Red", code: "#FF0000" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/23.jpg"
                },
                {
                    id: 26,
                    name: "Vintage Wash Tee (300gsm)",
                    price: 390,
                    description: "Vintage wash t-shirt in heavyweight 300gsm cotton. Distressed details for authentic look.",
                    category: "tees",
                    featured: false,
                    sizes: ["M", "L", "XL"],
                    colors: [
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" },
                        { name: "Burgundy", code: "#800020" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/18.jpg"
                },
                {
                    id: 27,
                    name: "Long Sleeve Tee (180gsm)",
                    price: 280,
                    description: "Long sleeve t-shirt in lightweight 180gsm cotton. Perfect for transitional weather.",
                    category: "tees",
                    featured: false,
                    sizes: ["S", "M", "L", "XL"],
                    colors: [
                        { name: "White", code: "#FFFFFF" },
                        { name: "Black", code: "#111111" },
                        { name: "Grey", code: "#808080" },
                        { name: "Navy", code: "#000080" }
                    ],
                    image: "https://ik.imagekit.io/dpzepxtqs/22.jpg"
                }
            ];
        }

        // ===== PAGE NAVIGATION =====
        function showPage(page) {
            console.log('ðŸŒ Showing page:', page);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.add('hidden');
            });
            
            // Update nav links
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // Map page names to IDs
            let pageId = page + 'Page';
            const pageMap = {
                'terms': 'termsPage',
                'privacy': 'privacyPage',
                'refund': 'refundPage',
                'shipping': 'shippingPage',
                'yoco-direct': 'yocoDirectPage',
                'auth': 'authPage',
                'cart': 'cartPage',
                'checkout': 'checkoutPage',
                'product': 'productPage',
                'shop': 'shopPage',
                'home': 'homePage',
                'about': 'aboutPage',
                'contact': 'contactPage'
            };
            
            pageId = pageMap[page] || pageId;
            
            // Show the target page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                // Update active nav link
                document.querySelectorAll('.nav-links a').forEach(link => {
                    if (link.textContent.toLowerCase() === page.toLowerCase()) {
                        link.classList.add('active');
                    }
                });
                
                // Load content based on page
                if (page === 'cart') {
                    loadCartPage();
                } else if (page === 'checkout') {
                    loadCheckoutPage();
                } else if (page === 'shop') {
                    loadAllProducts();
                } else if (page === 'home') {
                    loadFeaturedProducts();
                } else if (page === 'yoco-direct') {
                    loadYocoProducts();
                } else if (page === 'auth') {
                    showAuthTab('login');
                }
            } else {
                console.error('âŒ Page not found:', pageId);
                document.getElementById('homePage').classList.remove('hidden');
            }
            
            // Close mobile menu
            const navLinksContainer = document.getElementById('navLinks');
            if (navLinksContainer) {
                navLinksContainer.classList.remove('active');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        window.showPage = showPage;

        function checkAuthAndNavigate(page) {
            const currentUser = window.currentFirebaseUser;

            // Allow everyone to browse products (Home/Shop/Product pages/Quick Buy page).
            // Only require login when the user tries to access the cart or checkout.
            if (!currentUser && (page === 'cart' || page === 'checkout')) {
                alert('Please login or create an account to continue. You need an account to add items to cart and place orders.');
                showPage('auth');
                return false;
            }

            showPage(page);
            return true;
        }

        // ===== AUTH FUNCTIONS =====
        function showAuthTab(tab) {
            console.log('ðŸ”„ Switching auth tab to:', tab);
            
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            document.querySelectorAll('.auth-form').forEach(f => {
                f.classList.remove('active');
                f.style.display = 'none';
            });
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else if (tab === 'register') {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
            
            // Clear messages
            const errorMessages = document.querySelectorAll('.error-message');
            const successMessages = document.querySelectorAll('.success-message');
            
            errorMessages.forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
            
            successMessages.forEach(msg => {
                msg.style.display = 'none';
                msg.textContent = '';
            });
        }

        async function firebaseRegister() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const registerError = document.getElementById('registerError');
            const registerSuccess = document.getElementById('registerSuccess');
            
            registerError.style.display = 'none';
            registerSuccess.style.display = 'none';
            
            if (!name || !email || !password || !confirmPassword) {
                registerError.textContent = 'Please fill in all required fields.';
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = 'Passwords do not match.';
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                registerError.textContent = 'Password must be at least 8 characters.';
                registerError.style.display = 'block';
                return;
            }
            
            try {
                const auth = window.firebaseAuth;
                const userCredential = await window.firebaseCreateUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const db = window.firebaseDb;
                await window.firebaseSetDoc(window.firebaseDoc(db, window.firebaseCollections.USERS, user.uid), {
                    uid: user.uid,
                    name: name,
                    email: email,
                    phone: phone || '',
                    role: email === ADMIN_EMAIL ? 'admin' : 'customer',
                    createdAt: new Date().toISOString(),
                    subscribed: document.getElementById('registerSubscription').checked,
                    emailVerified: false
                });
                
                registerSuccess.textContent = 'Account created successfully! You are now logged in.';
                registerSuccess.style.display = 'block';
                registerError.style.display = 'none';
                
                console.log("âœ… Firebase registration successful:", email);
                
                setTimeout(() => {
                    showPage('home');
                }, 1500);
                
            } catch (error) {
                console.error("âŒ Firebase registration error:", error);
                let errorMessage = 'Registration failed. ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Use at least 8 characters with uppercase, lowercase, and numbers.';
                        break;
                    default:
                        errorMessage += error.message || 'Please try again.';
                }
                
                registerError.textContent = errorMessage;
                registerError.style.display = 'block';
            }
        }
        // =====================
        // Google Login + SMS Multi-Factor Auth (MFA)
        // =====================
        function _mfaGetVerifier() {
            if (window._mfaRecaptchaVerifier) return window._mfaRecaptchaVerifier;

            const auth = window.firebaseAuth;
            const containerId = "mfa-recaptcha-container";

            // Ensure container exists
            if (!document.getElementById(containerId)) {
                const div = document.createElement("div");
                div.id = containerId;
                document.body.appendChild(div);
            }

            window._mfaRecaptchaVerifier = new window.firebaseRecaptchaVerifier(containerId, {
                size: "invisible"
            }, auth);

            return window._mfaRecaptchaVerifier;
        }

        async function _ensureSmsMfaEnrolled(user) {
            try {
                const mfaUser = window.firebaseMultiFactor(user);
                const enrolled = (mfaUser.enrolledFactors || []);
                if (enrolled.length > 0) return;

                const phoneNumber = prompt("Add SMS verification (Multi-Factor Authentication):\nEnter your phone number with country code.\nExample: +27XXXXXXXXX");
                if (!phoneNumber) return;

                const verifier = _mfaGetVerifier();
                const session = await mfaUser.getSession();

                const phoneAuthProvider = new window.firebasePhoneAuthProvider(window.firebaseAuth);
                const verificationId = await phoneAuthProvider.verifyPhoneNumber({ phoneNumber, session }, verifier);

                const code = prompt("Enter the SMS code you received:");
                if (!code) return;

                const cred = window.firebasePhoneAuthProvider.credential(verificationId, code);
                const assertion = window.firebasePhoneMultiFactorGenerator.assertion(cred);

                await mfaUser.enroll(assertion, "SMS");
                console.log("âœ… SMS MFA enrolled successfully.");
            } catch (e) {
                console.error("âŒ MFA enroll error:", e);
                alert("MFA enrollment failed (you can try again later).\n" + (e?.message || e));
            }
        }

        async function _handleMfaRequired(auth, error) {
            const code = error?.code || error?.errorCode;
            if (code !== "auth/multi-factor-auth-required") throw error;

            const resolver = window.firebaseGetMultiFactorResolver(auth, error);
            const hints = resolver.hints || [];
            if (hints.length === 0) throw new Error("MFA required but no second factor available.");

            const hint = hints[0];
            const verifier = _mfaGetVerifier();
            const phoneAuthProvider = new window.firebasePhoneAuthProvider(auth);

            const verificationId = await phoneAuthProvider.verifyPhoneNumber(
                { multiFactorHint: hint, session: resolver.session },
                verifier
            );

            const smsCode = prompt("Enter your SMS verification code:");
            if (!smsCode) throw new Error("SMS code required.");

            const cred = window.firebasePhoneAuthProvider.credential(verificationId, smsCode);
            const assertion = window.firebasePhoneMultiFactorGenerator.assertion(cred);

            return await resolver.resolveSignIn(assertion);
        }

        async function firebaseGoogleLogin() {
            const loginError = document.getElementById('loginError');
            const loginSuccess = document.getElementById('loginSuccess');
            if (loginError) loginError.style.display = 'none';
            if (loginSuccess) loginSuccess.style.display = 'none';

            try {
                const auth = window.firebaseAuth;

            // Prevent double-click / multiple popups
            if (window.__googleLoginInProgress) return;
            window.__googleLoginInProgress = true;

            const isMobile = window.matchMedia && window.matchMedia("(max-width: 768px)").matches;

                const Provider = window.firebaseGoogleAuthProvider;
                const provider = new Provider();

                let userCredential;

                // On mobile, popups are often blocked/cancelled. Use redirect.
                if (isMobile && window.firebaseSignInWithRedirect) {
                    if (loginSuccess) {
                        loginSuccess.textContent = 'Opening Google login...';
                        loginSuccess.style.display = 'block';
                    }
                    await window.firebaseSignInWithRedirect(auth, provider);
                    return; // flow continues after redirect
                }

                try {
                    userCredential = await window.firebaseSignInWithPopup(auth, provider);
                } catch (err) {
                    // If popup was cancelled/blocked or interrupted, fallback to redirect
                    const code = err?.code || '';
                    if ((code === 'auth/cancelled-popup-request' || code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user') 
                        && window.firebaseSignInWithRedirect) {
                        if (loginSuccess) {
                            loginSuccess.textContent = 'Opening Google login...';
                            loginSuccess.style.display = 'block';
                        }
                        await window.firebaseSignInWithRedirect(auth, provider);
                        return;
                    }
                    userCredential = await _handleMfaRequired(auth, err);
                }

                const user = userCredential.user;
                console.log("âœ… Google login successful:", user?.email);

                // Auto-enroll SMS MFA (only if not enrolled yet)
                try { await _ensureSmsMfaEnrolled(user); } catch(mfaErr) { console.warn('MFA enrollment skipped:', mfaErr); }

                if (loginSuccess) {
                    loginSuccess.textContent = 'Login successful! Redirecting...';
                    loginSuccess.style.display = 'block';
                }

                setTimeout(() => {
                    try { showPage('shop'); } catch(e) {}
                    try { closeModal('authModal'); } catch(e) {}
                }, 800);

            } catch (error) {
                console.error("âŒ Google login failed:", error);
                if (loginError) {
                    loginError.textContent = error?.message || "Google login failed. Please try again.";
                    loginError.style.display = 'block';
                } else {
                    alert(error?.message || "Google login failed.");
                }
            }
        }


        async function firebaseLogin() {
            console.log("ðŸ” firebaseLogin() called");
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');
            const loginSuccess = document.getElementById('loginSuccess');
            
            loginError.style.display = 'none';
            loginSuccess.style.display = 'none';
            
            if (!email || !password) {
                console.log("âŒ Validation failed");
                loginError.textContent = 'Please enter both email and password.';
                loginError.style.display = 'block';
                return;
            }
            
            try {
                console.log("ðŸ”„ Attempting Firebase login...");
                const auth = window.firebaseAuth;
                
                const userCredential = await window.firebaseSignInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                console.log("âœ… Firebase login successful for user:", user.email);
                
                const db = window.firebaseDb;
                const userRef = window.firebaseDoc(db, window.firebaseCollections.USERS, user.uid);
                const userDoc = await window.firebaseGetDoc(userRef);
                
                if (!userDoc.exists()) {
                    console.log("ðŸ“ Creating new user document in Firestore");
                    await window.firebaseSetDoc(userRef, {
                        uid: user.uid,
                        email: user.email,
                        name: user.email.split('@')[0],
                        createdAt: new Date().toISOString(),
                        role: email === ADMIN_EMAIL ? 'admin' : 'customer',
                        subscribed: document.getElementById('loginSubscription').checked
                    });
                } else {
                    await window.firebaseUpdateDoc(userRef, {
                        lastLogin: new Date().toISOString()
                    });
                }
                
                const userData = userDoc.exists() ? userDoc.data() : { role: email === ADMIN_EMAIL ? 'admin' : 'customer' };
                
                loginSuccess.textContent = 'Login successful!';
                loginSuccess.style.display = 'block';
                loginError.style.display = 'none';
                
                console.log("âœ… Firebase login completed successfully");
                
                if (email === ADMIN_EMAIL) {
                    console.log("ðŸ‘‘ Admin user detected, showing admin button");
                    setTimeout(() => {
                        showAdminButton();
                    }, 500);
                }
                
                setTimeout(() => {
                    console.log("ðŸ”„ Redirecting to home page...");
                    showPage('home');
                }, 1000);
                
            } catch (error) {
                console.error("âŒ Firebase login error:", error);
                
                let errorMessage = 'Login failed. ';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage += 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Incorrect password.';
                        break;
                    default:
                        errorMessage += error.message || 'Please check your credentials.';
                }
                
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            }
        }

        async function firebaseLogout() {
            try {
                const auth = window.firebaseAuth;
                await window.firebaseSignOut(auth);
                console.log("âœ… User logged out");
                window.currentFirebaseUser = null;
                cart = [];
                updateCartCount();
                updateAuthUI();
                showPage('home');
                
                const adminBtn = document.getElementById('adminMobileBtn');
                if (adminBtn) adminBtn.remove();
            } catch (error) {
                console.error("âŒ Logout error:", error);
            }
        }

        // ===== PASSWORD RESET =====
        async function resetPasswordFromLogin() {
            try {
                const emailInput = document.getElementById('loginEmail');
                const email = (emailInput?.value || '').trim();
                if (!email || !email.includes('@')) {
                    alert('Please enter your email address first, then click "Forgot password".');
                    return;
                }
                if (!window.firebaseAuth || !window.firebaseSendPasswordResetEmail) {
                    alert('Password reset is not available yet. Please refresh the page.');
                    return;
                }

                await window.firebaseSendPasswordResetEmail(window.firebaseAuth, email);
                alert('âœ… Password reset email sent! Please check your inbox (and spam).');
            } catch (err) {
                console.error('âŒ Password reset error:', err);
                alert('âŒ Could not send reset email: ' + (err?.message || err));
            }
        }



        function updateAuthUI() {
            const authLink = document.getElementById('authLink');
            const user = window.currentFirebaseUser;
            
            if (user) {
                console.log("ðŸ‘¤ User logged in:", user.email);
                
                const isAdmin = user.email === ADMIN_EMAIL;
                
                authLink.innerHTML = isAdmin ? `<i class="fas fa-crown"></i>` : `<i class="fas fa-sign-out-alt"></i>`;
                authLink.title = isAdmin ? `Admin: ${user.email} (Logout)` : `Logged in as ${user.email} (Logout)`;
                authLink.onclick = function(e) {
                    e.preventDefault();
                    firebaseLogout();
                };
                
                if (isAdmin) {
                    console.log("ðŸ‘‘ Admin detected, showing admin button");
                    setTimeout(() => {
                        showAdminButton();
                    }, 500);
                }
            } else {
                authLink.innerHTML = `<i class="fas fa-user"></i>`;
                authLink.title = "Login / Register";
                authLink.onclick = function(e) {
                    e.preventDefault();
                    showPage('auth');
                };
                
                const adminBtn = document.getElementById('adminMobileBtn');
                if (adminBtn) adminBtn.remove();
            }
        }

        // ===== YOCO SDK =====
        function loadYocoSDK() {
            console.log("ðŸ”„ Loading Yoco SDK...");
            
            const script = document.createElement('script');
            script.src = 'https://js.yoco.com/sdk/v1/yoco-sdk-web.js';
            
            script.onload = function() {
                console.log("âœ… Yoco SDK loaded");
                if (window.YocoSDK) {
                    try {
                        window.yocoSDK = new window.YocoSDK({
                            publicKey: YOCO_PUBLIC_KEY
                        });
                        console.log("âœ… Yoco SDK initialized");
                    } catch (error) {
                        console.error("âŒ Failed to initialize Yoco SDK:", error);
                    }
                }
            };
            
            script.onerror = function() {
                console.error("âŒ Failed to load Yoco SDK");
            };
            
            document.head.appendChild(script);
        }

        // ===== PRODUCT FUNCTIONS =====

        // ===== COLLECTIONS FILTER (Shop) =====
        window.currentCollectionFilter = 'all';

        function showCollectionComingSoon(label) {
            alert(label + " = Coming Soon");
        }

        function setCollectionFilter(filterKey) {
            window.currentCollectionFilter = filterKey || 'new';
            updateCollectionsBarActive(window.currentCollectionFilter);
            loadAllProducts(); // re-render with filter
        }

        function navigateToShopAndFilter(filterKey) {
            // Navigate first (keeps existing behavior intact), then apply filter on the Shop page
            try {
                showPage('shop');
            } catch (e) {
                // fallback if showPage isn't available for any reason
                if (typeof checkAuthAndNavigate === 'function') checkAuthAndNavigate('shop');
            }
            // Apply filter after navigation so products render correctly
            setTimeout(() => {
                try { setCollectionFilter(filterKey); } catch (e) {}
            }, 80);
        }


        function updateCollectionsBarActive(activeKey) {
            document.querySelectorAll('.collections-bar').forEach(bar => {
                bar.querySelectorAll('.collection-chip').forEach(btn => {
                    const key = btn.getAttribute('data-filter');
                    if (btn.classList.contains('disabled')) return;
                    btn.classList.toggle('active', key === activeKey);
                });
            });
        }

        function isApparelProduct(product) {
            const cat = String(product.category || '').toLowerCase();
            const name = String(product.name || '').toLowerCase();
            // Apparel = hoodies / tshirts / pants etc
            const apparelCats = ['hoodies','hoodie','tees','tee','tshirt','t-shirts','t-shirts','shirts','pants','trousers','shorts','sweatpants'];
            if (apparelCats.includes(cat)) return true;
            return /hoodie|tee|t-?shirt|shirt|pant|trouser|short/.test(name);
        }

        function isHeadwearProduct(product) {
            const cat = String(product.category || '').toLowerCase();
            const name = String(product.name || '').toLowerCase();
            const headwearCats = ['headwear','hats','hat','caps','cap','beanies','beanie'];
            if (headwearCats.includes(cat)) return true;
            return /hat|cap|beanie/.test(name);
        }

        function getFilteredProducts(filterKey) {
            const list = Array.isArray(window.PRODUCTS_DATA) ? window.PRODUCTS_DATA.slice() : [];
            if (filterKey === 'all') {
                // Default: keep original order (exactly as loaded)
                return list;
            }
            if (filterKey === 'new') {
                // New Arrivals = newest items (highest IDs)
                return list.sort((a,b) => (b.id || 0) - (a.id || 0));
            }
            if (filterKey === 'apparel') {
                return list.filter(isApparelProduct).sort((a,b) => (b.id || 0) - (a.id || 0));
            }
            if (filterKey === 'headwear') {
                return list.filter(isHeadwearProduct).sort((a,b) => (b.id || 0) - (a.id || 0));
            }
            return list;
        }

        function loadFeaturedProducts() {
            const featuredContainer = document.getElementById('featuredProducts');
            if (!featuredContainer) return;
            
            featuredContainer.innerHTML = '';
            
            let featuredProducts = window.PRODUCTS_DATA.filter(product => product.featured);
            if (!featuredProducts.length) featuredProducts = window.PRODUCTS_DATA.slice(0, 8);

            featuredProducts.forEach(product => {
                const productCard = createProductCard(product);
                featuredContainer.appendChild(productCard);
            });
        }

        function loadAllProducts() {
            const productsContainer = document.getElementById('allProducts');
            if (!productsContainer) return;

            productsContainer.innerHTML = '';

            const filterKey = window.currentCollectionFilter || 'all';
            const productsToShow = getFilteredProducts(filterKey);

            productsToShow.forEach(product => {
                const productCard = createProductCard(product);
                productsContainer.appendChild(productCard);
            });
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const showFreeDelivery = product.price >= FREE_DELIVERY_THRESHOLD;
            
            const productKey = `product_${product.id}`;
            const selections = productSelections[productKey] || {
                size: product.sizes[0],
                color: product.colors[0]
            };
            
            card.innerHTML = `
                ${showFreeDelivery ? '<div class="delivery-badge free-delivery"><i class="fas fa-shipping-fast"></i> Free Delivery</div>' : ''}
                <div class="product-badge">NEW</div>
                <div class="product-image">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='${SNAPSCAN_QR_URL}'">
                </div>
                <div class="product-info">
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-price">R ${product.price.toFixed(2)}</div>
                    
                    <div class="size-selection">
                        <h4>SIZE</h4>
                        <div class="size-options">
                            ${product.sizes.map(size => `
                                <button class="size-option ${selections.size === size ? 'selected' : ''}" 
                                        data-size="${size}"
                                        onclick="selectSize(${product.id}, '${size}', this)">
                                    ${size}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="color-selection">
                        <h4>COLOR</h4>
                        <div class="color-options">
                            ${product.colors.map(color => `
                                <button class="color-option ${selections.color.name === color.name ? 'selected' : ''}"
                                        data-color="${color.name}"
                                        style="background-color: ${color.code}"
                                        onclick="selectColor(${product.id}, '${color.name}', '${color.code}', this)">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button class="btn" onclick="addToCart(${product.id})">Add to Cart</button>
                    
                    <button class="buy-btn mt-10" onclick="initiateYocoDirectPayment(${product.id}, '${product.name}', ${product.price})">
                        <i class="fas fa-bolt"></i> Quick Buy
                    </button>
                </div>
            `;
            
            card.addEventListener('click', function(e) {
                if (!e.target.closest('.btn') && !e.target.closest('.size-option') && 
                    !e.target.closest('.color-option') && !e.target.closest('.buy-btn')) {
                    viewProduct(product.id);
                }
            });
            
            return card;
        }

        function selectSize(productId, size, button) {
            const productKey = `product_${productId}`;
            if (!productSelections[productKey]) {
                productSelections[productKey] = {};
            }
            productSelections[productKey].size = size;
            
            const parent = button.parentElement;
            parent.querySelectorAll('.size-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            localStorage.setItem('drixel_selections', JSON.stringify(productSelections));
        }

        function selectColor(productId, colorName, colorCode, button) {
            const productKey = `product_${productId}`;
            if (!productSelections[productKey]) {
                productSelections[productKey] = {};
            }
            productSelections[productKey].color = { name: colorName, code: colorCode };
            
            const parent = button.parentElement;
            parent.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            localStorage.setItem('drixel_selections', JSON.stringify(productSelections));
        }

        function viewProduct(productId) {
            const product = window.PRODUCTS_DATA.find(p => p.id === productId);
            if (!product) return;
            
            const productKey = `product_${productId}`;
            const selections = productSelections[productKey] || {
                size: product.sizes[0],
                color: product.colors[0]
            };
            
            const productDetail = document.getElementById('productDetail');
            if (!productDetail) return;
            
            productDetail.innerHTML = `
                <div class="product-detail">
                    <div class="product-gallery">
                        <div class="main-image">
                            <img src="${product.image}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/600x800?text=Drixel+SA'">
                        </div>
                        <div class="thumbnails">
                            <div class="thumbnail active">
                                <img src="${product.image}" alt="${product.name}">
                            </div>
                            ${product.colors.map(color => `
                                <div class="thumbnail" onclick="changeProductColor('${color.code}', '${product.name}')">
                                    <div style="width: 100%; height: 100%; background-color: ${color.code};"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="product-info">
                        <h1>${product.name}</h1>
                        <div class="product-price">R ${product.price.toFixed(2)}</div>
                        
                        <div class="product-description">
                            <p>${product.description}</p>
                        </div>
                        
                        <div class="size-selection">
                            <h4>SELECT SIZE</h4>
                            <div class="size-options">
                                ${product.sizes.map(size => `
                                    <button class="size-option ${selections.size === size ? 'selected' : ''}" 
                                            data-size="${size}"
                                            onclick="selectSize(${product.id}, '${size}', this)">
                                        ${size}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="color-selection">
                            <h4>SELECT COLOR</h4>
                            <div class="color-options">
                                ${product.colors.map(color => `
                                    <button class="color-option ${selections.color.name === color.name ? 'selected' : ''}"
                                            data-color="${color.name}"
                                            style="background-color: ${color.code}"
                                            onclick="selectColor(${product.id}, '${color.name}', '${color.code}', this)">
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="product-actions">
                            <div class="quantity-selector">
                                <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                                <input type="text" class="quantity-input" id="productQuantity" value="1" readonly>
                                <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                            </div>
                            <button class="btn" onclick="addToCart(${product.id}, true)">Add to Cart</button>
                        </div>
                        
                        <button class="buy-btn" onclick="initiateYocoDirectPayment(${product.id}, '${product.name}', ${product.price})">
                            <i class="fas fa-bolt"></i> Quick Buy with Yoco
                        </button>
                        
                        <div class="timeline">
                            <h4><i class="fas fa-clock"></i> Order Processing Timeline</h4>
                            <div class="timeline-item">
                                <div class="timeline-icon"><i class="fas fa-1"></i></div>
                                <div class="timeline-content">
                                    <strong>Order Processing:</strong> 1-3 days (due to high demand)
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-icon"><i class="fas fa-2"></i></div>
                                <div class="timeline-content">
                                    <strong>Production:</strong> Additional 2-5 days if item needs manufacturing
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-icon"><i class="fas fa-3"></i></div>
                                <div class="timeline-content">
                                    <strong>Delivery:</strong> 3-5 business days via The Courier Guy or PAXI
                                </div>
                            </div>
                        </div>
                        
                        <div class="email-notification">
                            <p><i class="fas fa-envelope-open-text"></i> <strong>Automatic Email Updates:</strong> After purchase, you'll receive order confirmation, processing updates, and delivery notifications from <strong>drixelsa@gmail.com</strong></p>
                        </div>
                    </div>
                </div>
            `;
            
            showPage('product');
        }

        function changeProductColor(colorCode, productName) {
            console.log(`Changing ${productName} color to ${colorCode}`);
        }

        function decreaseQuantity() {
            const quantityInput = document.getElementById('productQuantity');
            let quantity = parseInt(quantityInput.value) || 1;
            if (quantity > 1) {
                quantityInput.value = quantity - 1;
            }
        }

        function increaseQuantity() {
            const quantityInput = document.getElementById('productQuantity');
            let quantity = parseInt(quantityInput.value) || 1;
            quantityInput.value = quantity + 1;
        }

        // ===== CART FUNCTIONS =====
        async function addToCart(productId, fromProductPage = false) {
            const currentUser = window.currentFirebaseUser;
            if (!currentUser) {
                alert('Please login or create an account to add items to your cart. You need an account to shop with us.');
                showPage('auth');
                return;
            }
            
            const product = window.PRODUCTS_DATA.find(p => p.id === productId);
            if (!product) return;
            
            const productKey = `product_${productId}`;
            const selections = productSelections[productKey] || {
                size: product.sizes[0],
                color: product.colors[0]
            };
            
            if (!selections.size || !selections.color) {
                alert('Please select both size and color before adding to cart.');
                return;
            }
            
            let quantity = 1;
            if (fromProductPage) {
                const quantityInput = document.getElementById('productQuantity');
                if (quantityInput) {
                    quantity = parseInt(quantityInput.value) || 1;
                }
            }
            
            const existingItemIndex = cart.findIndex(item => 
                item.id === productId && 
                item.size === selections.size && 
                item.color === selections.color.name
            );
            
            if (existingItemIndex !== -1) {
                cart[existingItemIndex].quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    size: selections.size,
                    color: selections.color.name,
                    colorCode: selections.color.code,
                    quantity: quantity,
                    addedAt: new Date().toISOString()
                });
            }
            
            updateCartCount();
            
            alert(`${product.name} (${selections.size}, ${selections.color.name}) added to cart!`);
            
            if (fromProductPage && confirm('Go to cart?')) {
                showPage('cart');
            }
        }

        function loadCartPage() {
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            if (!cartItemsContainer) return;
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-bag"></i>
                        <h2>Your cart is empty</h2>
                        <p>Add some products to your cart and they'll appear here.</p>
                        <a href="#" class="btn" onclick="showPage('shop'); return false;">Browse Products</a>
                        <div class="buy-btn-container mt-40">
                            <a href="#" onclick="showPage('yoco-direct'); return false;">
                                <button class="buy-btn" style="background: transparent; border: 2px solid var(--accent-orange); color: var(--accent-orange);">
                                    <i class="fas fa-bolt"></i> Quick Checkout with Yoco
                                </button>
                            </a>
                        </div>
                    </div>
                `;
                updateCartSummary(0);
                return;
            }
            
            let html = '<div class="cart-items">';
            
            cart.forEach((item, index) => {
                html += `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            <img src="${item.image}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/120x120?text=Drixel+SA'">
                        </div>
                        <div class="cart-item-details">
                            <h4>${item.name}</h4>
                            <div class="cart-item-variants">
                                <span>Size: ${item.size}</span>
                                <span>Color: ${item.color}</span>
                                <div class="cart-item-color" style="background-color: ${item.colorCode};"></div>
                            </div>
                            <div class="cart-item-actions">
                                <button onclick="updateCartItemQuantity(${index}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateCartItemQuantity(${index}, ${item.quantity + 1})">+</button>
                                <span class="cart-item-remove" onclick="removeFromCart(${index})">Remove</span>
                            </div>
                        </div>
                        <div class="cart-item-price">R ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            cartItemsContainer.innerHTML = html;
            
            updateCartSummary();
        }

        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                removeFromCart(index);
                return;
            }
            
            cart[index].quantity = newQuantity;
            updateCartCount();
            loadCartPage();
        }

        function removeFromCart(index) {
            if (confirm('Remove this item from cart?')) {
                cart.splice(index, 1);
                updateCartCount();
                loadCartPage();
            }
        }

        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
        }

        function updateCartSummary() {
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = calculateDeliveryFee(subtotal);
            const tax = 0;
            const total = subtotal + shipping + tax;
            
            document.getElementById('cartSubtotal').textContent = `R ${subtotal.toFixed(2)}`;
            document.getElementById('cartShipping').textContent = `R ${shipping.toFixed(2)}`;
            document.getElementById('cartTax').textContent = `R ${tax.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `R ${total.toFixed(2)}`;
            
            const shippingNote = document.getElementById('shippingNote');
            if (shipping === 0) {
                shippingNote.textContent = 'ðŸŽ‰ Free delivery on orders over R1000!';
            } else {
                shippingNote.textContent = `Add R${(FREE_DELIVERY_THRESHOLD - subtotal).toFixed(2)} more for free delivery!`;
            }
        }

        function calculateDeliveryFee(subtotal) {
            if (subtotal >= FREE_DELIVERY_THRESHOLD) {
                return 0;
            }
            return DELIVERY_FEE;
        }

        // ===== YOCO DIRECT BUY PAGE =====
        function loadYocoProducts() {
            const yocoGrid = document.getElementById('yocoProductsGrid');
            if (!yocoGrid) return;
            
            yocoGrid.innerHTML = '';
            
            window.PRODUCTS_DATA.forEach(product => {
                const productKey = `product_${product.id}`;
                const selections = productSelections[productKey] || {
                    size: product.sizes[0],
                    color: product.colors[0]
                };
                
                const yocoProduct = document.createElement('div');
                yocoProduct.className = 'yoco-product';
                
                yocoProduct.innerHTML = `
                    <div class="yoco-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h3>${product.name}</h3>
                    <div class="yoco-price">R ${product.price.toFixed(2)}</div>
                    <p class="yoco-description">${product.description}</p>
                    
                    <div class="size-selection">
                        <h4>SIZE</h4>
                        <div class="size-options">
                            ${product.sizes.map(size => `
                                <button class="size-option ${selections.size === size ? 'selected' : ''}" 
                                        data-size="${size}"
                                        onclick="selectSize(${product.id}, '${size}', this)">
                                    ${size}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="color-selection">
                        <h4>COLOR</h4>
                        <div class="color-options">
                            ${product.colors.map(color => `
                                <button class="color-option ${selections.color.name === color.name ? 'selected' : ''}"
                                        data-color="${color.name}"
                                        style="background-color: ${color.code}"
                                        onclick="selectColor(${product.id}, '${color.name}', '${color.code}', this)">
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button class="buy-btn" onclick="initiateYocoDirectPayment(${product.id}, '${product.name}', ${product.price})">
                        <i class="fas fa-bolt"></i> Quick Buy with Yoco
                    </button>
                    
                    <div class="email-notification mt-20">
                        <p><i class="fas fa-envelope"></i> You'll receive order confirmation from drixelsa@gmail.com</p>
                    </div>
                `;
                
                yocoGrid.appendChild(yocoProduct);
            });
        }

        // ===== CHECKOUT FUNCTIONS =====
        function loadCheckoutPage() {
            const checkoutSummary = document.getElementById('checkoutSummary');
            if (!checkoutSummary) return;
            
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = calculateDeliveryFee(subtotal);
            const tax = 0;
            const total = subtotal + shipping + tax;
            
            let html = '';
            cart.forEach(item => {
                html += `
                    <div class="order-summary-item">
                        <span>${item.name} (${item.size}, ${item.color}) x${item.quantity}</span>
                        <span>R ${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });
            
            html += `
                <div class="order-summary-item">
                    <span>Subtotal</span>
                    <span>R ${subtotal.toFixed(2)}</span>
                </div>
                <div class="order-summary-item">
                    <span>Delivery Fee</span>
                    <span>R ${shipping.toFixed(2)}</span>
                </div>
                <div class="order-summary-item">
                    <span>Tax (0% VAT)</span>
                    <span>R ${tax.toFixed(2)}</span>
                </div>
            `;
            
            checkoutSummary.innerHTML = html;
            document.getElementById('checkoutTotal').textContent = `R ${total.toFixed(2)}`;
            
            const shippingNote = document.getElementById('checkoutShippingNote');
            if (shipping === 0) {
                shippingNote.textContent = 'ðŸŽ‰ Free delivery applied!';
            } else {
                shippingNote.textContent = `Add R${(FREE_DELIVERY_THRESHOLD - subtotal).toFixed(2)} more for free delivery!`;
            }
            
            setupPaymentMethodToggle();
        }

        function setupPaymentMethodToggle() {
            const payBank = document.getElementById('payBank');
            const payYoco = document.getElementById('payYoco');
            const paySnapScan = document.getElementById('paySnapScan');
            const bankInfo = document.getElementById('bankTransferInfo');
            const yocoInfo = document.getElementById('yocoPaymentInfo');
            const snapScanInfo = document.getElementById('snapScanInfo');
            
            if (!payBank || !payYoco || !paySnapScan) return;
            
            payBank.addEventListener('change', function() {
                if (this.checked) {
                    bankInfo.style.display = 'block';
                    yocoInfo.style.display = 'none';
                    snapScanInfo.style.display = 'none';
                }
            });
            
            payYoco.addEventListener('change', function() {
                if (this.checked) {
                    bankInfo.style.display = 'none';
                    yocoInfo.style.display = 'block';
                    snapScanInfo.style.display = 'none';
                }
            });
            
            paySnapScan.addEventListener('change', function() {
                if (this.checked) {
                    bankInfo.style.display = 'none';
                    yocoInfo.style.display = 'none';
                    snapScanInfo.style.display = 'block';
                    
                    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                    const shipping = calculateDeliveryFee(subtotal);
                    const tax = 0;
                    const total = subtotal + shipping + tax;
                    
                    const reference = generateSnapScanReference();
                    
                    document.getElementById('snapScanAmount').textContent = 'R ' + total.toFixed(2);
                    document.getElementById('snapScanReference').textContent = reference;
                    
                    generateSnapScanQRCode(total, reference);
                    
                    currentSnapScanOrder = {
                        reference: reference,
                        amount: total,
                        timestamp: new Date().toISOString(),
                        cartItems: [...cart]
                    };
                    
                    console.log("âœ… SnapScan order initialized:", reference, "Amount: R" + total.toFixed(2));
                }
            });
        }

        function generateSnapScanQRCode(amount, reference) {
            const qrContainer = document.getElementById('snapScanQRCode');
            if (!qrContainer) return;
            
            qrContainer.innerHTML = '';
            
            const snapScanLink = `${SNAPSCAN_QR_URL}?amount=${amount}&reference=${reference}`;
            
            

            // Update the 'Click here to pay' link under the QR (opens SnapScan in a new tab)
            const clickPayLinkEl = document.getElementById('snapScanClickPayLink');
            if (clickPayLinkEl) clickPayLinkEl.href = snapScanLink;

            attachSnapScanClickPayHandler();

            // Show the amount under the link (optional)
            const clickPayAmountEl = document.getElementById('snapScanClickPayAmount');
            if (clickPayAmountEl) {
                const amtNum = Number(amount);
                if (!Number.isNaN(amtNum) && amtNum > 0) {
                    clickPayAmountEl.textContent = `Total: R${amtNum.toFixed(2)}`;
                } else {
                    clickPayAmountEl.textContent = '';
                }
            }
console.log("ðŸ”— SnapScan Link:", snapScanLink);
            
            try {
                const qrCode = new QRCode(qrContainer, {
                    text: snapScanLink,
                    width: 250,
                    height: 250,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                console.log("âœ… QR Code generated successfully");
                
                setTimeout(() => {
                    const canvas = qrContainer.querySelector('canvas');
                    if (canvas) {
                        canvas.style.cursor = 'pointer';
                        canvas.title = 'Click to open SnapScan link';
                        canvas.addEventListener('click', function() {
                            window.open(snapScanLink, '_blank');
                        });
                    }
                }, 100);
                
            } catch (error) {
                console.error("âŒ QR Code generation error:", error);
                qrContainer.innerHTML = `
                    <div style="text-align: center; color: #ff0000;">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <p>QR Code generation failed</p>
                        <p style="font-size: 12px;">Please use this link:</p>
                        <a href="${snapScanLink}" target="_blank" style="color: #0096FF; font-size: 12px;">
                            ${snapScanLink.substring(0, 50)}...
                        </a>
                    </div>
                `;
            }
        }

        
        function attachSnapScanClickPayHandler() {
            const el = document.getElementById('snapScanClickPayLink');
            if (!el) return;
            if (el.dataset.bound === '1') return;
            el.dataset.bound = '1';
            el.addEventListener('click', function(ev) {
                try {
                    // Ensure we have a SnapScan order prepared
                    if (!window.currentSnapScanOrder) {
                        // Try to build from checkout totals if available
                        const totalEl = document.getElementById('orderTotal');
                        const total = totalEl ? Number(String(totalEl.textContent).replace(/[^0-9.]/g,'')) : null;
                        const ref = generateSnapScanReference();
                        if (total && !Number.isNaN(total)) {
                            window.currentSnapScanOrder = { amount: total, reference: ref };
                        }
                    }
                    if (window.currentSnapScanOrder) {
                        storePendingSnapScan(window.currentSnapScanOrder);
                    }
                } catch(_) {}
                // open in same tab so back button returns to checkout
                try { el.target = '_self'; } catch(_) {}
            });
        }

function generateSnapScanReference() {
            const randomNum = Math.floor(Math.random() * 9000) + 1000;
            return `DRIX${randomNum}`;
        }

        function copySnapScanReference() {
            const reference = document.getElementById('snapScanReference').textContent;
            const copyBtn = document.getElementById('copyRefBtn');
            
            if (reference === 'Loading...' || !reference) {
                alert('Reference number is not ready yet. Please wait.');
                return;
            }
            
            navigator.clipboard.writeText(reference).then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.classList.add('copy-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
                
            }).catch(err => {
                console.error('Failed to copy: ', err);
                const textArea = document.createElement('textarea');
                textArea.value = reference;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        async function confirmSnapScanPayment(skipConfirm = false) {
            if (!currentSnapScanOrder) {
                alert('No SnapScan order found. Please select SnapScan payment method first.');
                return;
            }
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const postalCode = document.getElementById('postalCode').value;
            const province = document.getElementById('province').value;
            
            if (!firstName || !lastName || !email || !phone || !address || !city || !postalCode || !province) {
                alert('Please fill in all required shipping information before confirming payment.');
                return;
            }
            
            const confirmPayment = skipConfirm ? true : confirm(`Have you completed the payment of R${currentSnapScanOrder.amount.toFixed(2)} using SnapScan?

Reference: ${currentSnapScanOrder.reference}

Click OK to confirm your payment.`);
            if (confirmPayment) {
                try {
                    console.log("âœ… Processing SnapScan payment confirmation...");
                    
                    const orderNumber = generateOrderNumber();
                    const subscribed = document.getElementById('newsletterSubscription').checked;
                    
                    const orderData = {
                        order_id: orderNumber,
                        orderNumber: orderNumber,
                        customer: {
                            name: `${firstName} ${lastName}`,
                            email: email,
                            phone: phone,
                            address: address,
                            city: city,
                            postalCode: postalCode,
                            province: province
                        },
                        items: [...cart],
                        subtotal: cart.reduce((total, item) => total + (item.price * item.quantity), 0),
                        shipping: calculateDeliveryFee(cart.reduce((total, item) => total + (item.price * item.quantity), 0)),
                        tax: 0,
                        total: currentSnapScanOrder.amount,
                        paymentMethod: 'snapscan',
                        paymentStatus: 'pending_verification',
                        paymentReference: currentSnapScanOrder.reference,
                        subscribed: subscribed,
                        status: 'processing',
                        deliveryMethod: 'The Courier Guy / PAXI',
                        processingTime: '1-3 days',
                        deliveryTime: '3-5 business days',
                        userId: window.currentFirebaseUser ? window.currentFirebaseUser.uid : 'anonymous',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    console.log("ðŸ“¦ Order data:", orderData);
                    
                    const db = window.firebaseDb;
                    if (!db) {
                        throw new Error("Firebase database not available");
                    }
                    
                    console.log("ðŸ’¾ Saving order to Firebase...");
                    const orderRef = await window.firebaseAddDoc(window.firebaseCollection(db, 'orders'), orderData);
                    console.log("âœ… Order saved with ID:", orderRef.id);
                    
                    
                    // Store Firestore document ID for 'View my order' link
                    orderData.orderDocId = orderRef.id;
cart = [];
                    updateCartCount();
                    
                    // Send Order Confirmation email for SnapScan (non-bank)
                    await sendOrderConfirmationEmail(orderData);
                    
                    document.getElementById('orderNumber').textContent =orderNumber;
                    const deliveryFeeInfo = document.getElementById('deliveryFeeInfo');
                    if (orderData.shipping === 0) {
                        deliveryFeeInfo.textContent = 'Delivery: FREE (Order over R1000)';
                    } else {
                        deliveryFeeInfo.textContent = `Delivery Fee: R${orderData.shipping.toFixed(2)}`;
                    }
                    
                    alert(`âœ… Payment confirmed!\n\nOrder #${orderNumber} has been created.\nA confirmation email has been sent to ${email}.`);
                    
                    showPage('orderConfirmation');
                    
                } catch (error) {
                    console.error("âŒ Error processing SnapScan payment:", error);
                    alert('There was an error processing your payment. Please try again or contact support.');
                }
            }
        }

        function generateOrderNumber() {
            const randomNum = Math.floor(Math.random() * 9000) + 1000;
            return `DRIX${randomNum}`;
        }

        // ===== PLACE ORDER FUNCTION =====
        async function placeOrder() {
            console.log("ðŸ”„ placeOrder() called");
            // Get form data
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const postalCode = document.getElementById('postalCode').value;
            const province = document.getElementById('province').value;
            
            // Validate form
            if (!firstName || !lastName || !email || !phone || !address || !city || !postalCode || !province) {
                alert('Please fill in all required shipping information.');
                return;
            }
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Get payment method
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            if (!paymentMethod) {
                alert('Please select a payment method.');
                return;
            }
            
            // Check if cart is empty
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items to your cart before placing an order.');
                return;
            }
            
            // Calculate order totals
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = calculateDeliveryFee(subtotal);
            const tax = 0;
            const total = subtotal + shipping + tax;
            
            // Get subscription preference
            const subscribed = document.getElementById('newsletterSubscription').checked;
            
            // Generate order number
            const orderNumber = generateOrderNumber();
            
            // Create order data
            const orderData = {
                order_id: orderNumber,
                        orderNumber: orderNumber,
                customer: {
                    name: `${firstName} ${lastName}`,
                    email: email,
                    phone: phone,
                    address: address,
                    city: city,
                    postalCode: postalCode,
                    province: province
                },
                items: [...cart], // Copy cart items
                subtotal: subtotal,
                shipping: shipping,
                tax: tax,
                total: total,
                paymentMethod: paymentMethod,
                paymentStatus: paymentMethod === 'bank' ? 'pending' : 
                            paymentMethod === 'yoco' ? 'paid' : 
                            paymentMethod === 'snapscan' ? 'pending_verification' : 'pending',
                subscribed: subscribed,
                status: 'processing',
                deliveryMethod: 'The Courier Guy / PAXI',
                processingTime: '1-3 days',
                deliveryTime: '3-5 business days',
                userId: window.currentFirebaseUser ? window.currentFirebaseUser.uid : 'anonymous',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            console.log("ðŸ“¦ Order data prepared:", orderData);
            
            try {
                // Save order to Firebase
                const orderId = await saveOrderToFirebase(orderData);
                
                
                // Store Firestore document ID for 'View my order' link
                orderData.orderDocId = orderId;
// Send appropriate emails based on payment method
                if (paymentMethod === 'bank') {
                    // For bank transfer, send ORDER RECEIVED (payment pending)
                    await sendOrderConfirmationEmail(orderData);
                    
                    alert(`âœ… Order placed successfully!\n\nOrder #${orderNumber}\n\nPayment Details:\nBank: Standard Bank\nAccount: 071337873\nReference: ${orderNumber}\n\nPlease make payment and your order will be processed.`);
                    
                } else if (paymentMethod === 'yoco') {
                    // Yoco Hosted Checkout (server-side via /api/yoco/create-checkout)
                    // For Yoco, initiate payment first
                    const description = `Drixel SA Order #${orderNumber}`;
                    const metadata = {
                        order_id: orderNumber,
                        orderNumber: orderNumber,
                        type: 'checkout',
                        cart: cart.length,
                        orderNumber: orderNumber
                    };
                    
                    const customer = {
                        name: `${firstName} ${lastName}`,
                        email: email,
                        phone: phone
                    };
                    
                    // Store order data temporarily for after payment
                    window.pendingOrderData = orderData;
                    window.pendingOrderData.orderId = orderId;
                    
                    // Show Yoco payment modal
                    showYocoPaymentModal(total, description, metadata, customer);
                    return; // Don't clear cart yet
                    
                } else if (paymentMethod === 'snapscan') {
                    // For SnapScan, we already have the payment flow
                    alert('Please complete the SnapScan payment using the QR code or reference number, then click "I\'ve Paid with SnapScan" to confirm your payment.');
                    return; // Don't clear cart yet
                }
                
                // Clear cart for bank transfers
                cart = [];
                updateCartCount();
                
                // Show order confirmation page
                document.getElementById('orderNumber').textContent = orderNumber;
                const deliveryFeeInfo = document.getElementById('deliveryFeeInfo');
                if (orderData.shipping === 0) {
                    deliveryFeeInfo.textContent = 'Delivery: FREE (Order over R1000)';
                } else {
                    deliveryFeeInfo.textContent = `Delivery Fee: R${orderData.shipping.toFixed(2)}`;
                }
                showPage('orderConfirmation');
                
            } catch (error) {
                console.error("âŒ Error placing order:", error);
                alert('There was an error processing your order. Please try again.');
            }
        }

        async function saveOrderToFirebase(orderData) {
            try {
const db = window.firebaseDb;
                if (!db) {
                    throw new Error("Firebase database not available");
                }
                
                console.log("ðŸ’¾ Saving order to Firebase...");
                const orderRef = await window.firebaseAddDoc(window.firebaseCollection(db, 'orders'), orderData);
                console.log("âœ… Order saved with ID:", orderRef.id);
                
                
                    // Store Firestore document ID for 'View my order' link
                    orderData.orderDocId = orderRef.id;
return orderRef.id;
            } catch (error) {
                console.error("âŒ Error saving order to Firebase:", error);
                throw error;
            }
        }

        
        // ===== INSTANT PAYMENT UX HELPERS =====
        function showPayOverlay(msg) {
            const el = document.getElementById('payOverlay');
            const title = document.getElementById('payOverlayTitle');
            if (!el) return;
            if (title && msg) title.textContent = msg;
            el.style.display = 'flex';
        }
        function hidePayOverlay() {
            const el = document.getElementById('payOverlay');
            if (!el) return;
            el.style.display = 'none';
        }
        function disableEl(el, disabled) {
            if (!el) return;
            try {
                el.disabled = !!disabled;
                el.style.opacity = disabled ? '0.7' : '';
                el.style.pointerEvents = disabled ? 'none' : '';
            } catch(_) {}
        }
        function warmPaymentServer() {
            try {
                // no-cors so it never blocks your UI; this helps wake Render faster
                fetch(PAYMENT_SERVER_BASE, { mode: 'no-cors', cache: 'no-store' }).catch(()=>{});
            } catch(_) {}
        }


        
        // ===== SNAPSCAN QUICK PAY FLOW (AUTO FINALISE ON RETURN) =====
        function getCurrentPageUrl() {
            try {
                const u = new URL(window.location.href);
                // Remove any old payment flags
                u.searchParams.delete('yoco');
                u.searchParams.delete('snapscan');
                u.searchParams.delete('paid');
                return u.toString();
            } catch (_) {
                return window.location.href;
            }
        }

        function storePendingSnapScan(order) {
            try {
                localStorage.setItem('drixel_pending_snapscan', JSON.stringify({
                    ...order,
                    ts: Date.now()
                }));
            } catch(_) {}
        }

        function readPendingSnapScan() {
            try {
                const raw = localStorage.getItem('drixel_pending_snapscan');
                return raw ? JSON.parse(raw) : null;
            } catch(_) { return null; }
        }

        function clearPendingSnapScan() {
            try { localStorage.removeItem('drixel_pending_snapscan'); } catch(_) {}
        }

        async function autoFinalizeSnapScanIfNeeded() {
            const pending = readPendingSnapScan();
            if (!pending) return;

            // Only attempt if cart still matches or if user is on checkout page.
            // We purposely do NOT require a SnapScan redirect (SnapScan doesn't guarantee one);
            // returning to the tab is treated as "payment completed" per your requirement.
            try {
                // restore currentSnapScanOrder so confirmSnapScanPayment can use it
                window.currentSnapScanOrder = window.currentSnapScanOrder || pending;

                // If user is not on checkout page, route them there
                if (typeof showPage === 'function') {
                    showPage('checkout');
                }

                // Give UI a beat to render fields
                setTimeout(async () => {
                    // Validate shipping fields: if missing, don't auto placeâ€”just guide user
                    const required = ['firstName','lastName','email','phone','address','city','postalCode','province'];
                    const missing = required.filter(id => {
                        const el = document.getElementById(id);
                        return !el || !String(el.value || '').trim();
                    });

                    if (missing.length) {
                        // Show gentle prompt; user can fill and then tap Place Order
                        try {
                            showToast?.('Payment detected. Please complete shipping info then tap Place Order.');
                        } catch(_) {}
                        return;
                    }

                    // Auto-place without a confirm dialog
                    await confirmSnapScanPayment(true);
                }, 600);
            } catch (e) {
                console.warn("SnapScan auto-finalise failed:", e);
            }
        }

        // When user returns to the tab after paying, auto-finalise
        window.addEventListener('focus', () => {
            // slight delay to avoid running on initial load focus
            setTimeout(autoFinalizeSnapScanIfNeeded, 400);
        });
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) setTimeout(autoFinalizeSnapScanIfNeeded, 400);
        });

// ===== YOCO PAYMENT FUNCTIONS =====
        
        function showYocoPaymentModal(amount, description, metadata = {}, customer = null) {
            // Hosted Checkout via your Render server (keeps secret key off the browser)
            // FAST: show overlay instantly and redirect as soon as Yoco returns the checkout URL.
            try {
                showPayOverlay('Starting Yocoâ€¦');
                warmPaymentServer();

                const amountInCents = Math.round(Number(amount) * 100);

                const baseUrl = (window.SITE_BASE_URL || window.location.origin || '').replace(/\/$/, '');
                const successUrl = `${baseUrl}/?yoco=success`;
                const cancelUrl  = `${baseUrl}/?yoco=cancel`;
                const failureUrl = `${baseUrl}/?yoco=failure`;

                // If the old modal exists, hide it (we redirect to hosted checkout)
                const modal = document.getElementById('yocoModal');
                if (modal) modal.classList.add('hidden');

                // Fail fast if the network hangs
                const controller = new AbortController();
                const timeoutMs = 12000;
                const t = setTimeout(() => controller.abort(), timeoutMs);

                fetch(`${PAYMENT_SERVER_BASE}/api/yoco/create-checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amountInCents,
                        currency: 'ZAR',
                        successUrl,
                        cancelUrl,
                        failureUrl,
                        metadata: {
                            ...(metadata || {}),
                            description,
                            customerEmail: customer?.email || null
                        }
                    }),
                    signal: controller.signal,
                    cache: 'no-store'
                })
                .then(async (r) => {
                    const data = await r.json().catch(() => ({}));
                    if (!r.ok) throw new Error(data?.message || data?.error || `Yoco error (${r.status})`);
                    if (!data.redirectUrl) throw new Error('Yoco did not return a redirectUrl');
                    window.location.href = data.redirectUrl;
                })
                .catch((err) => {
                    console.error('Yoco checkout start failed:', err);
                    hidePayOverlay();
                    alert('Yoco payment could not start. Please try again, or use SnapScan.');
                })
                .finally(() => {
                    clearTimeout(t);
                });
            } catch (err) {
                console.error('Yoco checkout start failed:', err);
                hidePayOverlay();
                alert('Yoco payment could not start. Please try again, or use SnapScan.');
            }
        }

        function closeYocoPaymentModal() {
            document.getElementById('yocoPaymentModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            clearYocoForm();
            clearYocoFormErrors();
        }

        function clearYocoForm() {
            document.getElementById('cardNumber').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('cvc').value = '';
            document.getElementById('cardholderName').value = '';
            document.getElementById('receiptEmail').value = '';
            document.getElementById('yocoPaymentErrors').style.display = 'none';
        }

        function clearYocoFormErrors() {
            document.querySelectorAll('.payment-error').forEach(error => {
                error.classList.remove('active');
            });
            document.querySelectorAll('.card-input').forEach(input => {
                input.classList.remove('error');
            });
        }

        
        // ===== YOCO TOKEN HELPER (supports different SDK versions) =====
        async function createYocoToken(card) {
            // Ensure SDK exists
            if (!window.yocoSDK && window.YocoSDK) {
                try {
                    window.yocoSDK = new window.YocoSDK({ publicKey: YOCO_PUBLIC_KEY });
                } catch (e) {}
            }
            const sdk = window.yocoSDK;

            // 1) Promise-based createToken
            if (sdk && typeof sdk.createToken === 'function') {
                // Some versions are callback-based; detect by arity
                if (sdk.createToken.length >= 2) {
                    return await new Promise((resolve, reject) => {
                        sdk.createToken(card, (result) => {
                            // Yoco commonly returns {id: 'tok_...'} or {error: {...}}
                            if (result && result.error) return reject(result.error);
                            if (result && result.id) return resolve(result);
                            return reject(new Error('Unexpected token response'));
                        });
                    });
                }
                return await sdk.createToken(card);
            }

            // 2) inline.createToken variant
            if (sdk && sdk.inline && typeof sdk.inline.createToken === 'function') {
                return await sdk.inline.createToken(card);
            }

            // 3) Hosted popup fallback (no inline tokenization available)
            // Some Yoco builds expose showPopup on the instance, others behave differently.
            const popupCapable =
                (sdk && typeof sdk.showPopup === 'function') ||
                (window.YocoSDK && typeof window.YocoSDK.showPopup === 'function') ||
                (window.yocoSDK && typeof window.yocoSDK.showPopup === 'function');

            if (popupCapable) {
                return await new Promise((resolve, reject) => {
                    try {
                        const cents = Math.round((window.currentOrderTotalZAR || 0) * 100);
                        const popupFn =
                            (sdk && sdk.showPopup) ||
                            (window.yocoSDK && window.yocoSDK.showPopup) ||
                            (window.YocoSDK && window.YocoSDK.showPopup);

                        popupFn.call(sdk || window.yocoSDK || window.YocoSDK, {
                            amountInCents: cents,
                            currency: 'ZAR',
                            name: 'Drixel SA',
                            description: 'Card payment',
                            callback: function (result) {
                                if (result && result.error) return reject(result.error);
                                if (result && result.id) return resolve(result);
                                return reject(new Error('Unexpected popup token response'));
                            }
                        });
                    } catch (e) { reject(e); }
                });
            }

            throw new Error('Yoco SDK tokenization method not available (createToken missing).');
        }

async function processYocoPayment() {
            console.log("ðŸ”„ processYocoPayment() called");
            
            if (!window.yocoSDK) {
                console.error("âŒ yocoSDK is not available!");
                const errorsDiv = document.getElementById('yocoPaymentErrors');
                errorsDiv.innerHTML = `
                    <p><i class="fas fa-exclamation-triangle"></i> Payment system loading...</p>
                    <p style="font-size: 12px; margin-top: 10px;">
                        Please wait a moment and try again. 
                        If this continues, refresh the page.
                    </p>
                `;
                errorsDiv.style.display = 'block';
                return;
            }
            
            const errorsDiv = document.getElementById('yocoPaymentErrors');
            errorsDiv.style.display = 'none';
            errorsDiv.innerHTML = '';
            
            const cardNumber = document.getElementById('cardNumber').value.trim().replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value.trim();
            const cvc = document.getElementById('cvc').value.trim();
            const cardholderName = document.getElementById('cardholderName').value.trim();
            const receiptEmail = document.getElementById('receiptEmail').value.trim();
            
            const processBtn = document.getElementById('processPaymentBtn');
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<div class="loading-spinner"></div> Processing Payment...';
            processBtn.disabled = true;
            
            try {
                console.log("ðŸ’³ Starting Yoco Payment...");
                
                if (!window.yocoSDK) {
                    window.yocoSDK = new window.YocoSDK({
                        publicKey: YOCO_PUBLIC_KEY
                    });
                }
                
                window.currentOrderTotalZAR = (currentYocoPayment && currentYocoPayment.amount) ? currentYocoPayment.amount : 0;
                const token = await createYocoToken({
                    number: cardNumber,
                    cvc: cvc,
                    expiryMonth: expiryDate.split('/')[0],
                    expiryYear: '20' + expiryDate.split('/')[1],
                    name: cardholderName
                });
                
                console.log("âœ… Yoco token created:", token.id.substring(0, 15) + '...');
                
                closeYocoPaymentModal();
                
                alert('âœ… Payment Successful! R' + currentYocoPayment.amount.toFixed(2) + ' has been processed. Receipt sent to ' + receiptEmail);
                
                // Complete the order
                await completeYocoPayment(token.id, receiptEmail);
                
            } catch (error) {
                console.error("âŒ Payment Error:", error);
                
                let errorMessage = 'Payment failed: ';
                if (error.message.includes('insufficient')) {
                    errorMessage = 'Insufficient funds. Please use a different card.';
                } else if (error.message.includes('declined')) {
                    errorMessage = 'Card declined. Please contact your bank or use a different card.';
                } else {
                    errorMessage += error.message || 'Please check your card details and try again.';
                }
                
                errorsDiv.innerHTML = `<p>â€¢ ${errorMessage}</p>`;
                errorsDiv.style.display = 'block';
                
                errorsDiv.scrollIntoView({ behavior: 'smooth' });
            } finally {
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }

        async function completeYocoPayment(tokenId, receiptEmail) {
            try {
                if (!window.pendingOrderData) {
                    throw new Error("No pending order data found");
                }
                
                const orderData = window.pendingOrderData;
                
                // Update order with payment info
                const db = window.firebaseDb;
                if (orderData.orderId) {
                    const orderRef = window.firebaseDoc(db, 'orders', orderData.orderId);
                    await window.firebaseUpdateDoc(orderRef, {
                        paymentStatus: 'paid',
                        paymentToken: tokenId.substring(0, 15) + '...',
                        receiptEmail: receiptEmail,
                        updatedAt: new Date().toISOString()
                    });
                }
                
                // Send email based on payment method rules
                if (orderData.paymentMethod === 'yoco' || orderData.paymentMethod === 'snapscan') {
                    // Non-bank payments: send ORDER CONFIRMATION
                    await sendOrderConfirmationEmail(orderData);
                } else if (orderData.paymentMethod === 'bank') {
                    // Bank transfer: send ORDER RECEIVED (payment pending)
                    await sendOrderReceivedEmail(orderData);
                }
                
                // Clear cart
                cart = [];
                updateCartCount();
                
                // Show order confirmation page
                document.getElementById('orderNumber').textContent = orderData.orderNumber;
                const deliveryFeeInfo = document.getElementById('deliveryFeeInfo');
                if (orderData.shipping === 0) {
                    deliveryFeeInfo.textContent = 'Delivery: FREE (Order over R1000)';
                } else {
                    deliveryFeeInfo.textContent = `Delivery Fee: R${orderData.shipping.toFixed(2)}`;
                }
                
                // Clear pending order data
                window.pendingOrderData = null;
                
                showPage('orderConfirmation');
                
            } catch (error) {
                console.error("âŒ Error completing Yoco payment:", error);
                alert('Error completing order. Please contact support.');
            }
        }

        function initiateYocoDirectPayment(productId, productName, price) {
            const currentUser = window.currentFirebaseUser;
            if (!currentUser) {
                alert('Please login or create an account to make a purchase.');
                showPage('auth');
                return false;
            }
            
            const productKey = `product_${productId}`;
            const selections = productSelections[productKey] || {
                size: 'M',
                color: { name: 'Black', code: '#111111' }
            };
            
            const description = `Drixel SA: ${productName} (${selections.size}, ${selections.color.name})`;
            const metadata = {
                productId: productId,
                productName: productName,
                size: selections.size,
                color: selections.color.name,
                quantity: 1,
                type: 'direct'
            };
            
            const customer = {
                name: currentUser.displayName || currentUser.email.split('@')[0],
                email: currentUser.email,
                phone: ''
            };
            
            showYocoPaymentModal(price, description, metadata, customer);
        }

        function initiateYocoCheckoutFromCart() {
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items to your cart first.');
                return;
            }
            
            const firstName = document.getElementById('firstName')?.value;
            const lastName = document.getElementById('lastName')?.value;
            const email = document.getElementById('email')?.value;
            
            if (firstName && lastName && email) {
                initiateYocoCheckout();
            } else {
                checkAuthAndNavigate('checkout');
                
                setTimeout(() => {
                    const payYoco = document.getElementById('payYoco');
                    if (payYoco) {
                        payYoco.checked = true;
                        payYoco.dispatchEvent(new Event('change'));
                    }
                }, 500);
            }
        }

        function initiateYocoCheckout() {
            if (cart.length === 0) {
                alert('Your cart is empty.');
                return;
            }
            
            const firstName = document.getElementById('firstName')?.value;
            const lastName = document.getElementById('lastName')?.value;
            const email = document.getElementById('email')?.value;
            const phone = document.getElementById('phone')?.value;
            
            if (!firstName || !lastName || !email || !phone) {
                alert('Please fill in all required shipping information before proceeding with Yoco payment.');
                return;
            }
            
            // Calculate order total
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const shipping = calculateDeliveryFee(subtotal);
            const total = subtotal + shipping;
            
            // Generate order number
            const orderNumber = generateOrderNumber();
            
            const description = `Drixel SA Order #${orderNumber} (${cart.length} items)`;
            const metadata = {
                orderNumber: orderNumber,
                type: 'checkout',
                cart: cart.length
            };
            
            const customer = {
                name: `${firstName} ${lastName}`,
                email: email,
                phone: phone
            };
            
            // Store order data temporarily
            window.pendingOrderData = {
                order_id: orderNumber,
                orderNumber: orderNumber,
                        orderNumber: orderNumber,
                customer: customer,
                items: [...cart],
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                paymentMethod: 'yoco',
                paymentStatus: 'pending_payment',
                subscribed: document.getElementById('newsletterSubscription')?.checked || false,
                status: 'processing'
            };
            
            // Show Yoco payment modal
            showYocoPaymentModal(total, description, metadata, customer);
        }

        // ===== EMAIL FUNCTIONS =====
     async function sendOrderConfirmationEmail(orderData) {
    console.log("ðŸ“§ Sending Order Confirmation Email...");
        initEmailJSForService(EMAILJS_CONFIG.SERVICE_ID); // ensure correct EmailJS public key for Service 1
    console.log("ðŸ“§ Recipient:", orderData.customer.email);
    console.log("ðŸ“§ Order Number:", orderData.orderNumber);
    
    // IMPORTANT: Check if EmailJS is loaded
    if (typeof emailjs === 'undefined') {
        console.error("âŒ EmailJS not loaded!");
        return { success: false, message: 'EmailJS not loaded. Please refresh the page.' };
    }
    
    // Validate email
    if (!orderData.customer.email || !orderData.customer.email.includes('@')) {
        console.error("âŒ Invalid email address:", orderData.customer.email);
        return { success: false, message: 'Invalid email address' };
    }
    
    try {
        // Build mobile-safe 'View my order' link (query param)
        const orderDocId = orderData?.orderDocId || orderData?.firestoreDocId || orderData?.docId || orderData?.id || '';
        const orderUrl = orderDocId ? `${SITE_BASE_URL}?order=${encodeURIComponent(orderDocId)}` : SITE_BASE_URL;

        // Determine payment method display text
        let paymentMethodText = '';
        let bankDetails = '';
        
        if (orderData.paymentMethod === 'bank') {
            paymentMethodText = 'Bank Transfer';
            bankDetails = `
                <p><strong>Bank Transfer Details:</strong></p>
                <p>Bank: Standard Bank</p>
                <p>Account Number: 071337873</p>
                <p>Account Name: DRIXEL CLOTHING BRAND</p>
                <p>Reference: ${orderData.orderNumber}</p>
                <p>Amount: R${orderData.total.toFixed(2)}</p>
            `;
        } else if (orderData.paymentMethod === 'yoco') {
            paymentMethodText = 'Credit/Debit Card (Yoco)';
            bankDetails = '<p><strong>Payment Status:</strong> âœ… Paid</p>';
        } else if (orderData.paymentMethod === 'snapscan') {
            paymentMethodText = 'SnapScan';
            bankDetails = '<p><strong>Payment Status:</strong> â³ Pending Verification</p>';
        }
        
        // Format items for email
        const itemsHtml = `
            <table role="presentation" cellpadding="0" cellspacing="0" width="100%" style="border-collapse:collapse;">
              <thead>
                <tr>
                  <th align="left" style="padding:10px 8px;border-bottom:1px solid #e5e5e5;font-size:12px;letter-spacing:.6px;text-transform:uppercase;">Item</th>
                  <th align="center" style="padding:10px 8px;border-bottom:1px solid #e5e5e5;font-size:12px;letter-spacing:.6px;text-transform:uppercase;">Qty</th>
                  <th align="right" style="padding:10px 8px;border-bottom:1px solid #e5e5e5;font-size:12px;letter-spacing:.6px;text-transform:uppercase;">Total</th>
                </tr>
              </thead>
              <tbody>
                ${(orderData.items||[]).map(item => {
                    const name = item.name || item.productName || 'Item';
                    const meta = [item.size ? `Size: ${item.size}` : '', item.color ? item.color : ''].filter(Boolean).join(' â€¢ ');
                    const qty = item.quantity || 1;
                    const lineTotal = (item.price * qty).toFixed(2);
                    return `
                      <tr>
                        <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;font-size:14px;">
                          <div style="font-weight:700;">${name}</div>
                          ${meta ? `<div style="margin-top:4px;color:#666;font-size:12px;">${meta}</div>` : ``}
                        </td>
                        <td align="center" style="padding:10px 8px;border-bottom:1px solid #f0f0f0;font-size:14px;">${qty}</td>
                        <td align="right" style="padding:10px 8px;border-bottom:1px solid #f0f0f0;font-size:14px;">R${lineTotal}</td>
                      </tr>`;
                }).join('')}
              </tbody>
            </table>
        `;
        
        // Prepare template parameters
        const templateParams = {
            to_email: orderData.customer.email,
            to_name: orderData.customer.name,
            order_id: orderData.orderNumber,
            order_url: orderUrl,
            order_date: new Date(orderData.createdAt).toLocaleDateString('en-ZA'),
            customer_name: orderData.customer.name,
            customer_email: orderData.customer.email,
            customer_phone: orderData.customer.phone || 'Not provided',
            shipping_address: `${orderData.customer.address}, ${orderData.customer.city}, ${orderData.customer.province}, ${orderData.customer.postalCode}`,
            items: itemsHtml,
            subtotal: `R${orderData.subtotal.toFixed(2)}`,
            shipping: `R${orderData.shipping.toFixed(2)}`,
            total: `R${orderData.total.toFixed(2)}`,
            payment_method: paymentMethodText,
            bank_details: bankDetails,
            estimated_delivery: '3-5 business days after processing',
            processing_time: '1-3 days',
            reply_to: 'drixelsa@gmail.com',
            from_name: 'Drixel SA'
        };
        
        console.log("ðŸ“§ Using template:", EMAILJS_CONFIG.TEMPLATES.ORDER_CONFIRMATION);
        
        // Send the email using Service 1
        const result = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,  // Use the first service
            EMAILJS_CONFIG.TEMPLATES.ORDER_CONFIRMATION,
            templateParams
        );
        
        console.log("âœ… Order Confirmation Email sent successfully!");
        return { success: true, message: 'Email sent successfully' };
        
    } catch (error) {
        console.error("âŒ Error sending Order Confirmation Email:", error);
        console.error("âŒ Full error:", error);
        
        return { 
            success: false, 
            message: 'Email sending failed',
            details: error.text || error.message 
        };
    }
}

        async function sendOrderReceivedEmail(orderData) {
    console.log("ðŸ“§ Sending Order Received Email...");
        initEmailJSForService(EMAILJS_CONFIG.SERVICE_ID); // ensure correct EmailJS public key for Service 1
    
    // Check if EmailJS is loaded
    if (typeof emailjs === 'undefined') {
        console.error("âŒ EmailJS not loaded!");
        return { success: false, message: 'EmailJS not loaded' };
    }
    
    // Validate email
    if (!orderData.customer.email || !orderData.customer.email.includes('@')) {
        console.error("âŒ Invalid email address:", orderData.customer.email);
        return { success: false, message: 'Invalid email address' };
    }
    
    try {
        // Format items for email
        const itemsHtml = orderData.items.map(item => 
            `<tr>
                <td>${item.name}</td>
                <td>${item.size}</td>
                <td>${item.color}</td>
                <td>${item.quantity}</td>
                <td>R${(item.price * item.quantity).toFixed(2)}</td>
            </tr>`
        ).join('');
        
        const templateParams = {
            to_email: orderData.customer.email,
            to_name: orderData.customer.name,
            order_id: orderData.orderNumber,
            order_date: new Date(orderData.createdAt).toLocaleDateString('en-ZA'),
            customer_name: orderData.customer.name,
            items: itemsHtml,
            item_count: orderData.items.reduce((sum, item) => sum + item.quantity, 0),
            subtotal: `R${orderData.subtotal.toFixed(2)}`,
            shipping: orderData.shipping === 0 ? 'FREE' : `R${orderData.shipping.toFixed(2)}`,
            total: `R${orderData.total.toFixed(2)}`,
            payment_method: orderData.paymentMethod === 'bank' ? 'Bank Transfer' : 
                           orderData.paymentMethod === 'yoco' ? 'Credit Card (Yoco)' : 
                           orderData.paymentMethod === 'snapscan' ? 'SnapScan' : 'Other',
            payment_status: orderData.paymentStatus === 'paid' ? 'âœ… Paid' : 
                           orderData.paymentStatus === 'pending' ? 'â³ Pending' : 
                           'â³ Pending Verification',
            estimated_delivery: '3-5 business days after processing',
            processing_time: '1-3 days',
            reply_to: 'drixelsa@gmail.com',
            from_name: 'Drixel SA'
        };
        
        console.log("ðŸ“§ Using template:", EMAILJS_CONFIG.TEMPLATES.ORDER_RECEIVED);
        
        // Use Service 1 for this email as well
        const result = await emailjs.send(
            EMAILJS_CONFIG.SERVICE_ID,  // Use the first service
            EMAILJS_CONFIG.TEMPLATES.ORDER_RECEIVED,
            templateParams
        );
        
        console.log("âœ… Order Received Email sent successfully!");
        return { success: true, message: 'Email sent successfully' };
        
    } catch (error) {
        console.error("âŒ Error sending Order Received Email:", error);
        return { 
            success: false, 
            message: 'Email sending failed',
            details: error.message 
        };
    }
}
        async function sendOutForDeliveryEmailToCustomer(orderData, trackingNumber, courierService, trackingUrl) {
            try {
        const orderDocId = orderData?.orderDocId || orderData?.id || '';
        const orderUrl = orderDocId ? `${SITE_BASE_URL}?order=${encodeURIComponent(orderDocId)}` : SITE_BASE_URL;
                console.log("ðŸ“§ Sending Out for Delivery Email...");
                initEmailJSForService(EMAILJS_CONFIG.SERVICE_ID_2); // ensure correct EmailJS public key for Service 2
                
                const recipientEmail =
                
                    orderData?.customer?.email ||
                
                    orderData?.customer_email ||
                
                    orderData?.email ||
                
                    '';
                
                const recipientName =
                
                    orderData?.customer?.name ||
                
                    orderData?.customer_name ||
                
                    orderData?.to_name ||
                
                    'Customer';

                
                if (!recipientEmail || !recipientEmail.includes('@')) {
                
                    console.error("âŒ Missing recipient email in orderData:", orderData);
                
                    throw new Error('The recipients address is empty');
                
                }

                
                const templateParams = {
                
                    to_email: recipientEmail,
                
                    to_name: recipientName,
                
                    order_id: (orderData.order_id || orderData.orderNumber),
                
                    customer_name: recipientName,
                
                    tracking_number: trackingNumber,
                
                    courier_service: courierService,
                
                    tracking_url: trackingUrl || '#',
                
                    estimated_delivery_date: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                
                    delivery_address: `${orderData.customer?.address || ''}, ${orderData.customer?.city || ''}, ${orderData.customer?.province || ''}`,
                
                    items_count: (orderData.items || []).length,
                
                    reply_to: 'drixelsa@gmail.com'
                
                };
                // Use the second service for delivery emails
                const result = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID_2,
                    EMAILJS_CONFIG.TEMPLATES.OUT_FOR_DELIVERY,
                    templateParams
                );
                
                console.log("âœ… Out for Delivery Email sent successfully:", result);
                return { success: true, message: 'Email sent successfully' };
                
            } catch (error) {
                console.error("âŒ Error sending Out for Delivery Email:", error);
                return { success: false, message: error.text || 'Email sending failed' };
            }
        }

        async function sendOrderDeliveredEmailToCustomer(orderData, deliveredDate) {
            try {
                console.log("ðŸ“§ Sending Order Delivered Email...");
                initEmailJSForService(EMAILJS_CONFIG.SERVICE_ID_2); // ensure correct EmailJS public key for Service 2
                
                // Generate order URL (link to view order details)
                const orderDocId = orderData?.orderDocId || orderData?.firestoreDocId || orderData?.docId || orderData?.id || '';
                const orderUrl = orderDocId ? `${SITE_BASE_URL}?order=${encodeURIComponent(orderDocId)}` : SITE_BASE_URL;
                
                const recipientEmail =
                
                    orderData?.customer?.email ||
                
                    orderData?.customer_email ||
                
                    orderData?.email ||
                
                    '';
                
                const recipientName =
                
                    orderData?.customer?.name ||
                
                    orderData?.customer_name ||
                
                    orderData?.to_name ||
                
                    'Customer';

                
                if (!recipientEmail || !recipientEmail.includes('@')) {
                
                    console.error("âŒ Missing recipient email in orderData:", orderData);
                
                    throw new Error('The recipients address is empty');
                
                }

                
                const templateParams = {
                
                    to_email: recipientEmail,
                
                    to_name: recipientName,
                
                    order_id: (orderData.order_id || orderData.orderNumber),
                
                    customer_name: recipientName,
                
                    delivered_date: deliveredDate,
                
                    order_url: orderUrl,
                
                    items: (orderData.items || []).map(item => 
                
                        `${item.name} (${item.size}, ${item.color}) x${item.quantity}`
                
                    ).join('<br>'),
                
                    reply_to: 'drixelsa@gmail.com'
                
                };
                // Use the second service for delivery emails
                const result = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID_2,
                    EMAILJS_CONFIG.TEMPLATES.ORDER_DELIVERED,
                    templateParams
                );
                
                console.log("âœ… Order Delivered Email sent successfully:", result);
                return { success: true, message: 'Email sent successfully' };
                
            } catch (error) {
                console.error("âŒ Error sending Order Delivered Email:", error);
                return { success: false, message: error.text || 'Email sending failed' };
            }
        }

        // ===== ADMIN FUNCTIONS =====
        function showAdminButton() {
            const existingBtn = document.getElementById('adminMobileBtn');
            if (existingBtn) existingBtn.remove();
            
            const adminBtn = document.createElement('button');
            adminBtn.id = 'adminMobileBtn';
            adminBtn.innerHTML = '<i class="fas fa-crown"></i>';
            adminBtn.title = 'Admin Dashboard';
            adminBtn.onclick = function(e) {
                e.preventDefault();
                showAdminDashboard();
            };
            
            document.body.appendChild(adminBtn);
            console.log("ðŸ‘‘ Admin button added to page");
        }

        function showAdminDashboard() {
            // Create admin dashboard modal
            const dashboardHTML = `
                <div id="adminDashboard" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; overflow-y: auto; padding: 20px;">
                    <div style="background: white; border-radius: 10px; max-width: 1200px; margin: 20px auto; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="color: #111111;"><i class="fas fa-crown"></i> Admin Dashboard</h2>
                            <button onclick="closeAdminDashboard()" style="background: #ff6b00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto;">
                            <button class="admin-tab-btn active" onclick="switchAdminTab('overview')">Overview</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('orders')">Orders</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('products')">Products</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('users')">Users</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('emails')">Emails</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('snapscan')">SnapScan</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('yoco')">Yoco</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('pending')">Pending</button>
                            <button class="admin-tab-btn" onclick="switchAdminTab('settings')">Settings</button>
                        </div>
                        
                        <div id="adminTabContent">
                            <!-- Content loaded dynamically -->
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing dashboard if any
            const existingDashboard = document.getElementById('adminDashboard');
            if (existingDashboard) existingDashboard.remove();
            
            // Add dashboard to page
            document.body.insertAdjacentHTML('beforeend', dashboardHTML);
            
            // Load initial tab
            switchAdminTab('overview');
        }

        function closeAdminDashboard() {
            const dashboard = document.getElementById('adminDashboard');
            if (dashboard) dashboard.remove();
        }

        function switchAdminTab(tab) {
            // Update active tab button
            const buttons = document.querySelectorAll('.admin-tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find the clicked button and mark it active
            const clickedBtn = event?.target || document.querySelector(`.admin-tab-btn[onclick*="${tab}"]`);
            if (clickedBtn) clickedBtn.classList.add('active');
            
            const tabContent = document.getElementById('adminTabContent');
            
            switch(tab) {
                case 'overview':
                    loadAdminOverview();
                    break;
                case 'orders':
                    loadAdminOrders();
                    break;
                case 'products':
                    loadAdminProducts();
                    break;
                case 'users':
                    loadAdminUsers();
                    break;
                case 'emails':
                    loadAdminEmailManagement();
                    break;
                case 'snapscan':
                    loadAdminSnapScan();
                    break;
                case 'yoco':
                    loadAdminYoco();
                    break;
                case 'pending':
                    loadAdminPending();
                    break;
                case 'settings':
                    loadAdminSettings();
                    break;
            }
        }

        async function loadAdminOverview() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            try {
const db = window.firebaseDb;
                const today = new Date().toISOString().split('T')[0];
                
                // Get orders count
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(db, 'orders'));
                const totalOrders = ordersSnapshot.size;
                
                // Get today's orders
                const todayOrders = Array.from(ordersSnapshot.docs).filter(doc => {
                    const orderDate = doc.data().createdAt?.split('T')[0];
                    return orderDate === today;
                }).length;
                
                // Get users count
                const usersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(db, 'users'));
                const totalUsers = usersSnapshot.size;
                
                // Get pending payments
                const pendingOrders = Array.from(ordersSnapshot.docs).filter(doc => {
                    const status = doc.data().paymentStatus;
                    return status === 'pending' || status === 'pending_verification';
                }).length;
                
                // Calculate total revenue
                let totalRevenue = 0;
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.paymentStatus === 'paid') {
                        totalRevenue += order.total || 0;
                    }
                });
                
                // Get recent orders
                const recentOrders = [];
                ordersSnapshot.forEach(doc => {
                    recentOrders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by date, newest first
                recentOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const latestOrders = recentOrders.slice(0, 5);
                
                tabContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; border-left: 4px solid #0066cc;">
                            <h3 style="margin-bottom: 10px;">Total Orders</h3>
                            <p style="font-size: 32px; font-weight: bold; color: #0066cc;">${totalOrders}</p>
                            <p style="color: #666; font-size: 14px;">Today: ${todayOrders}</p>
                        </div>
                        
                        <div style="background: #fff0f5; padding: 20px; border-radius: 10px; border-left: 4px solid #ff6b00;">
                            <h3 style="margin-bottom: 10px;">Total Revenue</h3>
                            <p style="font-size: 32px; font-weight: bold; color: #ff6b00;">R ${totalRevenue.toFixed(2)}</p>
                            <p style="color: #666; font-size: 14px;">All time</p>
                        </div>
                        
                        <div style="background: #f0fff0; padding: 20px; border-radius: 10px; border-left: 4px solid #0caf60;">
                            <h3 style="margin-bottom: 10px;">Total Users</h3>
                            <p style="font-size: 32px; font-weight: bold; color: #0caf60;">${totalUsers}</p>
                            <p style="color: #666; font-size: 14px;">Registered customers</p>
                        </div>
                        
                        <div style="background: #fff8f0; padding: 20px; border-radius: 10px; border-left: 4px solid #ef476f;">
                            <h3 style="margin-bottom: 10px;">Pending Orders</h3>
                            <p style="font-size: 32px; font-weight: bold; color: #ef476f;">${pendingOrders}</p>
                            <p style="color: #666; font-size: 14px;">Awaiting payment</p>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px;">Recent Orders</h3>
                        ${latestOrders.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Order #</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${latestOrders.map(order => `
                                        <tr>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${order.order_id || order.orderNumber || order.id || 'â€”'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${order.customer?.name || 'N/A'}<br>
                                                <small>${order.customer?.email || ''}</small>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">R ${(order.total || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                                    background: ${order.paymentStatus === 'paid' ? '#d4edda' : 
                                                            order.paymentStatus === 'pending' ? '#fff3cd' : 
                                                            '#f8d7da'};
                                                    color: ${order.paymentStatus === 'paid' ? '#155724' : 
                                                            order.paymentStatus === 'pending' ? '#856404' : 
                                                            '#721c24'};">
                                                    ${order.paymentStatus || 'pending'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${new Date(order.createdAt).toLocaleDateString()}
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <button onclick="viewOrderDetails('${order.id}')" style="background: #0066cc; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p>No recent orders found.</p>'}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0;">
                            <h3 style="margin-bottom: 15px;">Quick Actions</h3>
                            <button onclick="switchAdminTab('orders')" style="width: 100%; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                                <i class="fas fa-shopping-cart"></i> Manage All Orders
                            </button>
                            <button onclick="switchAdminTab('products')" style="width: 100%; padding: 12px; background: #0caf60; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                                <i class="fas fa-tshirt"></i> Manage Products
                            </button>
                            <button onclick="switchAdminTab('users')" style="width: 100%; padding: 12px; background: #ff6b00; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
                                <i class="fas fa-users"></i> Manage Users
                            </button>
                        </div>
                        
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0;">
                            <h3 style="margin-bottom: 15px;">System Status</h3>
                            <div style="margin-bottom: 15px;">
                                <p><strong>Firebase:</strong> <span style="color: #0caf60;">Connected âœ“</span></p>
                                <p><strong>EmailJS:</strong> <span style="color: #0caf60;">Ready âœ“</span></p>
                                <p><strong>Yoco SDK:</strong> <span style="color: ${window.yocoSDK ? '#0caf60' : '#ef476f'};">${window.yocoSDK ? 'Ready âœ“' : 'Not Loaded âœ—'}</span></p>
                                <p><strong>Products Loaded:</strong> ${window.PRODUCTS_DATA.length}</p>
                                <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("âŒ Error loading admin overview:", error);
                tabContent.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border: 1px solid #f5c6cb;">
                        <h3>Error Loading Overview</h3>
                        <p>${error.message}</p>
                        <button onclick="loadAdminOverview()" style="background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        async function loadAdminOrders() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            try {
const db = window.firebaseDb;
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(db, 'orders'));
                
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by date, newest first
                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                tabContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>All Orders (${orders.length})</h3>
                        <div>
                            <select id="orderFilter" onchange="filterOrders()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                                <option value="all">All Orders</option>
                                <option value="pending">Pending Payment</option>
                                <option value="paid">Paid</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                            </select>
                            <button onclick="exportOrders()" style="background: #0caf60; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0;">
                        ${orders.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Order #</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Items</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Payment</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    ${orders.map(order => `
                                        <tr data-status="${order.paymentStatus}" data-order-status="${order.status || 'processing'}">
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${order.order_id || order.orderNumber || order.id || 'â€”'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <strong>${order.customer?.name || 'N/A'}</strong><br>
                                                <small>${order.customer?.email || ''}</small><br>
                                                <small>${order.customer?.phone || ''}</small>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${order.items?.length || 0} items
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">R ${(order.total || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                                    background: ${order.paymentMethod === 'yoco' ? '#d4edda' : 
                                                            order.paymentMethod === 'snapscan' ? '#cce5ff' : 
                                                            '#fff3cd'};
                                                    color: ${order.paymentMethod === 'yoco' ? '#155724' : 
                                                            order.paymentMethod === 'snapscan' ? '#004085' : 
                                                            '#856404'};">
                                                    ${order.paymentMethod || 'bank'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                                    background: ${order.paymentStatus === 'paid' ? '#d4edda' : 
                                                            order.paymentStatus === 'pending' ? '#fff3cd' : 
                                                            '#f8d7da'};
                                                    color: ${order.paymentStatus === 'paid' ? '#155724' : 
                                                            order.paymentStatus === 'pending' ? '#856404' : 
                                                            '#721c24'};">
                                                    ${order.paymentStatus || 'pending'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${new Date(order.createdAt).toLocaleDateString()}<br>
                                                <small>${new Date(order.createdAt).toLocaleTimeString()}</small>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <button onclick="viewOrderDetails('${order.id}')" style="background: #0066cc; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                                    View
                                                </button>
                                                <button onclick="updateOrderStatus('${order.id}')" style="background: #ff6b00; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p>No orders found.</p>'}
                    </div>
                    
                    <div style="margin-top: 20px; color: #666; font-size: 14px;">
                        <p><i class="fas fa-info-circle"></i> Orders are sorted by date (newest first).</p>
                    </div>
                `;
            } catch (error) {
                console.error("âŒ Error loading orders:", error);
                tabContent.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border: 1px solid #f5c6cb;">
                        <h3>Error Loading Orders</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ===== ADMIN MODAL FUNCTIONS =====
        function openOutForDeliveryModal(orderId, customerName, orderNumber) {
            currentAdminOrder = { id: orderId, customerName: customerName, orderNumber: orderNumber };
            document.getElementById('customerNameDisplay').value = customerName;
            document.getElementById('orderIdDisplay').value = orderNumber;
            document.getElementById('outForDeliveryModal').classList.add('active');
        }

        function closeOutForDeliveryModal() {
            document.getElementById('outForDeliveryModal').classList.remove('active');
            currentAdminOrder = null;
        }

        function openOrderDeliveredModal(orderId, orderNumber) {
            currentAdminOrder = { id: orderId, orderNumber: orderNumber };
            document.getElementById('deliveryOrderIdDisplay').value = orderNumber;
            document.getElementById('orderUrlDisplay').value = `${SITE_BASE_URL}?order=${encodeURIComponent(orderId)}`;
            document.getElementById('orderDeliveredModal').classList.add('active');
        }

        function closeOrderDeliveredModal() {
            document.getElementById('orderDeliveredModal').classList.remove('active');
            currentAdminOrder = null;
        }

        function openConfirmPaymentModal(orderId, orderNumber, customerEmail, orderAmount, paymentMethod) {
            currentAdminOrder = { id: orderId, orderNumber: orderNumber };
            document.getElementById('confirmOrderNumber').value = orderNumber;
            document.getElementById('confirmCustomerEmail').value = customerEmail;
            document.getElementById('confirmOrderAmount').value = `R ${orderAmount.toFixed(2)}`;
            document.getElementById('confirmPaymentMethod').value = paymentMethod;
            document.getElementById('confirmPaymentModal').classList.add('active');
        }

        function closeConfirmPaymentModal() {
            document.getElementById('confirmPaymentModal').classList.remove('active');
            currentAdminOrder = null;
        }

        async function markOutForDeliveryAndEmail(orderIdOverride) {
            const trackingNumber = document.getElementById('trackingNumber').value;
            const courierService = document.getElementById('courierService').value;
            const trackingUrl = document.getElementById('trackingUrl').value;
            
            if (!trackingNumber || !courierService) {
                alert('Please fill in all required fields (Tracking Number and Courier Service).');
                return;
            }
            
            try {
                const orderId = orderIdOverride || (currentAdminOrder && currentAdminOrder.id);
                if (!orderId) {
                    alert('No order selected. Please open "Out for Delivery" from an order first.');
                    return;
                }

                const db = window.firebaseDb;
                const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderId));
                
                if (!orderDoc.exists()) {
                    alert('Order not found!');
                    return;
                }
                
                const order = { id: orderDoc.id, ...orderDoc.data() };
                
                // Update order status
                await window.firebaseUpdateDoc(window.firebaseDoc(db, 'orders', order.id), {
                    status: 'shipped',
                    trackingNumber: trackingNumber,
                    courierService: courierService,
                    trackingUrl: trackingUrl || '',
                    updatedAt: new Date().toISOString()
                });
                
                // Send out for delivery email
                const emailResult = await sendOutForDeliveryEmailToCustomer(order, trackingNumber, courierService, trackingUrl || '');
                
                if (emailResult.success) {
                    alert('âœ… Order marked as shipped and email sent!');
                } else {
                    alert('âœ… Order marked as shipped but email failed to send: ' + emailResult.message);
                }
                
                closeOutForDeliveryModal();
                loadAdminOrders();
                
            } catch (error) {
                console.error("âŒ Error updating order:", error);
                alert('Error updating order: ' + error.message);
            }
        }

        async function markDeliveredAndEmail() {
            
            if (!currentAdminOrder || !currentAdminOrder.id) {
                alert('Please open an order and click \"Delivered\" first.');
                return;
            }
const deliveredDate = document.getElementById('deliveredDate').value;
            
            if (!deliveredDate) {
                alert('Please select a delivery date.');
                return;
            }
            
            try {
const db = window.firebaseDb;
                const orderId = currentAdminOrder.id;
                const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderId));
                
                if (!orderDoc.exists()) {
                    alert('Order not found!');
                    return;
                }
                
                const order = { id: orderDoc.id, ...orderDoc.data() };
                
                // Update order status
                await window.firebaseUpdateDoc(window.firebaseDoc(db, 'orders', order.id), {
                    status: 'delivered',
                    deliveredDate: deliveredDate,
                    updatedAt: new Date().toISOString()
                });
                
                // Send order delivered email
                const emailResult = await sendOrderDeliveredEmailToCustomer(order, deliveredDate);
                
                if (emailResult.success) {
                    alert('âœ… Order marked as delivered and email sent!');
                } else {
                    alert('âœ… Order marked as delivered but email failed to send: ' + emailResult.message);
                }
                
                closeOrderDeliveredModal();
                loadAdminOrders();
                
            } catch (error) {
                console.error("âŒ Error updating order:", error);
                alert('Error updating order: ' + error.message);
            }
        }
async function processPaymentConfirmation() {
    try {
        const db = window.firebaseDb;
        const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', currentAdminOrder.id));
        
        if (!orderDoc.exists()) {
            alert('Order not found!');
            return;
        }
        
        const order = { 
            id: orderDoc.id, 
            ...orderDoc.data(),
            orderNumber: currentAdminOrder.orderNumber  // Ensure order number is included
        };
        
        console.log("âœ… Processing payment confirmation for order:", order.orderNumber);
        
        // Update payment status in Firebase
        await window.firebaseUpdateDoc(window.firebaseDoc(db, 'orders', order.id), {
            paymentStatus: 'paid',
            updatedAt: new Date().toISOString(),
            status: 'processing'
        });
        
        // Update local order object
        order.paymentStatus = 'paid';
        
        // Send BOTH emails
        
        // Send emails based on rules:
        // - Bank transfer: send Order Confirmation + Order Received AFTER admin confirms payment.
        // - Yoco / SnapScan: Order Received is already sent at checkout, so we do not resend here.
        let confirmationResult = { success: true, message: 'Skipped' };
        let receivedResult = { success: true, message: 'Skipped' };

        if ((order.paymentMethod || '').toLowerCase() === 'bank') {
            console.log("ðŸ“§ Sending Order Confirmation Email (Bank - confirmed in admin)...");
            confirmationResult = await sendOrderConfirmationEmail(order);

            console.log("ðŸ“§ Sending Order Received Email (Bank - confirmed in admin)...");
            receivedResult = await sendOrderReceivedEmail(order);
        }

        if (confirmationResult.success && receivedResult.success) {
            alert('âœ… Payment confirmed and emails handled successfully!\n\n' +
                  `Order #${order.order_id || order.orderNumber || currentAdminOrder.orderNumber || order.id} has been updated.\n` +
                  `Customer: ${order.customer?.email || order.customer_email || order.email || 'Email not found in order record'}`);
        } else {
            let message = 'âœ… Payment confirmed but email issues:\n';
            if (!confirmationResult.success) message += `â€¢ Order Confirmation: ${confirmationResult.message || confirmationResult.details || ''}\n`;
            if (!receivedResult.success) message += `â€¢ Order Received: ${receivedResult.message || receivedResult.details || ''}\n`;
            alert(message);
        }
closeConfirmPaymentModal();
        loadAdminPending();
        
    } catch (error) {
        console.error("âŒ Error confirming payment:", error);
        alert('Error confirming payment: ' + error.message);
    }
}
        

        // ===== COOKIE FUNCTIONS =====
        function acceptCookies() {
            localStorage.setItem('drixel_cookies', 'accepted');
            document.getElementById('cookieConsent').classList.remove('active');
            console.log('Cookies accepted');
        }

        function declineCookies() {
            localStorage.setItem('drixel_cookies', 'declined');
            document.getElementById('cookieConsent').classList.remove('active');
            console.log('Cookies declined');
        }

        // ===== INITIALIZE APP =====
        function initializeAppAfterFirebase() {
            console.log("ðŸš€ Initializing Drixel SA with all fixes");
            
            if (!window.PRODUCTS_DATA || !Array.isArray(window.PRODUCTS_DATA)) {
                console.error("âŒ PRODUCTS_DATA is not defined or not an array!");
                window.PRODUCTS_DATA = getLocalProductsData();
            }
            
            console.log("ðŸ“¦ Products loaded:", window.PRODUCTS_DATA.length);
            
            updateCartCount();
            updateAuthUI();
            showPage('home');
            loadFeaturedProducts();
            loadAllProducts();
            updateCollectionsBarActive(window.currentCollectionFilter || 'all');
            loadYocoProducts();
            
            setTimeout(() => {
                if (!cookiesAccepted) {
                    document.getElementById('cookieConsent').classList.add('active');
                }
            }, 2000);
            
            console.log('=== DRIXEL SA READY ===');
            console.log('ðŸ”¥ Firebase: Connected');
            console.log('ðŸ’³ Payments: Yoco & SnapScan Ready');
            console.log('ðŸ“§ EmailJS: Initialized');
            console.log('ðŸ“¦ Products: ' + window.PRODUCTS_DATA.length);
            console.log('ðŸ‘‘ Admin: ' + ADMIN_EMAIL);
            console.log('ðŸ“§ Email: drixelsa@gmail.com');
            console.log('ðŸšš Delivery: R70 (Free over R1000)');
        }

        // Add these missing admin functions to complete the implementation
        async function loadAdminProducts() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Products Management (${window.PRODUCTS_DATA.length})</h3>
                    <button onclick="showAddProductForm()" style="background: #0caf60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;" id="adminProductsGrid">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            `;
            
            loadAdminProductsGrid();
        }

        function loadAdminProductsGrid() {
            const productsGrid = document.getElementById('adminProductsGrid');
            if (!productsGrid) return;
            
            productsGrid.innerHTML = '';
            
            window.PRODUCTS_DATA.forEach(product => {
                const productCard = document.createElement('div');
                productCard.style.cssText = `
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 15px;
                    transition: transform 0.3s;
                `;
                
                productCard.innerHTML = `
                    <div style="display: flex; gap: 15px;">
                        <img src="${product.image}" alt="${product.name}" 
                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;"
                             onerror="this.src='https://via.placeholder.com/100x100?text=Product'">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0;">${product.name}</h4>
                            <p style="color: #ff6b00; font-weight: bold; margin: 0 0 10px 0;">R ${product.price.toFixed(2)}</p>
                            <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">${product.description.substring(0, 60)}...</p>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <span style="background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                    ${product.category}
                                </span>
                                ${product.featured ? '<span style="background: #d4edda; padding: 2px 8px; border-radius: 12px; font-size: 12px;">Featured</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="editProduct(${product.id})" style="flex: 1; background: #0066cc; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Edit
                        </button>
                        <button onclick="deleteProduct(${product.id})" style="flex: 1; background: #ef476f; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Delete
                        </button>
                    </div>
                `;
                
                productsGrid.appendChild(productCard);
            });
        }

        async function loadAdminUsers() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>Users Management</h3>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0;">
                    <p>Users management feature coming soon...</p>
                </div>
            `;
        }

        function loadAdminEmailManagement() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3>Email Management</h3>
                    <p style="color: #666;">Manage email templates and send notifications to customers.</p>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 10px; border: 1px solid #e0e0e0;">
                    <h4 style="margin-bottom: 20px;">Email Templates</h4>
                    <div style="margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Order Confirmation</strong><br>
                            <small>Template ID: ${EMAILJS_CONFIG.TEMPLATES.ORDER_CONFIRMATION}</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Order Received</strong><br>
                            <small>Template ID: ${EMAILJS_CONFIG.TEMPLATES.ORDER_RECEIVED}</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 10px;">
                            <strong>Out for Delivery</strong><br>
                            <small>Template ID: ${EMAILJS_CONFIG.TEMPLATES.OUT_FOR_DELIVERY}</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 5px;">
                            <strong>Order Delivered</strong><br>
                            <small>Template ID: ${EMAILJS_CONFIG.TEMPLATES.ORDER_DELIVERED}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadAdminSnapScan() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3>SnapScan Payments</h3>
                    <p style="color: #666;">View and manage SnapScan payments and references.</p>
                </div>
                
                <div style="background: #0096FF10; padding: 25px; border-radius: 10px; border: 2px dashed #0096FF; margin-bottom: 30px;">
                    <h4 style="color: #0096FF; margin-bottom: 15px;"><i class="fas fa-qrcode"></i> SnapScan Merchant Info</h4>
                    <div>
                        <p><strong>Merchant Name:</strong> Drixel SA</p>
                        <p><strong>Registration:</strong> ${SNAPSCAN_REGISTRATION}</p>
                        <p><strong>QR Code URL:</strong> ${SNAPSCAN_QR_URL}</p>
                    </div>
                </div>
            `;
        }

        function loadAdminYoco() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3>Yoco Payments</h3>
                    <p style="color: #666;">View and manage Yoco credit card payments.</p>
                </div>
                
                <div style="background: #FF6B0010; padding: 25px; border-radius: 10px; border: 2px dashed #FF6B00; margin-bottom: 30px;">
                    <h4 style="color: #FF6B00; margin-bottom: 15px;"><i class="fas fa-credit-card"></i> Yoco Integration</h4>
                    <div>
                        <p><strong>Public Key:</strong> ${YOCO_PUBLIC_KEY.substring(0, 15)}...</p>
                        <p><strong>SDK Status:</strong> ${window.yocoSDK ? '<span style="color: #0caf60;">Loaded âœ“</span>' : '<span style="color: #ef476f;">Not Loaded âœ—</span>'}</p>
                    </div>
                </div>
            `;
        }

        async function loadAdminPending() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            try {
const db = window.firebaseDb;
                const ordersSnapshot = await window.firebaseGetDocs(window.firebaseCollection(db, 'orders'));
                
                const pendingOrders = [];
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.paymentStatus === 'pending' || order.paymentStatus === 'pending_verification') {
                        pendingOrders.push({
                            id: doc.id,
                            ...order
                        });
                    }
                });
                
                pendingOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                tabContent.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h3>Pending Orders (${pendingOrders.length})</h3>
                        <p style="color: #666;">Orders awaiting payment or verification.</p>
                    </div>
                    
                    ${pendingOrders.length > 0 ? `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Order #</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Payment Method</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingOrders.map(order => {
                                        const isBankTransfer = order.paymentMethod === 'bank';
                                        const isSnapScan = order.paymentMethod === 'snapscan';
                                        return `
                                        <tr>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">${order.order_id || order.orderNumber || order.id || 'â€”'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${order.customer?.name || 'N/A'}<br>
                                                <small>${order.customer?.email || ''}</small>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">R ${(order.total || 0).toFixed(2)}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                                    background: ${isBankTransfer ? '#fff3cd' : isSnapScan ? '#cce5ff' : '#d4edda'};
                                                    color: ${isBankTransfer ? '#856404' : isSnapScan ? '#004085' : '#155724'};">
                                                    ${order.paymentMethod || 'bank'}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
                                                    background: ${order.paymentStatus === 'pending_verification' ? '#ffeaa7' : '#fff3cd'};
                                                    color: #856404;">
                                                    ${order.paymentStatus}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                                ${isBankTransfer ? `
                                                    <button onclick="openConfirmPaymentModal('${orderId}', '${order.order_id || order.orderNumber}', '${order.customer?.email}', ${order.total || 0}, '${order.paymentMethod}')" style="background: #0caf60; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                                        Confirm Payment
                                                    </button>
                                                ` : ''}
                                                <button onclick="viewOrderDetails('${order.id}')" style="background: #0066cc; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #0caf60; margin-bottom: 20px;"></i>
                            <h3>No Pending Orders</h3>
                            <p style="color: #666;">All orders are processed and paid.</p>
                        </div>
                    `}
                `;
            } catch (error) {
                console.error("âŒ Error loading pending orders:", error);
                tabContent.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border: 1px solid #f5c6cb;">
                        <h3>Error Loading Pending Orders</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function loadAdminSettings() {
            const tabContent = document.getElementById('adminTabContent');
            if (!tabContent) return;
            
            tabContent.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <h3>Settings</h3>
                    <p style="color: #666;">Configure store settings and preferences.</p>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 10px; border: 1px solid #e0e0e0;">
                    <h4 style="margin-bottom: 25px;">Store Configuration</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Delivery Fee (R)</label>
                        <input type="number" id="deliveryFee" value="${DELIVERY_FEE}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Free Delivery Threshold (R)</label>
                        <input type="number" id="freeDeliveryThreshold" value="${FREE_DELIVERY_THRESHOLD}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button onclick="saveSettings()" style="background: #0caf60; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">
                            Save Settings
                        </button>
                    </div>
                </div>
            `;
        }

        function saveSettings() {
            const newDeliveryFee = parseFloat(document.getElementById('deliveryFee').value);
            const newFreeThreshold = parseFloat(document.getElementById('freeDeliveryThreshold').value);
            
            if (newDeliveryFee && !isNaN(newDeliveryFee)) {
                DELIVERY_FEE = newDeliveryFee;
            }
            
            if (newFreeThreshold && !isNaN(newFreeThreshold)) {
                FREE_DELIVERY_THRESHOLD = newFreeThreshold;
            }
            
            alert('Settings saved successfully!');
        }

        // Add missing helper functions
        function editProduct(productId) {
            alert('Edit product feature coming soon!');
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                const index = window.PRODUCTS_DATA.findIndex(p => p.id === productId);
                if (index !== -1) {
                    window.PRODUCTS_DATA.splice(index, 1);
                    loadAdminProductsGrid();
                    alert('Product deleted successfully!');
                }
            }
        }

        function showAddProductForm() {
            alert('Add product feature coming soon!');
        }

        function filterOrders() {
            alert('Filter orders feature coming soon!');
        }

        function exportOrders() {
            alert('Export orders feature coming soon!');
        }

        async function viewOrderDetails(orderId) {
            try {
const db = window.firebaseDb;
                const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderId));
                
                if (!orderDoc.exists()) {
                    alert('Order not found!');
                    return;
                }
                
                const order = orderDoc.data();
                
                const modalHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; border-radius: 10px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                            <div style="padding: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                                    <h2 style="color: #111111;">Order Details: ${order.order_id || order.orderNumber || order.id || 'â€”'}</h2>
                                    <button onclick="closeModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                        Close
                                    </button>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                    <div>
                                        <h4 style="margin-bottom: 15px;">Customer Information</h4>
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                            <p><strong>Name:</strong> ${order.customer?.name || 'N/A'}</p>
                                            <p><strong>Email:</strong> ${order.customer?.email || 'N/A'}</p>
                                            <p><strong>Phone:</strong> ${order.customer?.phone || 'N/A'}</p>
                                            <p><strong>Address:</strong> ${order.customer?.address || 'N/A'}</p>
                                            <p><strong>City:</strong> ${order.customer?.city || 'N/A'}</p>
                                            <p><strong>Province:</strong> ${order.customer?.province || 'N/A'}</p>
                                            <p><strong>Postal Code:</strong> ${order.customer?.postalCode || 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 style="margin-bottom: 15px;">Order Information</h4>
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                            <p><strong>Order Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                                            <p><strong>Payment Method:</strong> ${order.paymentMethod || 'N/A'}</p>
                                            <p><strong>Payment Status:</strong> ${order.paymentStatus || 'pending'}</p>
                                            <p><strong>Order Status:</strong> ${order.status || 'processing'}</p>
                                            <p><strong>Delivery Method:</strong> ${order.deliveryMethod || 'N/A'}</p>
                                            <p><strong>Processing Time:</strong> ${order.processingTime || 'N/A'}</p>
                                            <p><strong>Delivery Time:</strong> ${order.deliveryTime || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 30px;">
                                    <h4 style="margin-bottom: 15px;">Order Items</h4>
                                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                        ${order.items?.map(item => `
                                            <div style="display: flex; padding: 15px; border-bottom: 1px solid #e0e0e0; align-items: center;">
                                                <img src="${item.image}" alt="${item.name}" 
                                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 15px;"
                                                     onerror="this.src='https://via.placeholder.com/60x60?text=Product'">
                                                <div style="flex: 1;">
                                                    <p style="margin: 0 0 5px 0; font-weight: bold;">${item.name}</p>
                                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                                        Size: ${item.size} | Color: ${item.color} | Quantity: ${item.quantity}
                                                    </p>
                                                </div>
                                                <div style="font-weight: bold; color: #ff6b00;">
                                                    R ${(item.price * item.quantity).toFixed(2)}
                                                </div>
                                            </div>
                                        `).join('') || '<p style="padding: 20px; text-align: center;">No items found</p>'}
                                    </div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                    <h4 style="margin-bottom: 15px;">Order Summary</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <p><strong>Subtotal:</strong> R ${(order.subtotal || 0).toFixed(2)}</p>
                                            <p><strong>Shipping:</strong> R ${(order.shipping || 0).toFixed(2)}</p>
                                            <p><strong>Tax:</strong> R ${(order.tax || 0).toFixed(2)}</p>
                                        </div>
                                        <div>
                                            <p style="font-size: 18px; font-weight: bold; color: #ff6b00;">
                                                <strong>Total:</strong> R ${(order.total || 0).toFixed(2)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    ${order.paymentMethod === 'bank' && order.paymentStatus === 'pending' ? `
                                        <button onclick="openConfirmPaymentModal('${orderId}', '${order.order_id || order.orderNumber}', '${order.customer?.email}', ${order.total || 0}, '${order.paymentMethod}')" style="background: #0caf60; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                            Confirm Payment
                                        </button>
                                    ` : ''}
                                    ${order.status === 'processing' ? `
                                        <button onclick="openOutForDeliveryModal('${orderId}', '${order.customer?.name || ''}', '${order.order_id || order.orderNumber}')" style="background: #ff6b00; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                            Mark as Shipped
                                        </button>
                                    ` : ''}
                                    ${order.status === 'shipped' ? `
                                        <button onclick="openOrderDeliveredModal('${orderId}', '${order.order_id || order.orderNumber}')" style="background: #0caf60; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                            Mark as Delivered
                                        </button>
                                    ` : ''}
                                    <button onclick="updateOrderStatus('${orderId}')" style="background: #0066cc; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer;">
                                        Update Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } catch (error) {
                console.error("âŒ Error viewing order details:", error);
                alert('Error loading order details.');
            }
        }
        window.viewOrderDetails = viewOrderDetails;

        function closeModal() {
            const modal = document.querySelector('[style*="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);"]');
            if (modal) modal.remove();
        }
        window.closeModal = closeModal;

        async function updateOrderStatus(orderId) {
            const statusInput = prompt('Enter new order status (processing, shipped, delivered, cancelled):', 'shipped');
            if (!statusInput) return;

            const status = String(statusInput).trim().toLowerCase();

            try {
                const db = window.firebaseDb;

                // For shipped/delivered we need extra info + email, so route to the correct modal
                if (status === 'shipped') {
                    // Load order to get customer name + order number for the modal display
                    const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderId));
                    if (!orderDoc.exists()) {
                        alert('Order not found!');
                        return;
                    }
                    const o = { id: orderDoc.id, ...orderDoc.data() };
                    const customerName = o.customerName || o.fullName || o.name || (o.customer && o.customer.name) || 'Customer';
                    const orderNumber = o.order_id || o.orderNumber || o.orderId || orderId;

                    // Open shipped modal (handles update + email)
                    openOutForDeliveryModal(orderId, customerName, orderNumber);
                    return;
                }

                if (status === 'delivered') {
                    // Load order to get a friendly order number for the modal display
                    const orderDoc = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderId));
                    if (!orderDoc.exists()) {
                        alert('Order not found!');
                        return;
                    }
                    const o = { id: orderDoc.id, ...orderDoc.data() };
                    const orderNumber = o.order_id || o.orderNumber || o.orderId || orderId;

                    // Open delivered modal (handles update + email)
                    openOrderDeliveredModal(orderId, orderNumber);
                    return;
                }

                // Simple statuses (no extra details required)
                await window.firebaseUpdateDoc(window.firebaseDoc(db, 'orders', order.id), {
                    status: status,
                    updatedAt: new Date().toISOString()
                });

                alert(`Order status updated to: ${status}`);
                closeModal();
                loadAdminOrders();
            } catch (error) {
                console.error("âŒ Error updating order status:", error);
                alert('Error updating order status: ' + error.message);
            }
        }
        window.updateOrderStatus = updateOrderStatus;
        // ===== EXPOSE FUNCTIONS FOR INLINE onclick="..." =====
        // Your HTML uses inline onclick handlers. Those handlers can only call functions that are on window.
        // So we attach the important ones here.
        try {
            Object.assign(window, {
                showPage,
                checkAuthAndNavigate,
                switchAdminTab,
                selectSize,
                selectColor,
                initiateYocoDirectPayment,
                viewOrderDetails,
                updateOrderStatus,
                openConfirmPaymentModal,
                closeConfirmPaymentModal,
                processPaymentConfirmation,
                openOutForDeliveryModal,
                closeOutForDeliveryModal,
                sendOutForDeliveryEmail,
                openOrderDeliveredModal,
                closeOrderDeliveredModal,
                sendOrderDeliveredEmail,
                addToCart,
                updateCartItemQuantity,
                decreaseQuantity,
                increaseQuantity,
                showAuthTab,
                declineCookies,
                acceptCookies,
                placeOrder,
                sendContactMessage,
                closeModal
            });
        } catch (e) {
            console.warn("âš ï¸ Could not expose some functions to window:", e);
        }
    

        // ===== ORDER VIEW (from email button "View my order") =====
        async function handleOrderHash() {
            try {
                const hash = window.location.hash || '';
                if (!hash.startsWith('?order=')) return;

                const orderDocId = decodeURIComponent(hash.replace('?order=', '').trim());
                if (!orderDocId) return;

                if (!window.firebaseDb || !window.firebaseGetDoc || !window.firebaseDoc) {
                    console.error("âŒ Firebase not ready for order view");
                    return;
                }

                const db = window.firebaseDb;
                const snap = await window.firebaseGetDoc(window.firebaseDoc(db, 'orders', orderDocId));
                if (!snap.exists()) {
                    alert('Order not found.');
                    return;
                }

                const order = { id: snap.id, ...snap.data() };
                showOrderDetailsOverlay(order);
            } catch (e) {
                console.error("âŒ handleOrderHash error:", e);
            }
        }

        function showOrderDetailsOverlay(order) {
            // remove existing
            const existing = document.getElementById('orderDetailsOverlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.id = 'orderDetailsOverlay';
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.65)';
            overlay.style.zIndex = '99999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.onclick = (e) => { if (e.target === overlay) { overlay.remove(); } };

            const card = document.createElement('div');
            card.style.width = 'min(920px, 92vw)';
            card.style.maxHeight = '88vh';
            card.style.overflow = 'auto';
            card.style.background = '#0b0b0b';
            card.style.border = '1px solid rgba(255,255,255,0.12)';
            card.style.borderRadius = '16px';
            card.style.padding = '18px';

            const orderCode = order.order_id || order.orderNumber || order.id;
            const customerName = order.customer?.name || order.to_name || order.customer_name || 'Customer';
            const customerEmail = order.customer?.email || order.customer_email || order.email || 'â€”';

            const itemsRows = (order.items || []).map(it => {
                const name = it.name || it.productName || 'Item';
                const size = it.size || '';
                const color = it.color || '';
                const qty = it.quantity || 1;
                const price = Number(it.price || 0);
                const line = (price * qty).toFixed(2);
                return `<tr>
                    <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);">${name} ${size ? '('+size+')':''} ${color ? color:''}</td>
                    <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:center;">${qty}</td>
                    <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.08); text-align:right;">R${line}</td>
                </tr>`;
            }).join('');

            const subtotal = (order.subtotal != null) ? `R${Number(order.subtotal).toFixed(2)}` : 'â€”';
            const shipping = (order.shipping != null) ? `R${Number(order.shipping).toFixed(2)}` : 'â€”';
            const total = (order.total != null) ? `R${Number(order.total).toFixed(2)}` : 'â€”';

            const status = order.status || order.orderStatus || 'processing';
            const tracking = order.trackingNumber ? `${order.courierService || ''} ${order.trackingNumber}` : 'â€”';
            const trackingUrl = order.trackingUrl || '';

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <div style="font-size:18px; font-weight:700;">Order Details</div>
                        <div style="opacity:0.8; margin-top:4px;">Order ID: <strong>${orderCode}</strong></div>
                    </div>
                    <button onclick="document.getElementById('orderDetailsOverlay')?.remove()" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;">Close</button>
                </div>

                <div style="margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div style="border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px;">
                        <div style="font-weight:700; margin-bottom:6px;">Customer</div>
                        <div>${customerName}</div>
                        <div style="opacity:0.85;">${customerEmail}</div>
                    </div>
                    <div style="border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px;">
                        <div style="font-weight:700; margin-bottom:6px;">Status</div>
                        <div><strong>${status}</strong></div>
                        <div style="opacity:0.85;">Tracking: ${tracking}</div>
                        ${trackingUrl ? `<div style="margin-top:6px;"><a href="${trackingUrl}" target="_blank" style="color: #ffb000; text-decoration: underline;">Track parcel</a></div>` : ''}
                    </div>
                </div>

                <div style="margin-top:14px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px;">
                    <div style="font-weight:700; margin-bottom:10px;">Items</div>
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.12);">Item</th>
                                <th style="text-align:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.12);">Qty</th>
                                <th style="text-align:right; padding:8px; border-bottom:1px solid rgba(255,255,255,0.12);">Total</th>
                            </tr>
                        </thead>
                        <tbody>${itemsRows || '<tr><td colspan="3" style="padding:8px;">No items found.</td></tr>'}</tbody>
                    </table>

                    <div style="margin-top:12px; display:flex; justify-content:flex-end;">
                        <div style="min-width:260px;">
                            <div style="display:flex; justify-content:space-between; opacity:0.9;"><span>Subtotal</span><span>${subtotal}</span></div>
                            <div style="display:flex; justify-content:space-between; opacity:0.9;"><span>Shipping</span><span>${shipping}</span></div>
                            <div style="display:flex; justify-content:space-between; margin-top:6px; font-weight:800;"><span>Total</span><span>${total}</span></div>
                        </div>
                    </div>
                </div>
            `;

            overlay.appendChild(card);
            document.body.appendChild(overlay);
        }

        window.addEventListener('hashchange', handleOrderHash);
        document.addEventListener('DOMContentLoaded', handleOrderHash);


        // ===== EXPOSE FUNCTIONS FOR INLINE onclick HANDLERS (MOBILE FIX) =====
        if (typeof window.acceptCookies === 'undefined' && typeof acceptCookies === 'function') window.acceptCookies = acceptCookies;
        if (typeof window.addToCart === 'undefined' && typeof addToCart === 'function') window.addToCart = addToCart;
        if (typeof window.changeProductColor === 'undefined' && typeof changeProductColor === 'function') window.changeProductColor = changeProductColor;
        if (typeof window.checkAuthAndNavigate === 'undefined' && typeof checkAuthAndNavigate === 'function') window.checkAuthAndNavigate = checkAuthAndNavigate;
        if (typeof window.closeAdminDashboard === 'undefined' && typeof closeAdminDashboard === 'function') window.closeAdminDashboard = closeAdminDashboard;
        if (typeof window.closeConfirmPaymentModal === 'undefined' && typeof closeConfirmPaymentModal === 'function') window.closeConfirmPaymentModal = closeConfirmPaymentModal;
        if (typeof window.closeModal === 'undefined' && typeof closeModal === 'function') window.closeModal = closeModal;
        if (typeof window.closeOrderDeliveredModal === 'undefined' && typeof closeOrderDeliveredModal === 'function') window.closeOrderDeliveredModal = closeOrderDeliveredModal;
        if (typeof window.closeOutForDeliveryModal === 'undefined' && typeof closeOutForDeliveryModal === 'function') window.closeOutForDeliveryModal = closeOutForDeliveryModal;
        if (typeof window.closeYocoPaymentModal === 'undefined' && typeof closeYocoPaymentModal === 'function') window.closeYocoPaymentModal = closeYocoPaymentModal;
        if (typeof window.confirmSnapScanPayment === 'undefined' && typeof confirmSnapScanPayment === 'function') window.confirmSnapScanPayment = confirmSnapScanPayment;
        if (typeof window.copySnapScanReference === 'undefined' && typeof copySnapScanReference === 'function') window.copySnapScanReference = copySnapScanReference;
        if (typeof window.declineCookies === 'undefined' && typeof declineCookies === 'function') window.declineCookies = declineCookies;
        if (typeof window.decreaseQuantity === 'undefined' && typeof decreaseQuantity === 'function') window.decreaseQuantity = decreaseQuantity;
        if (typeof window.deleteProduct === 'undefined' && typeof deleteProduct === 'function') window.deleteProduct = deleteProduct;
        if (typeof window.editProduct === 'undefined' && typeof editProduct === 'function') window.editProduct = editProduct;
        if (typeof window.exportOrders === 'undefined' && typeof exportOrders === 'function') window.exportOrders = exportOrders;
        if (typeof window.firebaseGoogleLogin === 'undefined' && typeof firebaseGoogleLogin === 'function') window.firebaseGoogleLogin = firebaseGoogleLogin;
        if (typeof window.increaseQuantity === 'undefined' && typeof increaseQuantity === 'function') window.increaseQuantity = increaseQuantity;
        if (typeof window.initiateYocoCheckout === 'undefined' && typeof initiateYocoCheckout === 'function') window.initiateYocoCheckout = initiateYocoCheckout;
        if (typeof window.initiateYocoCheckoutFromCart === 'undefined' && typeof initiateYocoCheckoutFromCart === 'function') window.initiateYocoCheckoutFromCart = initiateYocoCheckoutFromCart;
        if (typeof window.initiateYocoDirectPayment === 'undefined' && typeof initiateYocoDirectPayment === 'function') window.initiateYocoDirectPayment = initiateYocoDirectPayment;
        if (typeof window.loadAdminOverview === 'undefined' && typeof loadAdminOverview === 'function') window.loadAdminOverview = loadAdminOverview;
        if (typeof window.markDeliveredAndEmail === 'undefined' && typeof markDeliveredAndEmail === 'function') window.markDeliveredAndEmail = markDeliveredAndEmail;
        if (typeof window.markOutForDeliveryAndEmail === 'undefined' && typeof markOutForDeliveryAndEmail === 'function') window.markOutForDeliveryAndEmail = markOutForDeliveryAndEmail;
        if (typeof window.navigateToShopAndFilter === 'undefined' && typeof navigateToShopAndFilter === 'function') window.navigateToShopAndFilter = navigateToShopAndFilter;
        if (typeof window.openConfirmPaymentModal === 'undefined' && typeof openConfirmPaymentModal === 'function') window.openConfirmPaymentModal = openConfirmPaymentModal;
        if (typeof window.openOrderDeliveredModal === 'undefined' && typeof openOrderDeliveredModal === 'function') window.openOrderDeliveredModal = openOrderDeliveredModal;
        if (typeof window.openOutForDeliveryModal === 'undefined' && typeof openOutForDeliveryModal === 'function') window.openOutForDeliveryModal = openOutForDeliveryModal;
        if (typeof window.placeOrder === 'undefined' && typeof placeOrder === 'function') window.placeOrder = placeOrder;
        if (typeof window.processPaymentConfirmation === 'undefined' && typeof processPaymentConfirmation === 'function') window.processPaymentConfirmation = processPaymentConfirmation;
        if (typeof window.processYocoPayment === 'undefined' && typeof processYocoPayment === 'function') window.processYocoPayment = processYocoPayment;
        if (typeof window.removeFromCart === 'undefined' && typeof removeFromCart === 'function') window.removeFromCart = removeFromCart;
        if (typeof window.resetPasswordFromLogin === 'undefined' && typeof resetPasswordFromLogin === 'function') window.resetPasswordFromLogin = resetPasswordFromLogin;
        if (typeof window.saveSettings === 'undefined' && typeof saveSettings === 'function') window.saveSettings = saveSettings;
        if (typeof window.selectColor === 'undefined' && typeof selectColor === 'function') window.selectColor = selectColor;
        if (typeof window.selectSize === 'undefined' && typeof selectSize === 'function') window.selectSize = selectSize;
        if (typeof window.sendContactMessage === 'undefined' && typeof sendContactMessage === 'function') window.sendContactMessage = sendContactMessage;
        if (typeof window.showAddProductForm === 'undefined' && typeof showAddProductForm === 'function') window.showAddProductForm = showAddProductForm;
        if (typeof window.showAuthTab === 'undefined' && typeof showAuthTab === 'function') window.showAuthTab = showAuthTab;
        if (typeof window.showCollectionComingSoon === 'undefined' && typeof showCollectionComingSoon === 'function') window.showCollectionComingSoon = showCollectionComingSoon;
        if (typeof window.showPage === 'undefined' && typeof showPage === 'function') window.showPage = showPage;
        if (typeof window.switchAdminTab === 'undefined' && typeof switchAdminTab === 'function') window.switchAdminTab = switchAdminTab;
        if (typeof window.updateCartItemQuantity === 'undefined' && typeof updateCartItemQuantity === 'function') window.updateCartItemQuantity = updateCartItemQuantity;
        if (typeof window.updateOrderStatus === 'undefined' && typeof updateOrderStatus === 'function') window.updateOrderStatus = updateOrderStatus;
        if (typeof window.viewOrderDetails === 'undefined' && typeof viewOrderDetails === 'function') window.viewOrderDetails = viewOrderDetails;
        // Ensure default page shows after load
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (typeof window.showPage === 'function') window.showPage('home');
            } catch (e) {}
        });
</script>

<!-- ===== DRIXEL FAQ ASSISTANT (Safe) ===== -->
<button type="button" id="drixelChatFab" aria-label="Open assistant" title="Need help?" onclick="window.__drixelOpenChat && window.__drixelOpenChat()">
  <i class="fas fa-comment-dots"></i>
</button>

<div id="drixelChatPanel" role="dialog" aria-label="Drixel Assistant" aria-modal="false" aria-hidden="true">
  
  <div class="drixel-chat-header">
    <div class="title" style="display:flex;align-items:center;gap:10px;">
      <img src="https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png" alt="Drixel" class="drixel-chat-avatar">
      <div style="display:flex;flex-direction:column;line-height:1.15;">
        <strong>Drixel Assistant</strong>
        <span>Help from our policies & FAQs</span>
      </div>
    </div>
    <button type="button" class="drixel-chat-close" id="drixelChatClose" aria-label="Close assistant" onclick="window.__drixelCloseChat && window.__drixelCloseChat()">
      <i class="fas fa-times"></i>
    </button>
  </div>


  <div class="drixel-quick" aria-label="Quick questions">
    <button type="button" class="drixel-chip" data-q="Delivery time">Delivery time</button>
    <button type="button" class="drixel-chip" data-q="Returns & refunds">Returns</button>
    <button type="button" class="drixel-chip" data-q="Exchanges">Exchanges</button>
    <button type="button" class="drixel-chip" data-q="Payment methods">Payments</button>
    <button type="button" class="drixel-chip" data-q="Order processing time">Processing</button>
    <button type="button" class="drixel-chip" data-q="Contact support">Support</button>
  </div>

  <div class="drixel-chat-body" id="drixelChatBody" aria-live="polite"></div>

  <div class="drixel-chat-footer">
    <div class="drixel-chat-inputwrap">
      <input id="drixelChatInput" type="text" placeholder="Ask about delivery, returns, sizing, payments..." autocomplete="off">
      <button type="button" id="drixelChatSend" aria-label="Send"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="drixel-small">Tip: tap a FAQ chip above for instant answers.</div>
  </div>
</div>


<script>
/* ===== DRIXEL FAQ ASSISTANT (SAFE MODE) =====
   - This assistant answers ONLY from the FAQ/POLICY text below.
   - No API keys are used in this HTML (keeps your site safe).
   - If you later want real AI, create a backend endpoint and set AI_ENDPOINT.
*/
(function(){
  const AI_ENDPOINT = ""; // SAFE MODE (no backend) // e.g. "https://yourdomain.com/api/assistant" (optional). Leave empty for SAFE mode.

  const els = {
    fab: document.getElementById("drixelChatFab"),
    panel: document.getElementById("drixelChatPanel"),
    close: document.getElementById("drixelChatClose"),
    body: document.getElementById("drixelChatBody"),
    input: document.getElementById("drixelChatInput"),
    send: document.getElementById("drixelChatSend"),
    chips: Array.from(document.querySelectorAll(".drixel-chip[data-q]")),
  };

  if(!els.fab || !els.panel) return;

  // Your policies / T&Cs / FAQ knowledge base (EDIT THESE ANYTIME)
  const KNOWLEDGE = [
    {
      title: "Order Processing",
      keywords: ["processing", "process", "timeline", "how long to process", "dispatch"],
      text:
        "Due to high demand, order processing takes 1â€“3 days before shipping. Some items may require an additional 2â€“5 days for production if manufacturing is needed."
    },
    {
      title: "Delivery",
      keywords: ["delivery", "deliver", "shipping", "courier", "paxi", "the courier guy", "how long is delivery", "arrival"],
      text:
        "Delivery is typically 3â€“5 business days after processing via The Courier Guy or PAXI. Free delivery may apply on qualifying orders as displayed on the site."
    },
    {
      title: "Returns & Refunds",
      keywords: ["return", "refund", "money back", "cancel", "wrong item", "defective", "faulty"],
      text:
        "Returns/refunds depend on our store policy and the condition of the item. If you received a faulty or incorrect item, contact support with your order details and photos so we can help quickly."
    },
    {
      title: "Exchanges",
      keywords: ["exchange", "swap", "size exchange", "different size"],
      text:
        "Need a size exchange? Contact support with your order number and requested size. Exchanges depend on stock availability."
    },
    {
      title: "Payments",
      keywords: ["payment", "pay", "yoco", "card", "bank transfer", "eft", "snapscan"],
      text:
        "You can pay using available checkout options on the site (e.g., card payments via Yoco and/or bank transfer where offered). Choose your payment method at checkout."
    },
    {
      title: "Support",
      keywords: ["support", "help", "contact", "email", "whatsapp", "speak to someone"],
      text:
        "If you need help with an order, delivery, returns, or anything else, go to the Contact page and message us with your order number and details."
    }
  ];

  function openPanel(){
    els.panel.classList.add("active");
    els.input.focus();
    if(!els.body.dataset.welcomed){
      els.body.dataset.welcomed = "1";
      botMsg("Hi ðŸ‘‹ I can help with delivery, returns, exchanges, payments, and order processing. Tap a FAQ above or ask a question.");
    }
  }
  function closePanel(){ els.panel.classList.remove("active"); }

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function addMsg(role, text){
    const row = document.createElement("div");
    row.className = "drixel-msg " + role;

    // Bot avatar
    if(role === "bot"){
      const av = document.createElement("img");
      av.className = "drixel-avatar";
      av.alt = "Drixel";
      av.src = "https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png";
      row.appendChild(av);
    }

    const bubble = document.createElement("div");
    bubble.className = "drixel-bubble";
    bubble.innerHTML = esc(text).replace(/
/g, "<br>");
    row.appendChild(bubble);
    els.body.appendChild(row);
    els.body.scrollTop = els.body.scrollHeight;
  }
  function userMsg(t){ addMsg("user", t); }
  function botMsg(t){ addMsg("bot", t); }

  function scoreMatch(q, item){
    const s = (q || "").toLowerCase();
    let score = 0;
    if(item.title.toLowerCase().includes(s)) score += 6;
    for(const k of item.keywords){
      const kw = k.toLowerCase();
      if(s.includes(kw)) score += 5;
      // partial word
      if(kw.length >= 4 && s.includes(kw.slice(0, Math.min(6, kw.length)))) score += 1;
    }
    // basic token overlap
    const tokens = s.split(/[^a-z0-9]+/).filter(Boolean);
    for(const tok of tokens){
      if(tok.length < 3) continue;
      if(item.text.toLowerCase().includes(tok)) score += 0.5;
    }
    return score;
  }

  function retrieveAnswer(question){
    const q = (question || "").trim();
    if(!q) return null;

    // Hard-coded intent shortcuts
    const lower = q.toLowerCase();
    if(lower.includes("track") || lower.includes("tracking")){
      return "Order tracking depends on the courier option used. Please contact support with your order number so we can assist with tracking updates.";
    }

    let best = null;
    let bestScore = 0;

    for(const item of KNOWLEDGE){
      const sc = scoreMatch(q, item);
      if(sc > bestScore){
        bestScore = sc;
        best = item;
      }
    }

    if(best && bestScore >= 4){
      return best.text + "\n\n(From: " + best.title + ")";
    }
    return null;
  }

  async function askAI(question){
    // Optional: If you set AI_ENDPOINT, we can call it safely (no keys in HTML).
    const res = await fetch(AI_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ question })
    });
    if(!res.ok) throw new Error("AI request failed");
    const data = await res.json();
    return (data && (data.answer || data.message)) ? String(data.answer || data.message) : "Sorry, I couldn't fetch an answer.";
  }

  async function handleQuestion(q){
    const question = (q || "").trim();
    if(!question) return;

    userMsg(question);

    // SAFE mode first: answer from policies/FAQ
    const local = retrieveAnswer(question);
    if(local){
      botMsg(local);
      return;
    }

    // If no local answer, try optional AI endpoint (if configured)
    if(AI_ENDPOINT){
      try{
        botMsg("Let me check our policiesâ€¦");
        const ans = await askAI(question);
        botMsg(ans);
      }catch(e){
        botMsg("Iâ€™m not sure from our policies. Please use the Contact page and share your order number so we can help.");
      }
      return;
    }

    // Fallback
    botMsg("Iâ€™m not sure from our current FAQs/policies. Please use the Contact page and share your order number (if you have one), and weâ€™ll help you fast.");
  }

  // Events
  els.fab.addEventListener("click", openPanel);
  els.close.addEventListener("click", closePanel);
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && els.panel.classList.contains("active")) closePanel();
  });

  els.send.addEventListener("click", ()=> handleQuestion(els.input.value).then(()=>{ els.input.value=""; }));
  els.input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      const v = els.input.value;
      els.input.value = "";
      handleQuestion(v);
    }
  });

  els.chips.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const q = btn.getAttribute("data-q") || btn.textContent;
      handleQuestion(q);
    });
  });

})();
</script>


<script>
/* ===== DRIXEL CHAT CLICK FIX ===== */
(function(){
  const panel = document.getElementById("drixelChatPanel");
  const fab = document.getElementById("drixelChatFab");
  const closeBtn = document.getElementById("drixelChatClose");
  const input = document.getElementById("drixelChatInput");
  const body = document.getElementById("drixelChatBody");

  function openChat(){
    if(!panel) return;
    panel.classList.add("active");
    panel.setAttribute("aria-hidden","false");
    try{ input && input.focus(); }catch(e){}
    if(body && !body.dataset.welcomed){
      body.dataset.welcomed = "1";
      // don't duplicate bot greeting if the main script already did it
    }
  }
  function closeChat(){
    if(!panel) return;
    panel.classList.remove("active");
    panel.setAttribute("aria-hidden","true");
  }

  window.__drixelOpenChat = openChat;
  window.__drixelCloseChat = closeChat;

  // Also bind directly (in case inline onclick is removed later)
  if(fab) fab.addEventListener("click", openChat);
  if(closeBtn) closeBtn.addEventListener("click", closeChat);
})();
</script>


<script>
/* ===== DRIXEL FAQ CHIP FIX (Event Delegation) ===== */
(function(){
  const quick = document.querySelector(".drixel-quick");
  const input = document.getElementById("drixelChatInput");
  const send = document.getElementById("drixelChatSend");

  if(!quick || !input || !send) return;

  quick.addEventListener("click", (e)=>{
    const btn = e.target && e.target.closest ? e.target.closest(".drixel-chip[data-q]") : null;
    if(!btn) return;
    e.preventDefault();
    e.stopPropagation();
    const q = btn.getAttribute("data-q") || btn.textContent || "";
    input.value = q.trim();
    // trigger the same flow as pressing send
    send.click();
  }, true);
})();
</script>

<script>
/* ===== DRIXEL ASSISTANT SEND HARD-FIX =====
   This ensures Send + FAQ chips always respond, even if another script blocks clicks.
*/
(function(){
  const panel = document.getElementById("drixelChatPanel");
  const body = document.getElementById("drixelChatBody");
  const input = document.getElementById("drixelChatInput");
  const send = document.getElementById("drixelChatSend");

  if(!panel || !body || !input || !send) return;

  // Minimal knowledge base (keep in sync with your policies)
  const KB = [
    { title:"Order Processing", kws:["processing","process","timeline","dispatch"], text:"Due to high demand, order processing takes 1â€“3 days before shipping. Some items may require an additional 2â€“5 days for production if manufacturing is needed." },
    { title:"Delivery", kws:["delivery","deliver","shipping","courier","paxi","the courier guy","arrival"], text:"Delivery is typically 3â€“5 business days after processing via The Courier Guy or PAXI. Free delivery may apply on qualifying orders as displayed on the site." },
    { title:"Returns & Refunds", kws:["return","refund","money back","cancel","wrong item","defective","faulty"], text:"Returns/refunds depend on our store policy and the condition of the item. If you received a faulty or incorrect item, contact support with your order details and photos so we can help quickly." },
    { title:"Exchanges", kws:["exchange","swap","size exchange","different size"], text:"Need a size exchange? Contact support with your order number and requested size. Exchanges depend on stock availability." },
    { title:"Payments", kws:["payment","pay","yoco","card","bank transfer","eft","snapscan"], text:"You can pay using available checkout options on the site (e.g., card payments via Yoco and/or bank transfer where offered). Choose your payment method at checkout." },
    { title:"Support", kws:["support","help","contact","email","whatsapp","speak to someone"], text:"If you need help with an order, delivery, returns, or anything else, go to the Contact page and message us with your order number and details." }
  ];

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function add(role, text){
    const row = document.createElement("div");
    row.className = "drixel-msg " + role;

    if(role === "bot"){
      const av = document.createElement("img");
      av.className = "drixel-avatar";
      av.alt = "Drixel";
      av.src = "https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png";
      row.appendChild(av);
    }


  // Typing indicator (bubble that gets replaced)
  function addTyping(){
    const row = document.createElement("div");
    row.className = "drixel-msg bot";
    row.setAttribute("data-typing","1");

    const av = document.createElement("img");
    av.className = "drixel-avatar";
    av.alt = "Drixel";
    av.src = "https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png";
    row.appendChild(av);

    const bubble = document.createElement("div");
    bubble.className = "drixel-bubble";
    bubble.innerHTML = '<span class="drixel-typing" aria-label="Typing">' +
      '<span class="drixel-typing-dot"></span>' +
      '<span class="drixel-typing-dot"></span>' +
      '<span class="drixel-typing-dot"></span>' +
      '</span>';
    row.appendChild(bubble);

    body.appendChild(row);
    body.scrollTop = body.scrollHeight;
    return row;
  }
  function replaceTyping(row, text){
    try{
      if(row && row.parentNode){
        row.parentNode.removeChild(row);
      }
    }catch(e){}
    add("bot", text);
  }

    const bubble = document.createElement("div");
    bubble.className = "drixel-bubble";
    bubble.innerHTML = esc(text).replace(/\n/g,"<br>");
    row.appendChild(bubble);
    body.appendChild(row);
    body.scrollTop = body.scrollHeight;
  }

  function findAnswer(q){
    const s = (q||"").toLowerCase();
    if(s.includes("track")) return "Order tracking depends on the courier option used. Please contact support with your order number so we can assist with tracking updates.";
    let best = null, bestScore = 0;
    for(const item of KB){
      let sc = 0;
      for(const kw of item.kws){
        if(s.includes(kw)) sc += 5;
      }
      if(item.title.toLowerCase().includes(s)) sc += 3;
      if(sc > bestScore){ bestScore = sc; best = item; }
    }
    if(best && bestScore >= 4) return best.text + "\n\n(From: " + best.title + ")";
    return null;
  }

  function sendFlow(){
    const q = (input.value || "").trim();
    if(!q) return;

    add("user", q);
    input.value = "";

    // Show typing indicator
    const typingRow = addTyping();

    const ans = findAnswer(q) || "Iâ€™m not sure from our current FAQs/policies. Please use the Contact page and share your order number (if you have one), and weâ€™ll help you fast.";

    // Small human-like delay
    const delay = 450 + Math.floor(Math.random() * 650); // 450â€“1100ms
    setTimeout(()=> replaceTyping(typingRow, ans), delay);
  }

  // CAPTURE listener so it fires even if bubbling is blocked somewhere else
  send.addEventListener("click", function(e){
    try{ e.preventDefault(); e.stopPropagation(); }catch(_) {}
    sendFlow();
  }, true);

  input.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      e.preventDefault();
      sendFlow();
    }
  }, true);

})();
</script>


<script>
/* ===== DRIXEL ASSISTANT OVERRIDE (Guaranteed Send + Typing) =====
   If any older handler breaks, this runs in CAPTURE mode and takes control.
*/
(function(){
  if(window.__drixelAssistantOverrideInstalled) return;
  window.__drixelAssistantOverrideInstalled = true;

  const body = document.getElementById("drixelChatBody");
  const input = document.getElementById("drixelChatInput");
  const send = document.getElementById("drixelChatSend");
  const quick = document.querySelector(".drixel-quick");

  if(!body || !input || !send) return;

  const KB = [
    { title:"Order Processing", kws:["processing","process","timeline","dispatch"], text:"Due to high demand, order processing takes 1â€“3 days before shipping. Some items may require an additional 2â€“5 days for production if manufacturing is needed." },
    { title:"Delivery", kws:["delivery","deliver","shipping","courier","paxi","the courier guy","arrival"], text:"Delivery is typically 3â€“5 business days after processing via The Courier Guy or PAXI." },
    { title:"Returns & Refunds", kws:["return","refund","money back","cancel","wrong item","defective","faulty"], text:"Returns/refunds depend on our store policy and the condition of the item. If you received a faulty or incorrect item, contact support with your order details and photos." },
    { title:"Exchanges", kws:["exchange","swap","size exchange","different size"], text:"Need a size exchange? Contact support with your order number and requested size. Exchanges depend on stock availability." },
    { title:"Payments", kws:["payment","pay","yoco","card","bank transfer","eft","snapscan"], text:"You can pay using available checkout options on the site (e.g., card payments via Yoco and/or bank transfer where offered)." },
    { title:"Support", kws:["support","help","contact","email","whatsapp","speak to someone"], text:"Please use the Contact page and send your order number and details so we can help you fast." }
  ];

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function add(role, text){
    const row = document.createElement("div");
    row.className = "drixel-msg " + role;

    if(role === "bot"){
      const av = document.createElement("img");
      av.className = "drixel-avatar";
      av.alt = "Drixel";
      av.src = "https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png";
      row.appendChild(av);
    }

    const bubble = document.createElement("div");
    bubble.className = "drixel-bubble";
    bubble.innerHTML = esc(text).replace(/\n/g,"<br>");
    row.appendChild(bubble);

    body.appendChild(row);
    body.scrollTop = body.scrollHeight;
    return row;
  }
  function addTyping(){
    const row = document.createElement("div");
    row.className = "drixel-msg bot";
    row.setAttribute("data-typing","1");

    const av = document.createElement("img");
    av.className = "drixel-avatar";
    av.alt = "Drixel";
    av.src = "https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png";
    row.appendChild(av);

    const bubble = document.createElement("div");
    bubble.className = "drixel-bubble";
    bubble.innerHTML =
      '<span class="drixel-typing" aria-label="Typing">' +
        '<span class="drixel-typing-dot"></span>' +
        '<span class="drixel-typing-dot"></span>' +
        '<span class="drixel-typing-dot"></span>' +
      '</span>';
    row.appendChild(bubble);

    body.appendChild(row);
    body.scrollTop = body.scrollHeight;
    return row;
  }
  function replaceRow(row, text){
    try{ row && row.remove(); }catch(e){}
    add("bot", text);
  }

  function findAnswer(q){
    const s = (q||"").toLowerCase();
    if(s.includes("track")) return "Order tracking depends on the courier option used. Please contact support with your order number so we can assist with tracking updates.";

    let best = null, bestScore = 0;
    for(const item of KB){
      let sc = 0;
      for(const kw of item.kws){
        if(s.includes(kw)) sc += 5;
      }
      if(sc > bestScore){ bestScore = sc; best = item; }
    }
    if(best && bestScore >= 4) return best.text + "\n\n(From: " + best.title + ")";
    return null;
  }

  function runSend(){
    const q = (input.value || "").trim();
    if(!q) return;
    add("user", q);
    input.value = "";

    const typingRow = addTyping();
    const ans = findAnswer(q) || "Iâ€™m not sure from our current FAQs/policies. Please use the Contact page and share your order number (if you have one), and weâ€™ll help you fast.";
    const delay = 550 + Math.floor(Math.random()*750);
    setTimeout(()=> replaceRow(typingRow, ans), delay);
  }

  // Capture handlers: take control
  send.addEventListener("click", function(e){
    try{ e.preventDefault(); }catch(_) {}
    runSend();
  }, true);

  input.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      e.preventDefault();
      runSend();
    }
  }, true);

  if(quick){
    quick.addEventListener("click", function(e){
      const btn = e.target && e.target.closest ? e.target.closest(".drixel-chip[data-q]") : null;
      if(!btn) return;
      e.preventDefault();
      const q = (btn.getAttribute("data-q") || btn.textContent || "").trim();
      if(!q) return;
      input.value = q;
      runSend();
    }, true);
  }
})();
</script>


<script>
/* ===== DRIXEL ORDER VIEW BOOTSTRAP ===== */
(function(){
  function kick(){
    try{
      if(typeof handleOrderHash === "function") handleOrderHash();
    }catch(e){}
  }
  window.addEventListener("hashchange", kick);
  window.addEventListener("load", ()=> setTimeout(kick, 120));
})();
</script>


<script>
/* ===== DRIXEL: VIEW MY ORDER (SAFE) =====
   Opens a beautiful order-details modal when URL contains ?order=<FirestoreDocId>
   Does NOT touch your existing navigation/admin logic.
*/
(function(){
  // Styling (injected once)
  if(!document.getElementById("drixelOrderViewStyles")){
    const st = document.createElement("style");
    st.id = "drixelOrderViewStyles";
    st.textContent = `
#orderDetailsOverlay{position:fixed;inset:0;background:rgba(0,0,0,.60);z-index:99999;display:flex;align-items:center;justify-content:center;padding:18px}
.drixel-order-card{width:min(960px,96vw);max-height:90vh;overflow:auto;background:#121212;box-shadow:0 18px 60px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:18px;color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif}
.drixel-order-top{display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;background:rgba(11,11,11,.92);backdrop-filter:blur(10px);padding:10px 6px;margin:-10px -6px 10px;border-bottom:1px solid rgba(255,255,255,.10)}
.drixel-order-brand{display:flex;align-items:center;gap:10px}
.drixel-order-logo{width:34px;height:34px;border-radius:12px;background:#fff;object-fit:contain;border:1px solid rgba(255,255,255,.14)}
.drixel-order-title{display:flex;flex-direction:column;line-height:1.15}
.drixel-order-title strong{font-size:12px;letter-spacing:.7px;text-transform:uppercase}
.drixel-order-title span{font-size:12px;opacity:.80}
.drixel-order-close{background:transparent;border:1px solid rgba(255,255,255,.20);color:#fff;padding:8px 12px;border-radius:12px;cursor:pointer}
.drixel-order-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
@media(max-width:860px){.drixel-order-grid{grid-template-columns:1fr}}
.drixel-order-box{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;background:rgba(255,255,255,.04)}
.drixel-order-box h3{margin:0 0 8px;font-size:12px;letter-spacing:.7px;text-transform:uppercase;opacity:.9}
.drixel-order-row{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.14);font-size:15px}
.drixel-order-row:last-child{border-bottom:none}
.drixel-badge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);font-size:12px;letter-spacing:.4px;text-transform:uppercase;font-weight:800}
.drixel-items{width:100%;border-collapse:collapse;font-size:15px}
.drixel-items th{text-align:left;font-size:11px;letter-spacing:.7px;text-transform:uppercase;opacity:.85;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)}
.drixel-items td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
.drixel-items tr:last-child td{border-bottom:none}
.drixel-muted{opacity:.92}
.drixel-link{color:#fff;text-decoration:underline;text-underline-offset:4px}
`;
    document.head.appendChild(st);
  }

  function closeOverlay(){
    const ex = document.getElementById("orderDetailsOverlay");
    if(ex) ex.remove();
  }

  function overlayShell(title, subtitle, innerHtml){
    closeOverlay();
    const overlay = document.createElement("div");
    overlay.id = "orderDetailsOverlay";
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeOverlay(); });

    const card = document.createElement("div");
    card.className = "drixel-order-card";
    card.innerHTML = `
      <div class="drixel-order-top">
        <div class="drixel-order-brand">
          <img class="drixel-order-logo" src="https://ik.imagekit.io/dpzepxtqs/drixel-favicon.png" alt="Drixel">
          <div class="drixel-order-title">
            <strong>${title}</strong>
            <span>${subtitle}</span>
          </div>
        </div>
        <button class="drixel-order-close" type="button">Close</button>
      </div>
      ${innerHtml}
    `;
    card.querySelector(".drixel-order-close").addEventListener("click", closeOverlay);
    overlay.appendChild(card);
    document.body.appendChild(overlay);
  }

  function showLoading(){
    overlayShell("DRIXEL SA", "Loading your orderâ€¦",
      `<div class="drixel-order-box" style="text-align:center;">
         <div class="drixel-badge">PLEASE WAIT</div>
         <div style="margin-top:10px;" class="drixel-muted">Fetching your order details securelyâ€¦</div>
       </div>`
    );
  }

  function showError(message){
    overlayShell("DRIXEL SA", "Order view",
      `<div class="drixel-order-box">
         <div class="drixel-badge">Could not load</div>
         <div style="margin-top:10px;">${message || "Something went wrong."}</div>
         <div class="drixel-muted" style="margin-top:10px;">Tip: If you need help, use the Contact page with your order number.</div>
       </div>`
    );
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function showOrder(order){
    const orderCode = order.order_id || order.orderNumber || order.id;
    const customerName = (order.customer && order.customer.name) || order.to_name || order.customer_name || "Customer";
    const customerEmail = (order.customer && order.customer.email) || order.customer_email || order.email || "â€”";
    const status = String(order.status || order.orderStatus || "processing");
    const paymentStatus = String(order.paymentStatus || order.payment_status || "pending");
    const method = String(order.paymentMethod || order.payment_method || "â€”");
    const created = order.createdAt ? new Date(order.createdAt).toLocaleString() : "â€”";
    const address = (order.customer && order.customer.address) || order.address || "â€”";
    const city = (order.customer && order.customer.city) || order.city || "";
    const province = (order.customer && order.customer.province) || order.province || "";
    const postal = (order.customer && order.customer.postalCode) || order.postalCode || "";

    const subtotal = (order.subtotal != null) ? `R${Number(order.subtotal).toFixed(2)}` : "â€”";
    const shipping = (order.shipping != null) ? `R${Number(order.shipping).toFixed(2)}` : "â€”";
    const total = (order.total != null) ? `R${Number(order.total).toFixed(2)}` : "â€”";

    const tracking = order.trackingNumber ? `${order.courierService || ""} ${order.trackingNumber}`.trim() : "â€”";
    const trackingUrl = order.trackingUrl || "";

    const items = Array.isArray(order.items) ? order.items : [];
    const itemsRows = items.map(it => {
      const name = esc(it.name || it.productName || "Item");
      const size = it.size ? `Size: ${esc(it.size)}` : "";
      const color = it.color ? `${esc(it.color)}` : "";
      const meta = [size, color].filter(Boolean).join(" â€¢ ");
      const qty = Number(it.quantity || 1);
      const price = Number(it.price || 0);
      const line = (price * qty).toFixed(2);
      return `
        <tr>
          <td>${name}${meta ? `<div class="drixel-muted" style="font-size:12px; margin-top:3px;">${meta}</div>` : ""}</td>
          <td style="text-align:center;">${qty}</td>
          <td style="text-align:right;">R${line}</td>
        </tr>`;
    }).join("");

    overlayShell("DRIXEL ORDER", `Order <b>#${esc(orderCode)}</b>`,
      `<div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px;">
         <span class="drixel-badge">Status: ${esc(status)}</span>
         <span class="drixel-badge">Payment: ${esc(paymentStatus)}</span>
         <span class="drixel-badge">Method: ${esc(method)}</span>
       </div>

       <div class="drixel-order-grid">
         <div class="drixel-order-box">
           <h3>Items</h3>
           <table class="drixel-items">
             <thead>
               <tr><th>Product</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th></tr>
             </thead>
             <tbody>
               ${itemsRows || '<tr><td colspan="3" class="drixel-muted">No items found.</td></tr>'}
             </tbody>
           </table>
         </div>

         <div style="display:grid; gap:12px;">
           <div class="drixel-order-box">
             <h3>Customer</h3>
             <div><b>${esc(customerName)}</b></div>
             <div class="drixel-muted">${esc(customerEmail)}</div>
             <div class="drixel-muted" style="margin-top:8px;">Placed: ${esc(created)}</div>
           </div>

           <div class="drixel-order-box">
             <h3>Delivery Address</h3>
             <div>${esc(address)}</div>
             <div class="drixel-muted">${esc([city, province, postal].filter(Boolean).join(", "))}</div>
             <div class="drixel-muted" style="margin-top:8px;">Courier: ${esc(order.deliveryMethod || "â€”")}</div>
           </div>

           <div class="drixel-order-box">
             <h3>Summary</h3>
             <div class="drixel-order-row"><span class="drixel-muted">Subtotal</span><span>${subtotal}</span></div>
             <div class="drixel-order-row"><span class="drixel-muted">Shipping</span><span>${shipping}</span></div>
             <div class="drixel-order-row"><span class="drixel-muted">Total</span><span><b>${total}</b></span></div>
           </div>

           <div class="drixel-order-box">
             <h3>Tracking</h3>
             <div>${esc(tracking)}</div>
             ${trackingUrl ? `<div style="margin-top:8px;"><a class="drixel-link" href="${trackingUrl}" target="_blank" rel="noopener">Open tracking</a></div>`
                          : `<div class="drixel-muted" style="margin-top:8px;">Tracking link will appear when your order is shipped.</div>`}
           </div>
         </div>
       </div>`
    );
  }

  function getOrderDocIdFromUrl(){
    try{
      const url = new URL(window.location.href);
      const q = (url.searchParams.get("order") || "").trim();
      if(q) return q;
    }catch(e){}
    const hash = window.location.hash || "";
    if(hash.startsWith("#order=")) return decodeURIComponent(hash.slice("#order=".length).trim());
    return "";
  }

  async function loadOrderFromUrl(){
    const docId = getOrderDocIdFromUrl();
    if(!docId) return;

    showLoading();

    // Retry until firebase is ready
    window.__drixelOrderViewTries = (window.__drixelOrderViewTries || 0) + 1;
    if(!window.firebaseDb || !window.firebaseGetDoc || !window.firebaseDoc){
      if(window.__drixelOrderViewTries <= 40){
        setTimeout(loadOrderFromUrl, 450);
        return;
      }
      showError("We couldn't load your order yet. Please refresh and try again.");
      return;
    }

    try{
      const db = window.firebaseDb;
      const snap = await window.firebaseGetDoc(window.firebaseDoc(db, "orders", docId));
      if(!snap.exists()){
        showError("Order not found. Please check your link or contact support.");
        return;
      }
      showOrder({ id: snap.id, ...snap.data() });
    }catch(e){
      console.error("Order view error:", e);
      showError("Something went wrong while loading your order. Please try again.");
    }
  }

  // Run on load + hash change + query change (some in-app browsers preserve query but drop hash)
  window.addEventListener("hashchange", ()=> setTimeout(loadOrderFromUrl, 50));
  window.addEventListener("popstate", ()=> setTimeout(loadOrderFromUrl, 50));
  window.addEventListener("load", ()=> setTimeout(loadOrderFromUrl, 150));
  document.addEventListener("DOMContentLoaded", ()=> setTimeout(loadOrderFromUrl, 150));
})();
</script>


<style id="drixelOrderViewContrastFix">
/* Stronger contrast for order modal on mobile/pc */
#orderDetailsOverlay .drixel-order-card{background:#0a0a0a !important; color:#ffffff !important; opacity:1 !important; filter:none !important;}
#orderDetailsOverlay .drixel-order-box{background:rgba(255,255,255,0.06) !important;}
#orderDetailsOverlay, #orderDetailsOverlay *{text-shadow:none !important; }
#orderDetailsOverlay .drixel-order-title strong{font-size:13px !important;}
#orderDetailsOverlay .drixel-order-title span{font-size:13px !important; opacity:0.95 !important;}
#orderDetailsOverlay .drixel-order-box, #orderDetailsOverlay td, #orderDetailsOverlay th, #orderDetailsOverlay div{color:#ffffff !important;}
#orderDetailsOverlay .drixel-muted{opacity:0.92 !important;}
#orderDetailsOverlay .drixel-items th{opacity:0.95 !important;}


        /* ===== PRODUCT PAGE RESPONSIVE FIX (no horizontal scroll) ===== */
        html, body{
            max-width: 100%;
            overflow-x: hidden;
        }
        @media (max-width: 600px){
            .product-actions{
                flex-direction: column;
                align-items: stretch;
                gap: 14px;
            }
            .product-actions .btn{
                width: 100%;
            }
            .quantity-selector{
                width: 100%;
                justify-content: space-between;
            }
            .thumbnails{
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 6px;
                flex-wrap: nowrap;
            }
            .thumbnail{
                flex: 0 0 auto;
            }
            .main-image{
                height: auto;
                max-height: 520px;
            }
        }

</style>


<script>
/* ===== DRIXEL: Google Redirect Result Handler (Mobile Safe) ===== */
(function(){
  async function handleGoogleRedirectResult(){
    try{
      if(!window.firebaseAuth || !window.firebaseGetRedirectResult) return;
      const auth = window.firebaseAuth;
      const res = await window.firebaseGetRedirectResult(auth);
      if(!res || !res.user) return;

      const loginError = document.getElementById('loginError');
      const loginSuccess = document.getElementById('loginSuccess');
      if (loginError) loginError.style.display = 'none';

      // Auto-enroll SMS MFA (only if not enrolled yet)
      try{ await _ensureSmsMfaEnrolled(res.user); }catch(e){}

      if (loginSuccess) {
        loginSuccess.textContent = 'Login successful! Redirecting...';
        loginSuccess.style.display = 'block';
      }
      setTimeout(() => {
        try { showPage('shop'); } catch(e) {}
        try { closeModal('authModal'); } catch(e) {}
      }, 700);
    }catch(e){
      // ignore
    }
  }
  window.addEventListener("load", ()=> setTimeout(handleGoogleRedirectResult, 350));
})();
</script>


<script>
/* ===== Fallback: ensure showPage exists for inline onclick handlers =====
   This does NOT change any data logic; it only prevents "showPage is undefined"
   and restores basic page navigation on all devices. */
(function(){
  if (typeof window.showPage === 'function') return;

  window.showPage = function(page){
    try{
      // Hide all pages
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));

      // Show selected page (by id)
      const el = document.getElementById(page);
      if (el) el.classList.remove('hidden');

      // Update active nav links (if present)
      document.querySelectorAll('.nav-links a').forEach(a=>{
        try{
          const onclick = a.getAttribute('onclick') || '';
          if (onclick.includes("showPage('"+page+"'") || onclick.includes('showPage("'+page+'"')) {
            a.classList.add('active');
          } else {
            a.classList.remove('active');
          }
        }catch(e){}
      });

      // Close mobile menu if open
      const navLinksContainer = document.querySelector('.nav-links');
      if (navLinksContainer) navLinksContainer.classList.remove('active');

      window.scrollTo(0,0);
    }catch(e){
      console.error('Fallback showPage failed:', e);
    }
  };

  // Ensure something visible on first load
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      // prefer home then shop
      if (document.getElementById('home')) window.showPage('home');
      else if (document.getElementById('shop')) window.showPage('shop');
    }catch(e){}
  });
})();

        // Warm the payment server early so Yoco starts faster (Render can sleep)
        document.addEventListener('DOMContentLoaded', () => {
            warmPaymentServer();

            // Warm again when user shows payment area / hovers pay buttons
            ['payWithYocoBtn','yocoPayBtn','quickBuyBtn'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('mouseenter', warmPaymentServer);
                    el.addEventListener('touchstart', warmPaymentServer, { passive: true });
                    el.addEventListener('click', () => {
                        // Give instant feedback on click; actual redirect happens in showYocoPaymentModal
                        if (id === 'payWithYocoBtn' || id === 'yocoPayBtn') showPayOverlay('Starting Yocoâ€¦');
                    });
                }
            });
        });

</script>


<!-- Instant payment overlay -->
<div id="payOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:99999;">
  <div style="background:#111; color:#fff; padding:18px 20px; border-radius:14px; font-family:system-ui,-apple-system,Segoe UI,Roboto; width:min(360px,92vw); box-shadow:0 10px 40px rgba(0,0,0,.45); text-align:center;">
    <div id="payOverlayTitle" style="font-size:16px; font-weight:700; margin-bottom:8px;">Starting paymentâ€¦</div>
    <div style="opacity:.85; font-size:13px;">Please donâ€™t close this page.</div>
    <div style="margin-top:14px; font-size:12px; opacity:.7;">If it takes long, your payment server may be waking up.</div>
  </div>
</div>

</body>
</html>
